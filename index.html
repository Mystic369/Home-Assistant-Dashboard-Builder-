<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HA Dashboard Designer Pro v2.0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',sans-serif;color:#fff;overflow:hidden;height:100vh;position:relative}.bg-layer{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;background:linear-gradient(135deg,#0f0f1e 0%,#1a1a2e 100%)}.bg-image{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;opacity:.3}.bg-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5)}.app-container{display:grid;grid-template-columns:340px 1fr 340px;grid-template-rows:70px 1fr;height:100vh;position:relative}.header{grid-column:1/-1;background:rgba(20,20,40,.95);backdrop-filter:blur(10px);border-bottom:2px solid rgba(67,238,255,.4);padding:0 30px;display:flex;align-items:center;justify-content:space-between;z-index:100}.logo{font-size:1.6em;font-weight:700;background:linear-gradient(135deg,#43eeff,#ff43ee);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.version{font-size:.7em;color:#666;margin-left:10px}.header-actions{display:flex;gap:12px}.header-btn{padding:10px 18px;background:rgba(67,238,255,.15);border:1px solid #43eeff;border-radius:8px;color:#43eeff;cursor:pointer;font-weight:600;transition:all .3s;font-size:.9em}.header-btn:hover{background:rgba(67,238,255,.3);transform:translateY(-2px)}.sidebar{background:rgba(20,20,40,.85);backdrop-filter:blur(10px);border-right:1px solid rgba(67,238,255,.2);padding:25px;overflow-y:auto}.sidebar h2{color:#ff43ee;margin-bottom:20px;font-size:1.3em}.canvas-container{background:transparent;position:relative;overflow:auto}.canvas{min-height:100%;min-width:100%;background-image:repeating-linear-gradient(0deg,rgba(67,238,255,.05) 0px,transparent 1px,transparent 50px,rgba(67,238,255,.05) 51px),repeating-linear-gradient(90deg,rgba(67,238,255,.05) 0px,transparent 1px,transparent 50px,rgba(67,238,255,.05) 51px);background-size:50px 50px;position:relative;padding:40px}.canvas-card{position:absolute;background:#43eeff;border-radius:14px;padding:18px;cursor:move;box-shadow:0 4px 20px rgba(67,238,255,.5);min-width:150px;min-height:100px;animation:cardFadeIn .4s}@keyframes cardFadeIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}.canvas-card:hover{box-shadow:0 8px 35px rgba(67,238,255,.7)}.canvas-card.selected{border:3px solid #ff43ee}.canvas-card.drag-over{border:3px dashed #ffeb3b;background:rgba(255,235,59,.1)}.card-type-badge{position:absolute;top:8px;left:8px;background:rgba(0,0,0,.7);padding:4px 10px;border-radius:6px;font-size:.7em;color:#fff;font-weight:700;text-transform:uppercase}.card-size-badge{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.7);padding:4px 10px;border-radius:6px;font-size:.7em;color:#fff}.card-title-display{color:#ff43ee;font-size:1.2em;font-weight:600;margin-bottom:12px;margin-top:20px}.card-entity-display{font-size:.85em;margin:6px 0;padding:6px 10px;background:rgba(255,255,255,.25);border-radius:6px;color:#ffeb3b;cursor:grab;position:relative;transition:all .2s}.card-entity-display:hover{background:rgba(255,255,255,.35);transform:translateX(5px)}.card-entity-display.dragging-entity{opacity:.5;cursor:grabbing}.card-entity-display.drag-over-entity{border-top:3px solid #ff43ee}.entity-drag-ghost{position:fixed;background:rgba(67,238,255,.9);padding:8px 12px;border-radius:6px;color:#000;font-weight:600;pointer-events:none;z-index:10000;box-shadow:0 4px 20px rgba(0,0,0,.5)}.resize-handle{position:absolute;width:14px;height:14px;background:#ff43ee;border:2px solid #fff;border-radius:50%;display:none;z-index:10}.canvas-card.selected .resize-handle{display:block}.resize-se{bottom:-7px;right:-7px;cursor:se-resize}.resize-sw{bottom:-7px;left:-7px;cursor:sw-resize}.resize-ne{top:-7px;right:-7px;cursor:ne-resize}.resize-nw{top:-7px;left:-7px;cursor:nw-resize}.form-group{margin-bottom:18px}label{display:block;color:#a5b4fc;margin-bottom:6px;font-size:.9em;font-weight:500}input,select,textarea{width:100%;padding:11px;border-radius:8px;border:1px solid rgba(67,238,255,.3);background:rgba(10,10,20,.9);color:#fff;font-size:.9em}select{cursor:pointer}textarea{resize:vertical;font-family:inherit}input[type=color]{height:50px;cursor:pointer}input[type=checkbox],input[type=radio]{width:auto;margin-right:10px}input[type=file]{padding:15px;border:2px dashed rgba(67,238,255,.5);background:rgba(67,238,255,.05);cursor:pointer}input[type=file]:hover{border-color:#43eeff;background:rgba(67,238,255,.1)}.btn{width:100%;padding:13px;background:linear-gradient(135deg,#43eeff,#2fdaeb);border:none;border-radius:8px;color:#0a0a15;font-weight:600;cursor:pointer;transition:all .3s;margin:6px 0;font-size:.95em}.btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(67,238,255,.6)}.btn-secondary{background:linear-gradient(135deg,#ff43ee,#eb2fda)}.btn-danger{background:linear-gradient(135deg,#f44,#c00);color:#fff}.checkbox-label{display:flex;align-items:center;padding:12px;background:rgba(67,238,255,.1);border-radius:8px;cursor:pointer;transition:background .2s}.checkbox-label:hover{background:rgba(67,238,255,.2)}.properties-panel{background:rgba(20,20,40,.85);backdrop-filter:blur(10px);border-left:1px solid rgba(67,238,255,.2);padding:25px;overflow-y:auto}.no-selection{text-align:center;color:#666;padding:60px 20px}.no-selection-icon{font-size:4em;margin-bottom:15px}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:1000;align-items:center;justify-content:center}.modal.active{display:flex}.modal-content{background:rgba(20,20,40,.98);border:2px solid #43eeff;border-radius:16px;padding:35px;max-width:700px;width:90%;max-height:85vh;overflow-y:auto}.modal h2{color:#ff43ee;margin-bottom:25px;font-size:1.8em}.yaml-output{background:#0a0a15;border:1px solid rgba(67,238,255,.4);border-radius:10px;padding:20px;font-family:'Courier New',monospace;color:#43eeff;white-space:pre-wrap;max-height:450px;overflow-y:auto;font-size:.85em;line-height:1.5}.card-type-selector{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:25px}.card-type-btn{padding:18px;background:rgba(67,238,255,.08);border:2px solid rgba(67,238,255,.3);border-radius:10px;color:#43eeff;cursor:pointer;text-align:center;transition:all .25s;font-weight:500}.card-type-btn:hover{background:rgba(67,238,255,.18);border-color:#43eeff;transform:scale(1.03)}.card-type-btn.active{background:rgba(67,238,255,.25);border-color:#ff43ee;color:#ff43ee}.card-type-icon{font-size:1.8em;display:block;margin-bottom:6px}.divider{height:1px;background:rgba(67,238,255,.2);margin:20px 0}.prop-section{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid rgba(67,238,255,.15)}.prop-section h3{color:#ff43ee;margin-bottom:15px;font-size:1.1em}.bg-preview{width:100%;height:150px;border-radius:8px;border:2px solid rgba(67,238,255,.3);overflow:hidden;position:relative;margin-top:10px}.context-menu{position:fixed;background:rgba(20,20,40,.98);border:2px solid #43eeff;border-radius:8px;padding:8px;min-width:150px;z-index:10000;box-shadow:0 4px 20px rgba(0,0,0,.5);display:none}.context-menu.active{display:block}.context-menu-item{padding:10px 15px;color:#43eeff;cursor:pointer;border-radius:4px;transition:all .2s}.context-menu-item:hover{background:rgba(67,238,255,.2)}
</style>
</head>
<body>
<div class="bg-layer">
<div class="bg-image" id="bgImage"></div>
<div class="bg-overlay" id="bgOverlay"></div>
</div>
<div class="app-container">
<div class="header">
<div><span class="logo">üé® HA Dashboard Designer Pro</span><span class="version">v2.0</span></div>
<div class="header-actions">
<button class="header-btn" onclick="showBackgroundModal()">üñºÔ∏è BG</button>
<button class="header-btn" onclick="toggleGridSnap()" id="gridSnapBtn">üß≤ ON</button>
<button class="header-btn" onclick="undo()">‚Ü∂</button>
<button class="header-btn" onclick="redo()">‚Ü∑</button>
<button class="header-btn" onclick="saveProject()">üíæ</button>
<button class="header-btn" onclick="showYAML()">üìÑ</button>
<button class="header-btn" onclick="clearAll()">üóëÔ∏è</button>
</div>
</div>
<div class="sidebar">
<h2>‚ûï Add Card</h2>
<div class="card-type-selector">
<div class="card-type-btn active" onclick="selectCardType('entities')"><span class="card-type-icon">üìã</span>Entities</div>
<div class="card-type-btn" onclick="selectCardType('thermostat')"><span class="card-type-icon">üå°Ô∏è</span>Thermo</div>
<div class="card-type-btn" onclick="selectCardType('weather')"><span class="card-type-icon">üå§Ô∏è</span>Weather</div>
<div class="card-type-btn" onclick="selectCardType('camera')"><span class="card-type-icon">üì∑</span>Camera</div>
<div class="card-type-btn" onclick="selectCardType('media')"><span class="card-type-icon">üéµ</span>Media</div>
<div class="card-type-btn" onclick="selectCardType('gauge')"><span class="card-type-icon">‚è±Ô∏è</span>Gauge</div>
<div class="card-type-btn" onclick="selectCardType('button')"><span class="card-type-icon">üîò</span>Button</div>
<div class="card-type-btn" onclick="selectCardType('clock')"><span class="card-type-icon">üïê</span>Clock</div>
</div>
<div class="divider"></div>
<div id="cardConfig"></div>
<button class="btn" onclick="addCardToCanvas()">‚ûï Add to Canvas</button>
</div>
<div class="canvas-container"><div class="canvas" id="canvas"></div></div>
<div class="properties-panel" id="propertiesPanel">
<div class="no-selection"><div class="no-selection-icon">üëÜ</div><p>Click a card to edit</p></div>
</div>
</div>
<div class="modal" id="yamlModal"><div class="modal-content"><h2>üìÑ Export YAML</h2><div class="yaml-output" id="yamlOutput"></div><button class="btn" onclick="copyYAML()">üìã Copy</button><button class="btn btn-secondary" onclick="closeModal('yamlModal')">Close</button></div></div>
<div class="modal" id="backgroundModal"><div class="modal-content"><h2>üñºÔ∏è Background</h2>
<div class="prop-section"><h3>Type</h3>
<label class="checkbox-label"><input type="radio" name="bgType" value="gradient" checked onchange="updateBgType()">Gradient</label>
<label class="checkbox-label"><input type="radio" name="bgType" value="image" onchange="updateBgType()">Image</label>
<label class="checkbox-label"><input type="radio" name="bgType" value="solid" onchange="updateBgType()">Solid</label>
</div>
<div id="gradientControls" class="prop-section">
<h3>Gradient</h3>
<div class="form-group"><label>Color 1</label><input type="color" id="bgGrad1" value="#0f0f1e" oninput="updateBgPreview()"></div>
<div class="form-group"><label>Color 2</label><input type="color" id="bgGrad2" value="#1a1a2e" oninput="updateBgPreview()"></div>
<div class="form-group"><label>Angle: <span id="angleVal">135¬∞</span></label><input type="range" id="bgAngle" min="0" max="360" value="135" oninput="updateBgPreview()"></div>
</div>
<div id="imageControls" class="prop-section" style="display:none">
<h3>Image</h3>
<div class="form-group"><label>Upload</label><input type="file" id="bgImageUpload" accept="image/*" onchange="handleBgImage()"></div>
<div class="form-group"><label>URL</label><input type="text" id="bgImageUrl" placeholder="https://..." oninput="updateBgPreview()"></div>
</div>
<div id="solidControls" class="prop-section" style="display:none">
<h3>Solid</h3>
<div class="form-group"><label>Color</label><input type="color" id="bgSolid" value="#1a1a2e" oninput="updateBgPreview()"></div>
</div>
<div class="prop-section"><h3>Effects</h3>
<div class="form-group"><label>Opacity: <span id="opacityVal">30%</span></label><input type="range" id="bgOpacity" min="0" max="100" value="30" oninput="updateBgPreview()"></div>
<div class="form-group"><label>Blur: <span id="blurVal">0px</span></label><input type="range" id="bgBlur" min="0" max="20" value="0" oninput="updateBgPreview()"></div>
<div class="form-group"><label>Overlay: <span id="overlayVal">50%</span></label><input type="range" id="bgOverlayDark" min="0" max="100" value="50" oninput="updateBgPreview()"></div>
</div>
<div class="bg-preview" id="bgPreview"></div>
<button class="btn" onclick="applyBackground()">‚úÖ Apply</button>
<button class="btn btn-secondary" onclick="closeModal('backgroundModal')">Close</button>
</div></div>
<div class="context-menu" id="contextMenu">
<div class="context-menu-item" onclick="deleteEntity()">üóëÔ∏è Delete</div>
</div>
<script>
let cards=[],selectedCard=null,selectedCardType='entities',draggedCard=null,resizingCard=null,resizeHandle=null,dragOffset={x:0,y:0},cardIdCounter=0,history=[],historyIndex=-1,maxHistory=50,gridSize=50,snapToGrid=true;
let draggedEntity=null,draggedFromCard=null,draggedEntityIndex=-1,contextEntity=null,contextCard=null,contextEntityIndex=-1;
let bgSettings={type:'gradient',grad1:'#0f0f1e',grad2:'#1a1a2e',angle:135,imageUrl:'',solid:'#1a1a2e',opacity:30,blur:0,overlay:50};
const canvas=document.getElementById('canvas'),propertiesPanel=document.getElementById('propertiesPanel'),cardConfig=document.getElementById('cardConfig');
function snapToGridValue(v){return snapToGrid?Math.round(v/gridSize)*gridSize:v}
function saveState(){history=history.slice(0,historyIndex+1);history.push(JSON.stringify({cards,bg:bgSettings}));historyIndex++;if(history.length>maxHistory){history.shift();historyIndex--}}
function undo(){if(historyIndex>0){historyIndex--;const state=JSON.parse(history[historyIndex]);cards=state.cards||[];bgSettings=state.bg||bgSettings;renderCanvas();applyBackground();if(selectedCard){selectedCard=cards.find(c=>c.id===selectedCard.id);if(selectedCard)showProperties(selectedCard)}}}
function redo(){if(historyIndex<history.length-1){historyIndex++;const state=JSON.parse(history[historyIndex]);cards=state.cards||[];bgSettings=state.bg||bgSettings;renderCanvas();applyBackground();if(selectedCard){selectedCard=cards.find(c=>c.id===selectedCard.id);if(selectedCard)showProperties(selectedCard)}}}
document.addEventListener('keydown',e=>{if(e.ctrlKey||e.metaKey){if(e.key==='z'&&!e.shiftKey){e.preventDefault();undo()}else if(e.key==='y'||(e.key==='z'&&e.shiftKey)){e.preventDefault();redo()}else if(e.key==='d'){e.preventDefault();duplicateCard()}}else if(e.key==='Delete'&&selectedCard){deleteCard()}});
document.addEventListener('click',()=>document.getElementById('contextMenu').classList.remove('active'));
const cardTypeConfigs={entities:{defaultSize:{width:300,height:200},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="My Entities"></div><div class="form-group"><label>Entities (one per line)</label><textarea id="newCardEntities" rows="6" placeholder="light.living_room
switch.fan
sensor.temp"></textarea></div>`},thermostat:{defaultSize:{width:300,height:280},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Thermostat"></div><div class="form-group"><label>Entity</label><input type="text" id="thermostatEntity" value="climate.thermostat"></div>`},weather:{defaultSize:{width:350,height:250},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Weather"></div><div class="form-group"><label>Entity</label><input type="text" id="weatherEntity" value="weather.forecast"></div>`},camera:{defaultSize:{width:400,height:300},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Camera"></div><div class="form-group"><label>Entity</label><input type="text" id="cameraEntity" value="camera.entrance"></div>`},media:{defaultSize:{width:350,height:200},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Media"></div><div class="form-group"><label>Entity</label><input type="text" id="mediaEntity" value="media_player.speaker"></div>`},gauge:{defaultSize:{width:250,height:250},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Gauge"></div><div class="form-group"><label>Entity</label><input type="text" id="gaugeEntity" value="sensor.battery"></div><div class="form-group"><label>Min</label><input type="number" id="gaugeMin" value="0"></div><div class="form-group"><label>Max</label><input type="number" id="gaugeMax" value="100"></div>`},button:{defaultSize:{width:200,height:150},fields:`<div class="form-group"><label>Name</label><input type="text" id="newCardTitle" value="Toggle"></div><div class="form-group"><label>Entity</label><input type="text" id="buttonEntity" value="switch.device"></div>`},clock:{defaultSize:{width:300,height:250},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Clock"></div><div class="form-group"><label>Format</label><select id="clockFormat"><option value="12">12-Hour</option><option value="24">24-Hour</option></select></div>`}};
function selectCardType(t){selectedCardType=t;document.querySelectorAll('.card-type-btn').forEach(b=>b.classList.remove('active'));event.target.closest('.card-type-btn').classList.add('active');cardConfig.innerHTML=cardTypeConfigs[t].fields}
cardConfig.innerHTML=cardTypeConfigs.entities.fields;saveState();
function addCardToCanvas(){const size=cardTypeConfigs[selectedCardType].defaultSize,title=document.getElementById('newCardTitle')?.value||'Card',cardData={id:cardIdCounter++,type:selectedCardType,title,x:50+(cards.length*30),y:50+(cards.length*30),width:size.width,height:size.height,bgColor:'#43eeff',titleColor:'#ff43ee',entityColor:'#ffeb3b',useGradient:false,gradientColor1:'#43eeff',gradientColor2:'#ff43ee'};
if(selectedCardType==='entities'){const t=document.getElementById('newCardEntities').value;cardData.entities=t.split('\n').filter(e=>e.trim());if(!cardData.entities.length){alert('Add entities');return}}else if(['thermostat','weather','camera','media','gauge'].includes(selectedCardType)){const id=selectedCardType+'Entity';cardData.entity=document.getElementById(id).value}else if(selectedCardType==='button'){cardData.entity=document.getElementById('buttonEntity').value}else if(selectedCardType==='clock'){cardData.format=document.getElementById('clockFormat').value}
if(selectedCardType==='gauge'){cardData.min=document.getElementById('gaugeMin').value;cardData.max=document.getElementById('gaugeMax').value}
cards.push(cardData);saveState();renderCanvas();selectCard(cardData)}
function renderCanvas(){canvas.innerHTML='';cards.forEach(c=>canvas.appendChild(createCardElement(c)))}
function createCardElement(c){const el=document.createElement('div');el.className='canvas-card';el.id=`card-${c.id}`;el.style.left=c.x+'px';el.style.top=c.y+'px';el.style.width=c.width+'px';el.style.height=c.height+'px';el.style.background=c.useGradient?`linear-gradient(135deg,${c.gradientColor1},${c.gradientColor2})`:c.bgColor;if(selectedCard&&selectedCard.id===c.id)el.classList.add('selected');
const tb=document.createElement('div');tb.className='card-type-badge';tb.textContent=c.type;el.appendChild(tb);
const sb=document.createElement('div');sb.className='card-size-badge';sb.textContent=`${c.width}√ó${c.height}`;el.appendChild(sb);
if(c.type==='entities'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;el.appendChild(t);c.entities.forEach((e,idx)=>{const d=document.createElement('div');d.className='card-entity-display';d.textContent=e;d.style.color=c.entityColor;d.draggable=true;d.dataset.entityIndex=idx;d.dataset.cardId=c.id;d.ondragstart=ev=>startEntityDrag(ev,c,idx,e);d.ondragend=endEntityDrag;d.ondragover=ev=>entityDragOver(ev,idx);d.ondrop=ev=>entityDrop(ev,c,idx);d.oncontextmenu=ev=>{ev.preventDefault();ev.stopPropagation();showContextMenu(ev,c,idx,e)};el.appendChild(d)})}else if(c.type==='thermostat'){el.innerHTML+=`<div class="card-title-display" style="color:${c.titleColor};text-align:center">${c.title}</div><div style="text-align:center;padding:15px"><div style="font-size:2.5em;font-weight:bold;color:${c.entityColor};margin:15px 0">72¬∞</div><div style="padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:6px;font-size:0.85em;color:${c.entityColor};display:inline-block">HEAT</div></div>`}else if(c.type==='weather'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;t.style.textAlign='center';el.appendChild(t);el.innerHTML+=`<div style="text-align:center"><div style="font-size:3em;margin:10px 0">üå§Ô∏è</div><div style="font-size:2em;font-weight:bold;color:${c.entityColor}">75¬∞F</div></div>`}else if(c.type==='camera'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;el.appendChild(t);const p=document.createElement('div');p.style.cssText='background:#1a1a2e;flex:1;display:flex;align-items:center;justify-content:center;font-size:3em;color:rgba(255,255,255,0.3)';p.textContent='üì∑';el.appendChild(p);el.style.display='flex';el.style.flexDirection='column'}else if(c.type==='clock'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;t.style.textAlign='center';el.appendChild(t);const now=new Date(),timeFormat=c.format==='12'?now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true}):now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});el.innerHTML+=`<div style="display:flex;align-items:center;justify-content:center;flex:1;font-size:3em;font-weight:bold;color:${c.entityColor};font-family:monospace">${timeFormat}</div>`;el.style.display='flex';el.style.flexDirection='column'}
['nw','ne','sw','se'].forEach(p=>{const h=document.createElement('div');h.className=`resize-handle resize-${p}`;h.dataset.position=p;el.appendChild(h)});
el.ondragover=ev=>{if(draggedEntity&&c.type==='entities'){ev.preventDefault();el.classList.add('drag-over')}};
el.ondragleave=()=>el.classList.remove('drag-over');
el.ondrop=ev=>{if(draggedEntity&&c.type==='entities'){ev.preventDefault();el.classList.remove('drag-over');if(draggedFromCard.id!==c.id){c.entities.push(draggedEntity);draggedFromCard.entities.splice(draggedEntityIndex,1);saveState();renderCanvas()}}};
el.addEventListener('mousedown',e=>{if(e.target.classList.contains('resize-handle')){startResize(e,c)}else if(!e.target.classList.contains('card-entity-display')){startDrag(e,c)}});return el}
function startEntityDrag(ev,card,idx,entity){draggedEntity=entity;draggedFromCard=card;draggedEntityIndex=idx;ev.dataTransfer.effectAllowed='move';ev.target.classList.add('dragging-entity')}
function endEntityDrag(ev){ev.target.classList.remove('dragging-entity');setTimeout(()=>{draggedEntity=null;draggedFromCard=null;draggedEntityIndex=-1},100)}
function entityDragOver(ev,idx){if(draggedEntity){ev.preventDefault();ev.stopPropagation();ev.target.classList.add('drag-over-entity')}}
function entityDrop(ev,card,dropIdx){ev.preventDefault();ev.stopPropagation();document.querySelectorAll('.drag-over-entity').forEach(e=>e.classList.remove('drag-over-entity'));if(!draggedEntity)return;if(draggedFromCard.id===card.id){const[item]=draggedFromCard.entities.splice(draggedEntityIndex,1);card.entities.splice(dropIdx,0,item)}else{const entity=draggedEntity;draggedFromCard.entities.splice(draggedEntityIndex,1);card.entities.splice(dropIdx,0,entity)}saveState();renderCanvas()}
function showContextMenu(ev,card,idx,entity){contextCard=card;contextEntityIndex=idx;contextEntity=entity;const menu=document.getElementById('contextMenu');menu.style.left=ev.pageX+'px';menu.style.top=ev.pageY+'px';menu.classList.add('active')}
function deleteEntity(){if(contextCard&&contextEntityIndex>=0){contextCard.entities.splice(contextEntityIndex,1);saveState();renderCanvas();document.getElementById('contextMenu').classList.remove('active')}}
function startDrag(e,c){if(e.target.classList.contains('resize-handle'))return;draggedCard=c;selectCard(c);const el=document.getElementById(`card-${c.id}`);const r=el.getBoundingClientRect();dragOffset.x=e.clientX-r.left;dragOffset.y=e.clientY-r.top;document.addEventListener('mousemove',handleDrag);document.addEventListener('mouseup',stopDrag);e.preventDefault()}
function handleDrag(e){if(!draggedCard)return;const r=canvas.getBoundingClientRect(),rawX=Math.max(0,e.clientX-r.left-dragOffset.x),rawY=Math.max(0,e.clientY-r.top-dragOffset.y);draggedCard.x=snapToGridValue(rawX);draggedCard.y=snapToGridValue(rawY);renderCanvas()}
function stopDrag(){if(draggedCard)saveState();draggedCard=null;document.removeEventListener('mousemove',handleDrag);document.removeEventListener('mouseup',stopDrag)}
function startResize(e,c){resizingCard=c;resizeHandle=e.target.dataset.position;document.addEventListener('mousemove',handleResize);document.addEventListener('mouseup',stopResize);e.preventDefault();e.stopPropagation()}
function handleResize(e){if(!resizingCard)return;const r=canvas.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top;if(resizeHandle.includes('e'))resizingCard.width=snapToGridValue(Math.max(150,mx-resizingCard.x));if(resizeHandle.includes('s'))resizingCard.height=snapToGridValue(Math.max(100,my-resizingCard.y));renderCanvas()}
function stopResize(){if(resizingCard)saveState();resizingCard=null;resizeHandle=null;document.removeEventListener('mousemove',handleResize);document.removeEventListener('mouseup',stopResize)}
function selectCard(c){selectedCard=c;renderCanvas();showProperties(c)}
function showProperties(c){if(!c){propertiesPanel.innerHTML='<div class="no-selection"><div class="no-selection-icon">üëÜ</div><p>Click card</p></div>';return}
propertiesPanel.innerHTML=`<div class="prop-section"><h3>üìù Details</h3><div class="form-group"><label>Title</label><input type="text" id="prop-title" value="${c.title}"></div>${c.entities?`<div class="form-group"><label>Entities</label><textarea id="prop-entities" rows="6">${c.entities.join('\n')}</textarea></div>`:`<div class="form-group"><label>Entity</label><input type="text" id="prop-entity" value="${c.entity||''}"></div>`}</div><div class="prop-section"><h3>üìê Position</h3><div class="form-group"><label>X: ${c.x}px</label><input type="range" id="prop-x" min="0" max="1000" value="${c.x}"></div><div class="form-group"><label>Y: ${c.y}px</label><input type="range" id="prop-y" min="0" max="1000" value="${c.y}"></div><div class="form-group"><label>W: ${c.width}px</label><input type="range" id="prop-w" min="150" max="600" value="${c.width}"></div><div class="form-group"><label>H: ${c.height}px</label><input type="range" id="prop-h" min="100" max="500" value="${c.height}"></div></div><div class="prop-section"><h3>üé® Colors</h3><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="prop-gradient" ${c.useGradient?'checked':''}>Gradient</label></div><div id="solidColor" style="display:${c.useGradient?'none':'block'}"><div class="form-group"><label>BG</label><input type="color" id="prop-bg" value="${c.bgColor}"></div></div><div id="gradientColors" style="display:${c.useGradient?'block':'none'}"><div class="form-group"><label>Color 1</label><input type="color" id="prop-gc1" value="${c.gradientColor1}"></div><div class="form-group"><label>Color 2</label><input type="color" id="prop-gc2" value="${c.gradientColor2}"></div></div><div class="form-group"><label>Title</label><input type="color" id="prop-tc" value="${c.titleColor}"></div><div class="form-group"><label>Entity</label><input type="color" id="prop-ec" value="${c.entityColor}"></div></div><button class="btn" onclick="duplicateCard()">üìã Duplicate</button><button class="btn btn-danger" onclick="deleteCard()">üóëÔ∏è Delete</button>`;
document.getElementById('prop-title').oninput=e=>{c.title=e.target.value;renderCanvas()};
document.getElementById('prop-x').oninput=e=>{c.x=parseInt(e.target.value);renderCanvas();e.target.previousElementSibling.textContent=`X: ${c.x}px`};
document.getElementById('prop-y').oninput=e=>{c.y=parseInt(e.target.value);renderCanvas();e.target.previousElementSibling.textContent=`Y: ${c.y}px`};
document.getElementById('prop-w').oninput=e=>{c.width=parseInt(e.target.value);renderCanvas();e.target.previousElementSibling.textContent=`W: ${c.width}px`};
document.getElementById('prop-h').oninput=e=>{c.height=parseInt(e.target.value);renderCanvas();e.target.previousElementSibling.textContent=`H: ${c.height}px`};
document.getElementById('prop-gradient').onchange=e=>{c.useGradient=e.target.checked;document.getElementById('solidColor').style.display=c.useGradient?'none':'block';document.getElementById('gradientColors').style.display=c.useGradient?'block':'none';renderCanvas()};
document.getElementById('prop-bg').oninput=e=>{c.bgColor=e.target.value;renderCanvas()};
document.getElementById('prop-gc1').oninput=e=>{c.gradientColor1=e.target.value;renderCanvas()};
document.getElementById('prop-gc2').oninput=e=>{c.gradientColor2=e.target.value;renderCanvas()};
document.getElementById('prop-tc').oninput=e=>{c.titleColor=e.target.value;renderCanvas()};
document.getElementById('prop-ec').oninput=e=>{c.entityColor=e.target.value;renderCanvas()};
if(c.entities)document.getElementById('prop-entities').oninput=e=>{c.entities=e.target.value.split('\n').filter(x=>x.trim());renderCanvas()};
else document.getElementById('prop-entity').oninput=e=>{c.entity=e.target.value;renderCanvas()}}
function deleteCard(){if(!selectedCard||!confirm('Delete?'))return;cards=cards.filter(c=>c.id!==selectedCard.id);selectedCard=null;saveState();renderCanvas();showProperties(null)}
function duplicateCard(){if(!selectedCard)return;const n={...selectedCard,id:cardIdCounter++,x:selectedCard.x+30,y:selectedCard.y+30,entities:selectedCard.entities?[...selectedCard.entities]:undefined};cards.push(n);saveState();renderCanvas();selectCard(n)}
function toggleGridSnap(){snapToGrid=!snapToGrid;document.getElementById('gridSnapBtn').textContent=snapToGrid?'üß≤ ON':'üß≤ OFF'}
function clearAll(){if(!confirm('Clear all?'))return;cards=[];selectedCard=null;cardIdCounter=0;saveState();renderCanvas();showProperties(null)}
function saveProject(){const d={cards,bg:bgSettings,v:'2.0'};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='dashboard-v2.json';a.click();URL.revokeObjectURL(u)}
function showYAML(){document.getElementById('yamlOutput').textContent=generateYAML();document.getElementById('yamlModal').classList.add('active')}
function generateYAML(){let y='views:\n  - title: Dashboard\n    cards:\n';cards.forEach(c=>{y+=`      - type: ${c.type}\n        title: "${c.title}"\n`;if(c.entities){y+='        entities:\n';c.entities.forEach(e=>y+=`          - ${e}\n`)}else if(c.entity)y+=`        entity: ${c.entity}\n`;y+='\n'});return y}
function copyYAML(){navigator.clipboard.writeText(document.getElementById('yamlOutput').textContent).then(()=>alert('Copied!')).catch(()=>alert('Failed'))}
function closeModal(id){document.getElementById(id).classList.remove('active')}
function showBackgroundModal(){const m=document.getElementById('backgroundModal');m.classList.add('active');document.getElementById('bgGrad1').value=bgSettings.grad1;document.getElementById('bgGrad2').value=bgSettings.grad2;document.getElementById('bgAngle').value=bgSettings.angle;document.getElementById('bgImageUrl').value=bgSettings.imageUrl;document.getElementById('bgSolid').value=bgSettings.solid;document.getElementById('bgOpacity').value=bgSettings.opacity;document.getElementById('bgBlur').value=bgSettings.blur;document.getElementById('bgOverlayDark').value=bgSettings.overlay;document.querySelector(`input[name="bgType"][value="${bgSettings.type}"]`).checked=true;updateBgType();updateBgPreview()}
function updateBgType(){const type=document.querySelector('input[name="bgType"]:checked').value;document.getElementById('gradientControls').style.display=type==='gradient'?'block':'none';document.getElementById('imageControls').style.display=type==='image'?'block':'none';document.getElementById('solidControls').style.display=type==='solid'?'block':'none';updateBgPreview()}
function updateBgPreview(){const type=document.querySelector('input[name="bgType"]:checked').value;const preview=document.getElementById('bgPreview');const angle=document.getElementById('bgAngle').value;const opacity=document.getElementById('bgOpacity').value;const blur=document.getElementById('bgBlur').value;const overlay=document.getElementById('bgOverlayDark').value;document.getElementById('angleVal').textContent=angle+'¬∞';document.getElementById('opacityVal').textContent=opacity+'%';document.getElementById('blurVal').textContent=blur+'px';document.getElementById('overlayVal').textContent=overlay+'%';if(type==='gradient'){const c1=document.getElementById('bgGrad1').value;const c2=document.getElementById('bgGrad2').value;preview.style.background=`linear-gradient(${angle}deg,${c1},${c2})`}else if(type==='image'){const url=document.getElementById('bgImageUrl').value;preview.style.background=url?`url(${url})`:'#1a1a2e';preview.style.backgroundSize='cover';preview.style.backgroundPosition='center'}else{const color=document.getElementById('bgSolid').value;preview.style.background=color}preview.style.opacity=opacity/100;preview.style.filter=`blur(${blur}px)`}
function handleBgImage(){const file=document.getElementById('bgImageUpload').files[0];if(file){const reader=new FileReader();reader.onload=e=>{document.getElementById('bgImageUrl').value=e.target.result;updateBgPreview()};reader.readAsDataURL(file)}}
function applyBackground(){const type=document.querySelector('input[name="bgType"]:checked').value;bgSettings.type=type;bgSettings.grad1=document.getElementById('bgGrad1').value;bgSettings.grad2=document.getElementById('bgGrad2').value;bgSettings.angle=document.getElementById('bgAngle').value;bgSettings.imageUrl=document.getElementById('bgImageUrl').value;bgSettings.solid=document.getElementById('bgSolid').value;bgSettings.opacity=document.getElementById('bgOpacity').value;bgSettings.blur=document.getElementById('bgBlur').value;bgSettings.overlay=document.getElementById('bgOverlayDark').value;const bgLayer=document.querySelector('.bg-layer');const bgImage=document.getElementById('bgImage');const bgOverlay=document.getElementById('bgOverlay');if(type==='gradient'){bgLayer.style.background=`linear-gradient(${bgSettings.angle}deg,${bgSettings.grad1},${bgSettings.grad2})`;bgImage.style.backgroundImage='none'}else if(type==='image'){bgLayer.style.background='#000';bgImage.style.backgroundImage=`url(${bgSettings.imageUrl})`;bgImage.style.opacity=bgSettings.opacity/100;bgImage.style.filter=`blur(${bgSettings.blur}px)`}else{bgLayer.style.background=bgSettings.solid;bgImage.style.backgroundImage='none'}bgOverlay.style.background=`rgba(0,0,0,${bgSettings.overlay/100})`;saveState();closeModal('backgroundModal')}
applyBackground();renderCanvas();
</script>
</body>
</html>
