<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HA Dashboard Builder v4.0 MEGA</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Open+Sans:wght@300;400;700&family=Lato:wght@300;400;700&family=Montserrat:wght@300;400;700&family=Raleway:wght@300;400;700&family=Poppins:wght@300;400;700&family=Orbitron:wght@400;700&family=Playfair+Display:wght@400;700&family=Ubuntu:wght@300;400;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',sans-serif;color:#fff;overflow:hidden;height:100vh;position:relative}
.bg-layer{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;background:linear-gradient(135deg,#0f0f1e 0%,#1a1a2e 100%);transition:all .5s}.bg-image{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;opacity:.3;transition:all .5s}.bg-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);transition:all .5s}
.app-container{display:grid;grid-template-columns:380px 1fr 380px;grid-template-rows:70px 50px 1fr 40px;height:100vh;position:relative}.header{grid-column:1/-1;background:rgba(20,20,40,.95);backdrop-filter:blur(10px);border-bottom:2px solid rgba(67,238,255,.4);padding:0 30px;display:flex;align-items:center;justify-content:space-between;z-index:100}
.logo{font-size:1.6em;font-weight:700;background:linear-gradient(135deg,#43eeff,#ff43ee);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;cursor:pointer}.version{font-size:.7em;color:#666;margin-left:10px}.badge{background:linear-gradient(135deg,#ff43ee,#43eeff);padding:2px 8px;border-radius:4px;font-size:.6em;color:#000;margin-left:8px;font-weight:800}
.header-center{display:flex;gap:10px;align-items:center}.dashboard-selector{padding:8px 16px;background:rgba(67,238,255,.2);border:1px solid #43eeff;border-radius:6px;color:#43eeff;cursor:pointer;font-weight:600;font-size:.9em;min-width:200px;text-align:center;position:relative}.dashboard-selector:hover{background:rgba(67,238,255,.3)}.dashboard-selector:hover::after{content:attr(data-tooltip);position:absolute;bottom:-30px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:4px 8px;border-radius:4px;font-size:.75em;white-space:nowrap;z-index:10000}
.header-actions{display:flex;gap:8px;flex-wrap:wrap}.header-btn{padding:8px 14px;background:rgba(67,238,255,.15);border:1px solid #43eeff;border-radius:6px;color:#43eeff;cursor:pointer;font-weight:600;transition:all .3s;font-size:.85em;white-space:nowrap;position:relative}.header-btn:hover{background:rgba(67,238,255,.3);transform:translateY(-2px)}.header-btn.active{background:rgba(67,238,255,.4);border-color:#ff43ee}.header-btn.premium{background:linear-gradient(135deg,#ff43ee,#eb2fda);color:#fff;border:none}.header-btn::after{content:attr(data-tooltip);position:absolute;bottom:-35px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:5px 10px;border-radius:4px;font-size:.75em;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;z-index:10000}.header-btn:hover::after{opacity:1}
.toolbar{grid-column:1/-1;background:rgba(15,15,30,.9);border-bottom:1px solid rgba(67,238,255,.2);padding:8px 20px;display:flex;gap:12px;align-items:center;overflow-x:auto}.tool-group{display:flex;gap:6px;padding-right:12px;border-right:1px solid rgba(67,238,255,.2)}.tool-btn{padding:6px 12px;background:rgba(67,238,255,.1);border:1px solid rgba(67,238,255,.3);border-radius:6px;color:#43eeff;cursor:pointer;font-size:.8em;transition:all .2s;white-space:nowrap;position:relative}.tool-btn:hover{background:rgba(67,238,255,.25)}.tool-btn.active{background:rgba(255,67,238,.2);border-color:#ff43ee;color:#ff43ee}.tool-btn::after{content:attr(data-tooltip);position:absolute;bottom:-30px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:4px 8px;border-radius:4px;font-size:.75em;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;z-index:10000}.tool-btn:hover::after{opacity:1}
.sidebar{background:rgba(20,20,40,.85);backdrop-filter:blur(10px);border-right:1px solid rgba(67,238,255,.2);padding:20px;overflow-y:auto}.sidebar h2{color:#ff43ee;margin-bottom:15px;font-size:1.2em}.sidebar-tabs{display:flex;gap:8px;margin-bottom:15px}.sidebar-tab{padding:8px 16px;background:rgba(67,238,255,.1);border:none;border-radius:6px;color:#43eeff;cursor:pointer;font-size:.85em;flex:1;text-align:center}.sidebar-tab.active{background:rgba(67,238,255,.25);border:1px solid #ff43ee}
.canvas-container{background:transparent;position:relative;overflow:auto}.canvas{min-height:100%;min-width:100%;background-image:repeating-linear-gradient(0deg,rgba(67,238,255,.05) 0px,transparent 1px,transparent 50px,rgba(67,238,255,.05) 51px),repeating-linear-gradient(90deg,rgba(67,238,255,.05) 0px,transparent 1px,transparent 50px,rgba(67,238,255,.05) 51px);background-size:50px 50px;position:relative;padding:40px;transition:all .3s}.canvas.mobile-preview{max-width:375px;margin:0 auto;background:rgba(0,0,0,.1);border:2px solid rgba(67,238,255,.3);border-radius:20px}.canvas.tablet-preview{max-width:768px;margin:0 auto;background:rgba(0,0,0,.1);border:2px solid rgba(67,238,255,.3);border-radius:12px}
.canvas-card{position:absolute;background:#43eeff;padding:18px;cursor:move;box-shadow:0 4px 20px rgba(67,238,255,.5);min-width:150px;min-height:100px;transition:all .3s}.canvas-card.anim-fade{animation:fadeIn .5s}.canvas-card.anim-slide{animation:slideIn .5s}.canvas-card.anim-bounce{animation:bounceIn .6s}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}@keyframes bounceIn{0%{opacity:0;transform:scale(.3)}50%{opacity:1;transform:scale(1.05)}70%{transform:scale(.9)}100%{transform:scale(1)}}
.canvas-card:hover{box-shadow:0 8px 35px rgba(67,238,255,.7)}.canvas-card.selected{border:3px solid #ff43ee;box-shadow:0 0 0 4px rgba(255,67,238,.3)}.canvas-card.multi-selected{border:3px solid #ffeb3b;box-shadow:0 0 0 4px rgba(255,235,59,.3)}.canvas-card.drag-over{border:3px dashed #ffeb3b;background:rgba(255,235,59,.1)}
.card-type-badge{position:absolute;top:8px;left:8px;background:rgba(0,0,0,.7);padding:4px 10px;border-radius:6px;font-size:.7em;color:#fff;font-weight:700;text-transform:uppercase;z-index:5}.card-size-badge{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.7);padding:4px 10px;border-radius:6px;font-size:.7em;color:#fff;z-index:5}.card-z-badge{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.7);padding:4px 8px;border-radius:6px;font-size:.65em;color:#fff;z-index:5}.card-group-badge{position:absolute;bottom:8px;left:8px;background:rgba(255,67,238,.8);padding:4px 8px;border-radius:6px;font-size:.65em;color:#fff;z-index:5;font-weight:700}
.card-title-display{color:#ff43ee;font-size:1.2em;font-weight:600;margin-bottom:12px;margin-top:20px}.card-entity-display{font-size:.85em;margin:6px 0;padding:6px 10px;background:rgba(255,255,255,.25);border-radius:6px;color:#ffeb3b;cursor:grab;position:relative;transition:all .2s}.card-entity-display:hover{background:rgba(255,255,255,.35);transform:translateX(5px)}.card-entity-display.dragging-entity{opacity:.5;cursor:grabbing}.card-entity-display.drag-over-entity{border-top:3px solid #ff43ee}
.resize-handle{position:absolute;width:14px;height:14px;background:#ff43ee;border:2px solid #fff;border-radius:50%;display:none;z-index:10}.canvas-card.selected .resize-handle{display:block}.resize-se{bottom:-7px;right:-7px;cursor:se-resize}.resize-sw{bottom:-7px;left:-7px;cursor:sw-resize}.resize-ne{top:-7px;right:-7px;cursor:ne-resize}.resize-nw{top:-7px;left:-7px;cursor:nw-resize}
.form-group{margin-bottom:15px}label{display:block;color:#a5b4fc;margin-bottom:5px;font-size:.85em;font-weight:500}input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(67,238,255,.3);background:rgba(10,10,20,.9);color:#fff;font-size:.9em}select{cursor:pointer}textarea{resize:vertical;font-family:inherit}input[type=color]{height:45px;cursor:pointer}input[type=checkbox],input[type=radio]{width:auto;margin-right:8px}input[type=file]{padding:12px;border:2px dashed rgba(67,238,255,.5);background:rgba(67,238,255,.05);cursor:pointer}input[type=range]{cursor:pointer}
.btn{width:100%;padding:12px;background:linear-gradient(135deg,#43eeff,#2fdaeb);border:none;border-radius:8px;color:#0a0a15;font-weight:600;cursor:pointer;transition:all .3s;margin:5px 0;font-size:.9em}.btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(67,238,255,.6)}.btn-secondary{background:linear-gradient(135deg,#ff43ee,#eb2fda)}.btn-danger{background:linear-gradient(135deg,#f44,#c00);color:#fff}.btn-success{background:linear-gradient(135deg,#4caf50,#45a049);color:#fff}.btn-small{padding:8px;font-size:.8em}
.checkbox-label{display:flex;align-items:center;padding:10px;background:rgba(67,238,255,.1);border-radius:8px;cursor:pointer;transition:background .2s}.checkbox-label:hover{background:rgba(67,238,255,.2)}
.properties-panel{background:rgba(20,20,40,.85);backdrop-filter:blur(10px);border-left:1px solid rgba(67,238,255,.2);padding:20px;overflow-y:auto}.no-selection{text-align:center;color:#666;padding:50px 15px}.no-selection-icon{font-size:3.5em;margin-bottom:12px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:1000;align-items:center;justify-content:center}.modal.active{display:flex}.modal-content{background:rgba(20,20,40,.98);border:2px solid #43eeff;border-radius:16px;padding:30px;max-width:900px;width:90%;max-height:85vh;overflow-y:auto}.modal h2{color:#ff43ee;margin-bottom:20px;font-size:1.6em}
.yaml-output{background:#0a0a15;border:1px solid rgba(67,238,255,.4);border-radius:10px;padding:18px;font-family:'Courier New',monospace;color:#43eeff;white-space:pre-wrap;max-height:450px;overflow-y:auto;font-size:.85em;line-height:1.5}
.card-type-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px}.card-type-btn{padding:12px;background:rgba(67,238,255,.08);border:2px solid rgba(67,238,255,.3);border-radius:10px;color:#43eeff;cursor:pointer;text-align:center;transition:all .25s;font-weight:500;font-size:.8em}.card-type-btn:hover{background:rgba(67,238,255,.18);border-color:#43eeff;transform:scale(1.03)}.card-type-btn.active{background:rgba(67,238,255,.25);border-color:#ff43ee;color:#ff43ee}.card-type-icon{font-size:1.3em;display:block;margin-bottom:5px}
.divider{height:1px;background:rgba(67,238,255,.2);margin:15px 0}.prop-section{margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid rgba(67,238,255,.15)}.prop-section h3{color:#ff43ee;margin-bottom:12px;font-size:1em}
.template-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}.template-card{padding:18px;background:rgba(67,238,255,.08);border:2px solid rgba(67,238,255,.3);border-radius:12px;cursor:pointer;transition:all .3s;text-align:center}.template-card:hover{background:rgba(67,238,255,.15);transform:translateY(-3px);border-color:#43eeff}.template-icon{font-size:2.5em;margin-bottom:8px}.template-title{font-weight:600;color:#43eeff;margin-bottom:4px;font-size:.9em}.template-desc{font-size:.75em;color:#999}
.theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}.theme-card{padding:15px;border-radius:10px;cursor:pointer;transition:all .3s;border:2px solid transparent;text-align:center}.theme-card:hover{transform:scale(1.05);border-color:#43eeff}.theme-name{font-size:.85em;margin-top:8px;font-weight:600}
.dashboard-list{display:grid;gap:10px;max-height:400px;overflow-y:auto}.dashboard-item{padding:15px;background:rgba(67,238,255,.08);border:2px solid rgba(67,238,255,.3);border-radius:10px;cursor:pointer;transition:all .2s}.dashboard-item:hover{background:rgba(67,238,255,.15);border-color:#43eeff}.dashboard-item.active{border-color:#ff43ee;background:rgba(255,67,238,.15)}.dashboard-name{font-weight:600;color:#43eeff;margin-bottom:5px}.dashboard-meta{font-size:.75em;color:#999}
.search-box{width:100%;padding:10px;background:rgba(10,10,20,.9);border:1px solid rgba(67,238,255,.3);border-radius:8px;color:#fff;margin-bottom:15px;font-size:.9em}.search-box:focus{outline:none;border-color:#43eeff}
.status-bar{grid-column:1/-1;background:rgba(15,15,30,.95);border-top:1px solid rgba(67,238,255,.2);padding:8px 20px;display:flex;justify-content:space-between;align-items:center;font-size:.75em;color:#999}.status-item{display:flex;align-items:center;gap:8px}.status-dot{width:8px;height:8px;border-radius:50%;background:#4caf50;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.context-menu{position:fixed;background:rgba(20,20,40,.98);border:2px solid #43eeff;border-radius:8px;padding:6px;min-width:160px;z-index:10000;box-shadow:0 4px 20px rgba(0,0,0,.5);display:none}.context-menu.active{display:block}.context-menu-item{padding:10px 14px;color:#43eeff;cursor:pointer;border-radius:4px;transition:all .2s;font-size:.85em}.context-menu-item:hover{background:rgba(67,238,255,.2)}
.shortcuts-panel{background:#0a0a15;border:1px solid rgba(67,238,255,.4);border-radius:10px;padding:15px;max-height:400px;overflow-y:auto}.shortcut-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid rgba(67,238,255,.1);font-size:.85em}.shortcut-key{background:rgba(67,238,255,.2);padding:4px 8px;border-radius:4px;font-family:monospace;color:#43eeff;font-size:.8em}
.notification{position:fixed;top:80px;right:20px;background:linear-gradient(135deg,#43eeff,#2fdaeb);color:#000;padding:15px 20px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.5);z-index:10001;animation:slideInRight .3s;font-weight:600;min-width:250px}@keyframes slideInRight{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}.notification.error{background:linear-gradient(135deg,#f44,#c00);color:#fff}.notification.success{background:linear-gradient(135deg,#4caf50,#45a049);color:#fff}
.version-item{padding:12px;background:rgba(67,238,255,.08);border:1px solid rgba(67,238,255,.3);border-radius:8px;margin-bottom:10px;cursor:pointer;transition:all .2s}.version-item:hover{background:rgba(67,238,255,.15)}.version-time{font-size:.75em;color:#999;margin-bottom:5px}.version-cards{color:#43eeff;font-size:.85em}
.gallery-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;max-height:500px;overflow-y:auto}.gallery-item{background:rgba(67,238,255,.08);border:2px solid rgba(67,238,255,.3);border-radius:12px;overflow:hidden;cursor:pointer;transition:all .3s}.gallery-item:hover{transform:translateY(-5px);border-color:#43eeff;box-shadow:0 8px 25px rgba(67,238,255,.3)}.gallery-preview{width:100%;height:150px;background:linear-gradient(135deg,#1a1a2e,#0f0f1e);display:flex;align-items:center;justify-content:center;font-size:3em;color:rgba(67,238,255,.3)}.gallery-info{padding:12px}.gallery-title{font-weight:600;color:#43eeff;margin-bottom:5px;font-size:.9em}.gallery-author{font-size:.75em;color:#999;margin-bottom:8px}.gallery-stats{display:flex;gap:15px;font-size:.75em;color:#666}.gallery-stat{display:flex;align-items:center;gap:4px}
.color-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
</style>
</head>
<body>
<div class="bg-layer">
<div class="bg-image" id="bgImage"></div>
<div class="bg-overlay" id="bgOverlay"></div>
</div>
<div class="app-container">
<div class="header">
<div class="logo" onclick="showDashboardManager()">üé® HA Dashboard Builder<span class="version">v4.0</span><span class="badge">MEGA</span></div>
<div class="header-center">
<div class="dashboard-selector" onclick="showDashboardManager()" id="currentDashboard">My Dashboard</div>
</div>
<div class="header-actions">
<button class="header-btn" onclick="showThemeMarketplace()">üé® Themes</button>
<button class="header-btn" onclick="showGallery()">üñºÔ∏è Gallery</button>
<button class="header-btn" onclick="showTemplateLibrary()">‚≠ê Templates</button>
<button class="header-btn" onclick="showImportModal()">üì• Import</button>
<button class="header-btn" onclick="toggleAutoSave()" id="autoSaveBtn">üíæ Auto</button>
<button class="header-btn" onclick="showVersionHistory()">‚è±Ô∏è History</button>
<button class="header-btn" onclick="showShortcuts()">‚å®Ô∏è</button>
<button class="header-btn" onclick="exportScreenshot()">üì∏</button>
<button class="header-btn premium" onclick="showCloudSave()">‚òÅÔ∏è Cloud</button>
</div>
</div>
<div class="toolbar">
<div class="tool-group">
<button class="tool-btn active" onclick="setPreviewMode('desktop')" id="previewDesktop">üñ•Ô∏è</button>
<button class="tool-btn" onclick="setPreviewMode('tablet')" id="previewTablet">üì±</button>
<button class="tool-btn" onclick="setPreviewMode('mobile')" id="previewMobile">üì±</button>
</div>
<div class="tool-group">
<button class="tool-btn" onclick="selectAll()">Select All</button>
<button class="tool-btn" onclick="deselectAll()">Deselect</button>
<button class="tool-btn" onclick="groupSelected()">üì¶ Group</button>
<button class="tool-btn" onclick="ungroupSelected()">üìÇ Ungroup</button>
</div>
<div class="tool-group">
<button class="tool-btn" onclick="alignCards('left')">‚¨ÖÔ∏è</button>
<button class="tool-btn" onclick="alignCards('center')">‚¨õ</button>
<button class="tool-btn" onclick="alignCards('right')">‚û°Ô∏è</button>
<button class="tool-btn" onclick="distributeCards()">‚ÜîÔ∏è</button>
</div>
<div class="tool-group">
<button class="tool-btn" onclick="changeZIndex('up')">‚¨ÜÔ∏è</button>
<button class="tool-btn" onclick="changeZIndex('down')">‚¨áÔ∏è</button>
</div>
<div class="tool-group">
<button class="tool-btn active" onclick="setAnimation('fade')" id="animFade">Fade</button>
<button class="tool-btn" onclick="setAnimation('slide')" id="animSlide">Slide</button>
<button class="tool-btn" onclick="setAnimation('bounce')" id="animBounce">Bounce</button>
</div>
<div class="tool-group">
<button class="tool-btn" onclick="toggleGridSnap()" id="gridSnapBtn">üß≤ ON</button>
<button class="tool-btn" onclick="undo()">‚Ü∂</button>
<button class="tool-btn" onclick="redo()">‚Ü∑</button>
</div>
</div>
<div class="sidebar">
<div class="sidebar-tabs">
<button class="sidebar-tab active" onclick="showSidebarTab('cards')" id="tabCards">Cards</button>
<button class="sidebar-tab" onclick="showSidebarTab('search')" id="tabSearch">Search</button>
<button class="sidebar-tab" onclick="showSidebarTab('layers')" id="tabLayers">Layers</button>
</div>
<div id="sidebarContent">
<div id="cardsTab">
<h2>‚ûï Add Card</h2>
<div class="card-type-selector">
<div class="card-type-btn active" onclick="selectCardType('entities')"><span class="card-type-icon">üìã</span>Entities</div>
<div class="card-type-btn" onclick="selectCardType('thermostat')"><span class="card-type-icon">üå°Ô∏è</span>Thermo</div>
<div class="card-type-btn" onclick="selectCardType('weather')"><span class="card-type-icon">üå§Ô∏è</span>Weather</div>
<div class="card-type-btn" onclick="selectCardType('camera')"><span class="card-type-icon">üì∑</span>Camera</div>
<div class="card-type-btn" onclick="selectCardType('media')"><span class="card-type-icon">üéµ</span>Media</div>
<div class="card-type-btn" onclick="selectCardType('gauge')"><span class="card-type-icon">‚è±Ô∏è</span>Gauge</div>
<div class="card-type-btn" onclick="selectCardType('button')"><span class="card-type-icon">üîò</span>Button</div>
<div class="card-type-btn" onclick="selectCardType('clock')"><span class="card-type-icon">üïê</span>Clock</div>
<div class="card-type-btn" onclick="selectCardType('markdown')"><span class="card-type-icon">üìù</span>Markdown</div>
<div class="card-type-btn" onclick="selectCardType('picture')"><span class="card-type-icon">üñºÔ∏è</span>Picture</div>
<div class="card-type-btn" onclick="selectCardType('glance')"><span class="card-type-icon">üëÅÔ∏è</span>Glance</div>
<div class="card-type-btn" onclick="selectCardType('chart')"><span class="card-type-icon">üìä</span>Chart</div>
<div class="card-type-btn" onclick="selectCardType('map')"><span class="card-type-icon">üó∫Ô∏è</span>Map</div>
<div class="card-type-btn" onclick="selectCardType('iframe')"><span class="card-type-icon">üåê</span>Iframe</div>
<div class="card-type-btn" onclick="selectCardType('light')"><span class="card-type-icon">üí°</span>Light</div>
</div>
<div class="divider"></div>
<div id="cardConfig"></div>
<button class="btn" onclick="addCardToCanvas()">‚ûï Add to Canvas</button>
</div>
<div id="searchTab" style="display:none">
<h2>üîç Search</h2>
<input type="text" class="search-box" id="searchBox" placeholder="Search cards..." oninput="searchCards()">
<div id="searchResults"></div>
</div>
<div id="layersTab" style="display:none">
<h2>üìö Layers</h2>
<div id="layersList"></div>
</div>
</div>
</div>
<div class="canvas-container"><div class="canvas" id="canvas"></div></div>
<div class="properties-panel" id="propertiesPanel">
<div class="no-selection"><div class="no-selection-icon">üëÜ</div><p>Click a card to edit</p></div>
</div>
<div class="status-bar">
<div class="status-item"><span class="status-dot"></span><span id="statusText">Ready</span></div>
<div class="status-item"><span id="cardCount">0 cards</span></div>
<div class="status-item"><span id="selectedCount">0 selected</span></div>
<div class="status-item"><span id="autoSaveStatus">Auto-save: ON</span></div>
</div>
</div>
<div class="modal" id="dashboardManagerModal"><div class="modal-content">
<h2>üìä Dashboard Manager</h2>
<div class="form-group">
<button class="btn" onclick="createNewDashboard()">‚ûï New Dashboard</button>
</div>
<div class="dashboard-list" id="dashboardList"></div>
<button class="btn btn-secondary" onclick="closeModal('dashboardManagerModal')">Close</button>
</div></div>
<div class="modal" id="themeModal"><div class="modal-content">
<h2>üé® Theme Marketplace</h2>
<p style="color:#888;margin-bottom:15px">Choose a theme for your dashboard</p>
<div class="theme-grid">
<div class="theme-card" onclick="applyTheme('default')" style="background:linear-gradient(135deg,#0f0f1e,#1a1a2e)"><div style="padding:30px"></div><div class="theme-name">Default Dark</div></div>
<div class="theme-card" onclick="applyTheme('light')" style="background:linear-gradient(135deg,#f5f5f5,#e0e0e0)"><div style="padding:30px"></div><div class="theme-name" style="color:#333">Light Mode</div></div>
<div class="theme-card" onclick="applyTheme('neon')" style="background:linear-gradient(135deg,#ff006e,#8338ec)"><div style="padding:30px"></div><div class="theme-name">Neon Dreams</div></div>
<div class="theme-card" onclick="applyTheme('ocean')" style="background:linear-gradient(135deg,#006994,#003d5c)"><div style="padding:30px"></div><div class="theme-name">Ocean Blue</div></div>
<div class="theme-card" onclick="applyTheme('forest')" style="background:linear-gradient(135deg,#1e4d2b,#0d2818)"><div style="padding:30px"></div><div class="theme-name">Forest Green</div></div>
<div class="theme-card" onclick="applyTheme('sunset')" style="background:linear-gradient(135deg,#ff6b35,#f7931e)"><div style="padding:30px"></div><div class="theme-name">Sunset Orange</div></div>
<div class="theme-card" onclick="applyTheme('purple')" style="background:linear-gradient(135deg,#7209b7,#3a0ca3)"><div style="padding:30px"></div><div class="theme-name">Royal Purple</div></div>
<div class="theme-card" onclick="applyTheme('minimal')" style="background:#1a1a1a"><div style="padding:30px"></div><div class="theme-name">Minimal Black</div></div>
<div class="theme-card" onclick="applyTheme('cyberpunk')" style="background:linear-gradient(135deg,#00ff9f,#00b8ff)"><div style="padding:30px"></div><div class="theme-name">Cyberpunk</div></div>
</div>
<button class="btn btn-secondary" onclick="closeModal('themeModal')" style="margin-top:15px">Close</button>
</div></div>
<div class="modal" id="galleryModal"><div class="modal-content">
<h2>üñºÔ∏è Community Gallery</h2>
<p style="color:#888;margin-bottom:15px">Browse and clone dashboards from the community</p>
<div class="gallery-grid">
<div class="gallery-item" onclick="cloneGalleryDashboard('smart-home')">
<div class="gallery-preview">üè†</div>
<div class="gallery-info">
<div class="gallery-title">Complete Smart Home</div>
<div class="gallery-author">by @smarthome_pro</div>
<div class="gallery-stats"><div class="gallery-stat">‚≠ê 1.2k</div><div class="gallery-stat">üíæ 450</div></div>
</div>
</div>
<div class="gallery-item" onclick="cloneGalleryDashboard('minimalist')">
<div class="gallery-preview">‚ú®</div>
<div class="gallery-info">
<div class="gallery-title">Minimalist Dashboard</div>
<div class="gallery-author">by @clean_design</div>
<div class="gallery-stats"><div class="gallery-stat">‚≠ê 890</div><div class="gallery-stat">üíæ 320</div></div>
</div>
</div>
<div class="gallery-item" onclick="cloneGalleryDashboard('energy')">
<div class="gallery-preview">‚ö°</div>
<div class="gallery-info">
<div class="gallery-title">Energy Monitor</div>
<div class="gallery-author">by @energy_saver</div>
<div class="gallery-stats"><div class="gallery-stat">‚≠ê 650</div><div class="gallery-stat">üíæ 280</div></div>
</div>
</div>
<div class="gallery-item" onclick="cloneGalleryDashboard('security')">
<div class="gallery-preview">üîí</div>
<div class="gallery-info">
<div class="gallery-title">Security Central</div>
<div class="gallery-author">by @safe_home</div>
<div class="gallery-stats"><div class="gallery-stat">‚≠ê 720</div><div class="gallery-stat">üíæ 195</div></div>
</div>
</div>
</div>
<button class="btn btn-secondary" onclick="closeModal('galleryModal')" style="margin-top:15px">Close</button>
</div></div>
<div class="modal" id="templateModal"><div class="modal-content">
<h2>‚≠ê Template Library</h2>
<div class="template-grid">
<div class="template-card" onclick="applyTemplate('living')"><div class="template-icon">üõãÔ∏è</div><div class="template-title">Living Room</div><div class="template-desc">Lights, media, climate</div></div>
<div class="template-card" onclick="applyTemplate('kitchen')"><div class="template-icon">üç≥</div><div class="template-title">Kitchen</div><div class="template-desc">Appliances & lighting</div></div>
<div class="template-card" onclick="applyTemplate('bedroom')"><div class="template-icon">üõèÔ∏è</div><div class="template-title">Bedroom</div><div class="template-desc">Climate & lighting</div></div>
<div class="template-card" onclick="applyTemplate('security')"><div class="template-icon">üîí</div><div class="template-title">Security</div><div class="template-desc">Cameras & sensors</div></div>
<div class="template-card" onclick="applyTemplate('energy')"><div class="template-icon">‚ö°</div><div class="template-title">Energy</div><div class="template-desc">Power monitoring</div></div>
<div class="template-card" onclick="applyTemplate('outdoor')"><div class="template-icon">üå≥</div><div class="template-title">Outdoor</div><div class="template-desc">Garden & weather</div></div>
</div>
<button class="btn btn-secondary" onclick="closeModal('templateModal')" style="margin-top:15px">Close</button>
</div></div>
<div class="modal" id="importModal"><div class="modal-content">
<h2>üì• Import YAML</h2>
<textarea class="form-control" id="importYaml" rows="12" placeholder="Paste your Home Assistant YAML here..." style="width:100%;padding:15px;background:#0a0a15;border:1px solid rgba(67,238,255,.4);border-radius:8px;color:#43eeff;font-family:monospace;font-size:.85em"></textarea>
<button class="btn" onclick="importYAML()" style="margin-top:15px">üöÄ Import & Build</button>
<button class="btn btn-secondary" onclick="closeModal('importModal')">Close</button>
</div></div>
<div class="modal" id="versionHistoryModal"><div class="modal-content">
<h2>‚è±Ô∏è Version History</h2>
<p style="color:#888;margin-bottom:15px">Restore previous versions of your dashboard</p>
<div id="versionList" style="max-height:400px;overflow-y:auto"></div>
<button class="btn btn-secondary" onclick="closeModal('versionHistoryModal')" style="margin-top:15px">Close</button>
</div></div>
<div class="modal" id="shortcutsModal"><div class="modal-content">
<h2>‚å®Ô∏è Keyboard Shortcuts</h2>
<div class="shortcuts-panel">
<div class="shortcut-item"><span>Select All</span><span class="shortcut-key">Ctrl+A</span></div>
<div class="shortcut-item"><span>Copy Card</span><span class="shortcut-key">Ctrl+C</span></div>
<div class="shortcut-item"><span>Paste Card</span><span class="shortcut-key">Ctrl+V</span></div>
<div class="shortcut-item"><span>Duplicate Card</span><span class="shortcut-key">Ctrl+D</span></div>
<div class="shortcut-item"><span>Delete Card</span><span class="shortcut-key">Delete</span></div>
<div class="shortcut-item"><span>Undo</span><span class="shortcut-key">Ctrl+Z</span></div>
<div class="shortcut-item"><span>Redo</span><span class="shortcut-key">Ctrl+Y</span></div>
<div class="shortcut-item"><span>Save</span><span class="shortcut-key">Ctrl+S</span></div>
<div class="shortcut-item"><span>Toggle Grid Snap</span><span class="shortcut-key">G</span></div>
<div class="shortcut-item"><span>Group Cards</span><span class="shortcut-key">Ctrl+G</span></div>
<div class="shortcut-item"><span>Ungroup Cards</span><span class="shortcut-key">Ctrl+Shift+G</span></div>
<div class="shortcut-item"><span>Move Card Up</span><span class="shortcut-key">‚Üë</span></div>
<div class="shortcut-item"><span>Move Card Down</span><span class="shortcut-key">‚Üì</span></div>
<div class="shortcut-item"><span>Move Card Left</span><span class="shortcut-key">‚Üê</span></div>
<div class="shortcut-item"><span>Move Card Right</span><span class="shortcut-key">‚Üí</span></div>
</div>
<button class="btn btn-secondary" onclick="closeModal('shortcutsModal')" style="margin-top:15px">Close</button>
</div></div>
<div class="modal" id="cloudSaveModal"><div class="modal-content">
<h2>‚òÅÔ∏è Cloud Save</h2>
<p style="color:#888;margin-bottom:15px">Save your dashboards to the cloud and access from anywhere</p>
<div class="prop-section">
<h3>Save Current Dashboard</h3>
<div class="form-group"><label>Dashboard Name</label><input type="text" id="cloudDashboardName" placeholder="My Awesome Dashboard"></div>
<button class="btn" onclick="saveToCloud()">‚òÅÔ∏è Save to Cloud</button>
</div>
<div class="prop-section">
<h3>Load from Cloud</h3>
<div id="cloudDashboardList"></div>
</div>
<button class="btn btn-secondary" onclick="closeModal('cloudSaveModal')" style="margin-top:15px">Close</button>
</div></div>
<div class="modal" id="yamlModal"><div class="modal-content">
<h2>üìÑ Export YAML</h2>
<div class="yaml-output" id="yamlOutput"></div>
<button class="btn" onclick="copyYAML()" style="margin-top:15px">üìã Copy</button>
<button class="btn btn-secondary" onclick="downloadYAML()">üíæ Download</button>
<button class="btn btn-secondary" onclick="closeModal('yamlModal')">Close</button>
</div></div>
<div class="context-menu" id="contextMenu">
<div class="context-menu-item" onclick="copyEntity()">üìã Copy</div>
<div class="context-menu-item" onclick="deleteEntity()">üóëÔ∏è Delete</div>
</div>
<div id="notification"></div>
<script>
let cards=[],selectedCard=null,selectedCards=[],selectedCardType='entities',draggedCard=null,resizingCard=null,resizeHandle=null,dragOffset={x:0,y:0},cardIdCounter=0,history=[],historyIndex=-1,maxHistory=100,gridSize=50,snapToGrid=true;
let draggedEntity=null,draggedFromCard=null,draggedEntityIndex=-1,contextEntity=null,contextCard=null,contextEntityIndex=-1;
let bgSettings={type:'gradient',grad1:'#0f0f1e',grad2:'#1a1a2e',angle:135,imageUrl:'',solid:'#1a1a2e',opacity:30,blur:0,overlay:50};
let previewMode='desktop',animationType='fade',clipboard=null,autoSave=true,autoSaveInterval=null;
let dashboards=[{id:1,name:'My Dashboard',cards:[],bg:bgSettings,created:Date.now()}],currentDashboardId=1;
let versionHistory=[],groups={},cloudDashboards=[];
const canvas=document.getElementById('canvas'),propertiesPanel=document.getElementById('propertiesPanel'),cardConfig=document.getElementById('cardConfig');
const themes={default:{bg1:'#0f0f1e',bg2:'#1a1a2e',card:'#43eeff',title:'#ff43ee',entity:'#ffeb3b'},light:{bg1:'#f5f5f5',bg2:'#e0e0e0',card:'#2196f3',title:'#e91e63',entity:'#ff9800'},neon:{bg1:'#ff006e',bg2:'#8338ec',card:'#00ff9f',title:'#ffbe0b',entity:'#fb5607'},ocean:{bg1:'#006994',bg2:'#003d5c',card:'#00b4d8',title:'#0077b6',entity:'#90e0ef'},forest:{bg1:'#1e4d2b',bg2:'#0d2818',card:'#52b788',title:'#95d5b2',entity:'#d8f3dc'},sunset:{bg1:'#ff6b35',bg2:'#f7931e',card:'#ffd60a',title:'#ff006e',entity:'#ffbe0b'},purple:{bg1:'#7209b7',bg2:'#3a0ca3',card:'#c77dff',title:'#e0aaff',entity:'#f72585'},minimal:{bg1:'#1a1a1a',bg2:'#1a1a1a',card:'#333',title:'#fff',entity:'#ccc'},cyberpunk:{bg1:'#00ff9f',bg2:'#00b8ff',card:'#ff006e',title:'#ffbe0b',entity:'#8338ec'}};
function snapToGridValue(v){return snapToGrid?Math.round(v/gridSize)*gridSize:v}
function saveState(){const currentDash=dashboards.find(d=>d.id===currentDashboardId);if(currentDash){currentDash.cards=JSON.parse(JSON.stringify(cards));currentDash.bg=JSON.parse(JSON.stringify(bgSettings))}history=history.slice(0,historyIndex+1);history.push(JSON.stringify({cards,bg:bgSettings}));historyIndex++;if(history.length>maxHistory){history.shift();historyIndex--}versionHistory.push({time:Date.now(),cards:JSON.parse(JSON.stringify(cards)),cardCount:cards.length});if(versionHistory.length>20)versionHistory.shift();updateStatus('Saved')}
function undo(){if(historyIndex>0){historyIndex--;const state=JSON.parse(history[historyIndex]);cards=state.cards||[];bgSettings=state.bg||bgSettings;renderCanvas();applyBackground();updateStatus('Undo');if(selectedCard){selectedCard=cards.find(c=>c.id===selectedCard.id);if(selectedCard)showProperties(selectedCard)}}}
function redo(){if(historyIndex<history.length-1){historyIndex++;const state=JSON.parse(history[historyIndex]);cards=state.cards||[];bgSettings=state.bg||bgSettings;renderCanvas();applyBackground();updateStatus('Redo');if(selectedCard){selectedCard=cards.find(c=>c.id===selectedCard.id);if(selectedCard)showProperties(selectedCard)}}}
document.addEventListener('keydown',e=>{if(e.ctrlKey||e.metaKey){if(e.key==='z'&&!e.shiftKey){e.preventDefault();undo()}else if(e.key==='y'||(e.key==='z'&&e.shiftKey)){e.preventDefault();redo()}else if(e.key==='d'){e.preventDefault();duplicateCard()}else if(e.key==='c'&&selectedCard){e.preventDefault();clipboard=JSON.parse(JSON.stringify(selectedCard));showNotification('Card copied')}else if(e.key==='v'&&clipboard){e.preventDefault();pasteCard()}else if(e.key==='a'){e.preventDefault();selectAll()}else if(e.key==='s'){e.preventDefault();saveProject()}else if(e.key==='g'&&!e.shiftKey){e.preventDefault();groupSelected()}else if(e.key==='g'&&e.shiftKey){e.preventDefault();ungroupSelected()}}else if(e.key==='Delete'){if(selectedCards.length>0)deleteMultiple();else if(selectedCard)deleteCard()}else if(e.key==='g'&&!e.ctrlKey){toggleGridSnap()}else if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)&&selectedCard){e.preventDefault();moveCardWithKeys(e.key)}});
document.addEventListener('click',()=>document.getElementById('contextMenu').classList.remove('active'));
const cardTypeConfigs={entities:{defaultSize:{width:300,height:200},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="My Entities"></div><div class="form-group"><label>Entities</label><textarea id="newCardEntities" rows="6" placeholder="light.living_room
switch.fan"></textarea></div>`},thermostat:{defaultSize:{width:300,height:280},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Thermostat"></div><div class="form-group"><label>Entity</label><input type="text" id="thermostatEntity" value="climate.thermostat"></div>`},weather:{defaultSize:{width:350,height:250},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Weather"></div><div class="form-group"><label>Entity</label><input type="text" id="weatherEntity" value="weather.forecast"></div>`},camera:{defaultSize:{width:400,height:300},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Camera"></div><div class="form-group"><label>Entity</label><input type="text" id="cameraEntity" value="camera.entrance"></div>`},media:{defaultSize:{width:350,height:200},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Media"></div><div class="form-group"><label>Entity</label><input type="text" id="mediaEntity" value="media_player.speaker"></div>`},gauge:{defaultSize:{width:250,height:250},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Gauge"></div><div class="form-group"><label>Entity</label><input type="text" id="gaugeEntity" value="sensor.battery"></div><div class="form-group"><label>Min</label><input type="number" id="gaugeMin" value="0"></div><div class="form-group"><label>Max</label><input type="number" id="gaugeMax" value="100"></div>`},button:{defaultSize:{width:200,height:150},fields:`<div class="form-group"><label>Name</label><input type="text" id="newCardTitle" value="Toggle"></div><div class="form-group"><label>Entity</label><input type="text" id="buttonEntity" value="switch.device"></div>`},clock:{defaultSize:{width:300,height:250},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Clock"></div><div class="form-group"><label>Format</label><select id="clockFormat"><option value="12">12-Hour</option><option value="24">24-Hour</option></select></div>`},markdown:{defaultSize:{width:350,height:250},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Notes"></div><div class="form-group"><label>Content</label><textarea id="markdownContent" rows="6" placeholder="## Markdown
**Bold** *italic*"></textarea></div>`},picture:{defaultSize:{width:400,height:300},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Picture"></div><div class="form-group"><label>Image URL</label><input type="text" id="pictureUrl" placeholder="https://..."></div>`},glance:{defaultSize:{width:350,height:200},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Glance"></div><div class="form-group"><label>Entities</label><textarea id="glanceEntities" rows="4" placeholder="light.living
switch.fan"></textarea></div>`},chart:{defaultSize:{width:450,height:300},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Chart"></div><div class="form-group"><label>Entity</label><input type="text" id="chartEntity" value="sensor.temperature"></div><div class="form-group"><label>Chart Type</label><select id="chartType"><option value="line">Line</option><option value="bar">Bar</option></select></div>`},map:{defaultSize:{width:500,height:400},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Map"></div><div class="form-group"><label>Entities</label><textarea id="mapEntities" rows="4" placeholder="device_tracker.phone
person.john"></textarea></div>`},iframe:{defaultSize:{width:600,height:400},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Iframe"></div><div class="form-group"><label>URL</label><input type="text" id="iframeUrl" placeholder="https://..."></div>`},light:{defaultSize:{width:300,height:200},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Lights"></div><div class="form-group"><label>Entities</label><textarea id="lightEntities" rows="4" placeholder="light.living_room
light.bedroom"></textarea></div>`}};
function selectCardType(t){selectedCardType=t;document.querySelectorAll('.card-type-btn').forEach(b=>b.classList.remove('active'));event.target.closest('.card-type-btn').classList.add('active');cardConfig.innerHTML=cardTypeConfigs[t].fields}
cardConfig.innerHTML=cardTypeConfigs.entities.fields;saveState();
function addCardToCanvas(){const size=cardTypeConfigs[selectedCardType].defaultSize,title=document.getElementById('newCardTitle')?.value||'Card',cardData={id:cardIdCounter++,type:selectedCardType,title,x:50+(cards.length*30),y:50+(cards.length*30),width:size.width,height:size.height,bgColor:'#43eeff',titleColor:'#ff43ee',entityColor:'#ffeb3b',useGradient:false,gradientColor1:'#43eeff',gradientColor2:'#ff43ee',zIndex:cards.length,animation:animationType,group:null};
if(selectedCardType==='entities'){const t=document.getElementById('newCardEntities').value;cardData.entities=t.split('\n').filter(e=>e.trim());if(!cardData.entities.length){showNotification('Add entities','error');return}}else if(['thermostat','weather','camera','media','gauge'].includes(selectedCardType)){const id=selectedCardType+'Entity';cardData.entity=document.getElementById(id).value}else if(selectedCardType==='button'){cardData.entity=document.getElementById('buttonEntity').value}else if(selectedCardType==='clock'){cardData.format=document.getElementById('clockFormat').value}else if(selectedCardType==='markdown'){cardData.content=document.getElementById('markdownContent').value}else if(selectedCardType==='picture'){cardData.imageUrl=document.getElementById('pictureUrl').value}else if(['glance','map','light'].includes(selectedCardType)){const id=selectedCardType+'Entities';const t=document.getElementById(id).value;cardData.entities=t.split('\n').filter(e=>e.trim())}else if(selectedCardType==='chart'){cardData.entity=document.getElementById('chartEntity').value;cardData.chartType=document.getElementById('chartType').value}else if(selectedCardType==='iframe'){cardData.iframeUrl=document.getElementById('iframeUrl').value}
if(selectedCardType==='gauge'){cardData.min=document.getElementById('gaugeMin').value;cardData.max=document.getElementById('gaugeMax').value}
cards.push(cardData);saveState();renderCanvas();selectCard(cardData);updateCardCount();showNotification('Card added','success')}
function renderCanvas(){canvas.innerHTML='';cards.sort((a,b)=>a.zIndex-b.zIndex).forEach(c=>canvas.appendChild(createCardElement(c)));updateLayersList()}
function createCardElement(c){const el=document.createElement('div');el.className='canvas-card';if(c.animation)el.classList.add(`anim-${c.animation}`);el.id=`card-${c.id}`;el.style.left=c.x+'px';el.style.top=c.y+'px';el.style.width=c.width+'px';el.style.height=c.height+'px';el.style.background=c.useGradient?`linear-gradient(135deg,${c.gradientColor1},${c.gradientColor2})`:c.bgColor;el.style.zIndex=c.zIndex||0;if(selectedCard&&selectedCard.id===c.id)el.classList.add('selected');if(selectedCards.some(s=>s.id===c.id))el.classList.add('multi-selected');
const tb=document.createElement('div');tb.className='card-type-badge';tb.textContent=c.type;el.appendChild(tb);
const sb=document.createElement('div');sb.className='card-size-badge';sb.textContent=`${c.width}√ó${c.height}`;el.appendChild(sb);
const zb=document.createElement('div');zb.className='card-z-badge';zb.textContent=`Z:${c.zIndex||0}`;el.appendChild(zb);
if(c.group){const gb=document.createElement('div');gb.className='card-group-badge';gb.textContent=`G:${c.group}`;el.appendChild(gb)}
if(c.type==='entities'||c.type==='light'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;el.appendChild(t);c.entities.forEach((e,idx)=>{const d=document.createElement('div');d.className='card-entity-display';d.textContent=e;d.style.color=c.entityColor;d.draggable=true;d.ondragstart=ev=>startEntityDrag(ev,c,idx,e);d.ondragend=endEntityDrag;d.ondragover=ev=>entityDragOver(ev,idx);d.ondrop=ev=>entityDrop(ev,c,idx);d.oncontextmenu=ev=>{ev.preventDefault();ev.stopPropagation();showContextMenu(ev,c,idx,e)};el.appendChild(d)})}else if(c.type==='markdown'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;el.appendChild(t);const md=document.createElement('div');md.style.cssText=`color:${c.entityColor};padding:10px;font-size:.9em;line-height:1.6`;md.textContent=c.content||'Markdown';el.appendChild(md)}else if(c.type==='picture'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;el.appendChild(t);const img=document.createElement('div');img.style.cssText='flex:1;background:#1a1a2e;display:flex;align-items:center;justify-content:center;font-size:3em;color:rgba(255,255,255,0.3)';img.textContent='üñºÔ∏è';if(c.imageUrl){img.style.backgroundImage=`url(${c.imageUrl})`;img.style.backgroundSize='cover';img.textContent=''}el.appendChild(img);el.style.display='flex';el.style.flexDirection='column'}else if(c.type==='glance'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;el.appendChild(t);const grid=document.createElement('div');grid.style.cssText='display:grid;grid-template-columns:repeat(3,1fr);gap:10px';c.entities?.forEach(e=>{const item=document.createElement('div');item.style.cssText=`text-align:center;padding:10px;background:rgba(255,255,255,0.2);border-radius:6px;color:${c.entityColor};font-size:.8em`;item.textContent=e.split('.')[1]||e;grid.appendChild(item)});el.appendChild(grid)}else if(c.type==='chart'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;el.appendChild(t);const chart=document.createElement('div');chart.style.cssText='flex:1;display:flex;align-items:center;justify-content:center;font-size:2em;color:rgba(255,255,255,0.3)';chart.textContent='üìä';el.appendChild(chart);el.style.display='flex';el.style.flexDirection='column'}else if(c.type==='map'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;el.appendChild(t);const map=document.createElement('div');map.style.cssText='flex:1;background:#1a1a2e;display:flex;align-items:center;justify-content:center;font-size:3em;color:rgba(255,255,255,0.3)';map.textContent='üó∫Ô∏è';el.appendChild(map);el.style.display='flex';el.style.flexDirection='column'}else if(c.type==='iframe'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;el.appendChild(t);const frame=document.createElement('div');frame.style.cssText='flex:1;background:#1a1a2e;display:flex;align-items:center;justify-content:center;font-size:2em;color:rgba(255,255,255,0.3)';frame.textContent='üåê Iframe';el.appendChild(frame);el.style.display='flex';el.style.flexDirection='column'}else if(c.type==='thermostat'){el.innerHTML+=`<div class="card-title-display" style="color:${c.titleColor};text-align:center">${c.title}</div><div style="text-align:center;padding:15px"><div style="font-size:2.5em;font-weight:bold;color:${c.entityColor};margin:15px 0">72¬∞</div><div style="padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:6px;font-size:0.85em;color:${c.entityColor};display:inline-block">HEAT</div></div>`}else if(c.type==='weather'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;t.style.textAlign='center';el.appendChild(t);el.innerHTML+=`<div style="text-align:center"><div style="font-size:3em;margin:10px 0">üå§Ô∏è</div><div style="font-size:2em;font-weight:bold;color:${c.entityColor}">75¬∞F</div></div>`}else if(c.type==='camera'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;el.appendChild(t);const p=document.createElement('div');p.style.cssText='background:#1a1a2e;flex:1;display:flex;align-items:center;justify-content:center;font-size:3em;color:rgba(255,255,255,0.3)';p.textContent='üì∑';el.appendChild(p);el.style.display='flex';el.style.flexDirection='column'}else if(c.type==='clock'){const t=document.createElement('div');t.className='card-title-display';t.textContent=c.title;t.style.color=c.titleColor;t.style.textAlign='center';el.appendChild(t);const now=new Date(),timeFormat=c.format==='12'?now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true}):now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});el.innerHTML+=`<div style="display:flex;align-items:center;justify-content:center;flex:1;font-size:3em;font-weight:bold;color:${c.entityColor};font-family:monospace">${timeFormat}</div>`;el.style.display='flex';el.style.flexDirection='column'}
['nw','ne','sw','se'].forEach(p=>{const h=document.createElement('div');h.className=`resize-handle resize-${p}`;h.dataset.position=p;el.appendChild(h)});
el.ondragover=ev=>{if(draggedEntity&&(c.type==='entities'||c.type==='light')){ev.preventDefault();el.classList.add('drag-over')}};
el.ondragleave=()=>el.classList.remove('drag-over');
el.ondrop=ev=>{if(draggedEntity&&(c.type==='entities'||c.type==='light')){ev.preventDefault();el.classList.remove('drag-over');if(draggedFromCard.id!==c.id){c.entities.push(draggedEntity);draggedFromCard.entities.splice(draggedEntityIndex,1);saveState();renderCanvas()}}};
el.addEventListener('mousedown',e=>{if(e.target.classList.contains('resize-handle')){startResize(e,c)}else if(!e.target.classList.contains('card-entity-display')){startDrag(e,c)}});return el}
function startEntityDrag(ev,card,idx,entity){draggedEntity=entity;draggedFromCard=card;draggedEntityIndex=idx;ev.dataTransfer.effectAllowed='move';ev.target.classList.add('dragging-entity')}
function endEntityDrag(ev){ev.target.classList.remove('dragging-entity');setTimeout(()=>{draggedEntity=null;draggedFromCard=null;draggedEntityIndex=-1},100)}
function entityDragOver(ev,idx){if(draggedEntity){ev.preventDefault();ev.stopPropagation();ev.target.classList.add('drag-over-entity')}}
function entityDrop(ev,card,dropIdx){ev.preventDefault();ev.stopPropagation();document.querySelectorAll('.drag-over-entity').forEach(e=>e.classList.remove('drag-over-entity'));if(!draggedEntity)return;if(draggedFromCard.id===card.id){const[item]=draggedFromCard.entities.splice(draggedEntityIndex,1);card.entities.splice(dropIdx,0,item)}else{draggedFromCard.entities.splice(draggedEntityIndex,1);card.entities.splice(dropIdx,0,draggedEntity)}saveState();renderCanvas()}
function showContextMenu(ev,card,idx,entity){contextCard=card;contextEntityIndex=idx;contextEntity=entity;const menu=document.getElementById('contextMenu');menu.style.left=ev.pageX+'px';menu.style.top=ev.pageY+'px';menu.classList.add('active')}
function copyEntity(){if(contextEntity){navigator.clipboard.writeText(contextEntity);showNotification('Entity copied');document.getElementById('contextMenu').classList.remove('active')}}
function deleteEntity(){if(contextCard&&contextEntityIndex>=0){contextCard.entities.splice(contextEntityIndex,1);saveState();renderCanvas();document.getElementById('contextMenu').classList.remove('active');showNotification('Entity deleted')}}
function startDrag(e,c){if(e.target.classList.contains('resize-handle'))return;draggedCard=c;if(e.shiftKey){if(!selectedCards.some(s=>s.id===c.id))selectedCards.push(c)}else{if(!selectedCards.some(s=>s.id===c.id)){selectedCards=[];selectedCard=c}}selectCard(c);const el=document.getElementById(`card-${c.id}`);const r=el.getBoundingClientRect();dragOffset.x=e.clientX-r.left;dragOffset.y=e.clientY-r.top;document.addEventListener('mousemove',handleDrag);document.addEventListener('mouseup',stopDrag);e.preventDefault()}
function handleDrag(e){if(!draggedCard)return;const r=canvas.getBoundingClientRect(),rawX=Math.max(0,e.clientX-r.left-dragOffset.x),rawY=Math.max(0,e.clientY-r.top-dragOffset.y),newX=snapToGridValue(rawX),newY=snapToGridValue(rawY),deltaX=newX-draggedCard.x,deltaY=newY-draggedCard.y;if(selectedCards.length>1){selectedCards.forEach(c=>{c.x+=deltaX;c.y+=deltaY})}else{draggedCard.x=newX;draggedCard.y=newY}renderCanvas()}
function stopDrag(){if(draggedCard)saveState();draggedCard=null;document.removeEventListener('mousemove',handleDrag);document.removeEventListener('mouseup',stopDrag)}
function startResize(e,c){resizingCard=c;resizeHandle=e.target.dataset.position;document.addEventListener('mousemove',handleResize);document.addEventListener('mouseup',stopResize);e.preventDefault();e.stopPropagation()}
function handleResize(e){if(!resizingCard)return;const r=canvas.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top;if(resizeHandle.includes('e'))resizingCard.width=snapToGridValue(Math.max(150,mx-resizingCard.x));if(resizeHandle.includes('s'))resizingCard.height=snapToGridValue(Math.max(100,my-resizingCard.y));renderCanvas()}
function stopResize(){if(resizingCard)saveState();resizingCard=null;resizeHandle=null;document.removeEventListener('mousemove',handleResize);document.removeEventListener('mouseup',stopResize)}
function selectCard(c){selectedCard=c;renderCanvas();showProperties(c);updateSelectedCount()}
function showProperties(c){if(!c){propertiesPanel.innerHTML='<div class="no-selection"><div class="no-selection-icon">üëÜ</div><p>Click card</p></div>';return}
propertiesPanel.innerHTML=`<div class="prop-section"><h3>üìù Details</h3><div class="form-group"><label>Title</label><input type="text" id="prop-title" value="${c.title}"></div>${c.entities?`<div class="form-group"><label>Entities</label><textarea id="prop-entities" rows="6">${c.entities.join('\n')}</textarea></div>`:c.content!==undefined?`<div class="form-group"><label>Content</label><textarea id="prop-content" rows="6">${c.content}</textarea></div>`:`<div class="form-group"><label>Entity</label><input type="text" id="prop-entity" value="${c.entity||''}"></div>`}</div><div class="prop-section"><h3>üìê Position</h3><div class="form-group"><label>X: ${c.x}px</label><input type="range" id="prop-x" min="0" max="1000" value="${c.x}"></div><div class="form-group"><label>Y: ${c.y}px</label><input type="range" id="prop-y" min="0" max="1000" value="${c.y}"></div><div class="form-group"><label>W: ${c.width}px</label><input type="range" id="prop-w" min="150" max="600" value="${c.width}"></div><div class="form-group"><label>H: ${c.height}px</label><input type="range" id="prop-h" min="100" max="500" value="${c.height}"></div><div class="form-group"><label>Z: ${c.zIndex||0}</label><input type="number" id="prop-z" value="${c.zIndex||0}"></div></div><div class="prop-section"><h3>üé® Colors</h3><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="prop-gradient" ${c.useGradient?'checked':''}>Gradient</label></div><div id="solidColor" style="display:${c.useGradient?'none':'block'}"><div class="form-group"><label>BG</label><input type="color" id="prop-bg" value="${c.bgColor}"></div></div><div id="gradientColors" style="display:${c.useGradient?'block':'none'}"><div class="form-group"><label>Color 1</label><input type="color" id="prop-gc1" value="${c.gradientColor1}"></div><div class="form-group"><label>Color 2</label><input type="color" id="prop-gc2" value="${c.gradientColor2}"></div></div><div class="form-group"><label>Title</label><input type="color" id="prop-tc" value="${c.titleColor}"></div><div class="form-group"><label>Entity</label><input type="color" id="prop-ec" value="${c.entityColor}"></div></div><button class="btn btn-small" onclick="duplicateCard()">üìã Duplicate</button><button class="btn btn-danger btn-small" onclick="deleteCard()">üóëÔ∏è Delete</button>`;
document.getElementById('prop-title').oninput=e=>{c.title=e.target.value;renderCanvas()};
document.getElementById('prop-x').oninput=e=>{c.x=parseInt(e.target.value);renderCanvas();e.target.previousElementSibling.textContent=`X: ${c.x}px`};
document.getElementById('prop-y').oninput=e=>{c.y=parseInt(e.target.value);renderCanvas();e.target.previousElementSibling.textContent=`Y: ${c.y}px`};
document.getElementById('prop-w').oninput=e=>{c.width=parseInt(e.target.value);renderCanvas();e.target.previousElementSibling.textContent=`W: ${c.width}px`};
document.getElementById('prop-h').oninput=e=>{c.height=parseInt(e.target.value);renderCanvas();e.target.previousElementSibling.textContent=`H: ${c.height}px`};
document.getElementById('prop-z').oninput=e=>{c.zIndex=parseInt(e.target.value);renderCanvas();e.target.previousElementSibling.textContent=`Z: ${c.zIndex}`};
document.getElementById('prop-gradient').onchange=e=>{c.useGradient=e.target.checked;document.getElementById('solidColor').style.display=c.useGradient?'none':'block';document.getElementById('gradientColors').style.display=c.useGradient?'block':'none';renderCanvas()};
document.getElementById('prop-bg').oninput=e=>{c.bgColor=e.target.value;renderCanvas()};
document.getElementById('prop-gc1').oninput=e=>{c.gradientColor1=e.target.value;renderCanvas()};
document.getElementById('prop-gc2').oninput=e=>{c.gradientColor2=e.target.value;renderCanvas()};
document.getElementById('prop-tc').oninput=e=>{c.titleColor=e.target.value;renderCanvas()};
document.getElementById('prop-ec').oninput=e=>{c.entityColor=e.target.value;renderCanvas()};
if(c.entities)document.getElementById('prop-entities').oninput=e=>{c.entities=e.target.value.split('\n').filter(x=>x.trim());renderCanvas()};
else if(c.content!==undefined)document.getElementById('prop-content').oninput=e=>{c.content=e.target.value;renderCanvas()};
else if(document.getElementById('prop-entity'))document.getElementById('prop-entity').oninput=e=>{c.entity=e.target.value;renderCanvas()}}
function deleteCard(){if(!selectedCard)return;if(confirm('Delete?')){cards=cards.filter(c=>c.id!==selectedCard.id);selectedCard=null;saveState();renderCanvas();showProperties(null);updateCardCount();showNotification('Card deleted')}}
function deleteMultiple(){if(confirm(`Delete ${selectedCards.length} cards?`)){cards=cards.filter(c=>!selectedCards.some(s=>s.id===c.id));selectedCards=[];selectedCard=null;saveState();renderCanvas();updateCardCount();showNotification('Cards deleted')}}
function duplicateCard(){if(!selectedCard)return;const n={...selectedCard,id:cardIdCounter++,x:selectedCard.x+30,y:selectedCard.y+30,entities:selectedCard.entities?[...selectedCard.entities]:undefined};cards.push(n);saveState();renderCanvas();selectCard(n);showNotification('Card duplicated')}
function pasteCard(){if(!clipboard)return;const n={...clipboard,id:cardIdCounter++,x:clipboard.x+30,y:clipboard.y+30,entities:clipboard.entities?[...clipboard.entities]:undefined};cards.push(n);saveState();renderCanvas();selectCard(n);showNotification('Card pasted')}
function selectAll(){selectedCards=cards.slice();renderCanvas();updateSelectedCount();showNotification(`Selected ${cards.length} cards`)}
function deselectAll(){selectedCards=[];selectedCard=null;renderCanvas();updateSelectedCount()}
function groupSelected(){if(selectedCards.length<2){showNotification('Select 2+ cards','error');return}const groupId=Date.now();selectedCards.forEach(c=>c.group=groupId);groups[groupId]=selectedCards.map(c=>c.id);saveState();renderCanvas();showNotification('Cards grouped')}
function ungroupSelected(){if(selectedCards.length===0){showNotification('Select grouped cards','error');return}selectedCards.forEach(c=>c.group=null);saveState();renderCanvas();showNotification('Cards ungrouped')}
function moveCardWithKeys(key){if(!selectedCard)return;const step=snapToGrid?gridSize:5;if(key==='ArrowUp')selectedCard.y=Math.max(0,selectedCard.y-step);else if(key==='ArrowDown')selectedCard.y+=step;else if(key==='ArrowLeft')selectedCard.x=Math.max(0,selectedCard.x-step);else if(key==='ArrowRight')selectedCard.x+=step;renderCanvas()}
function toggleGridSnap(){snapToGrid=!snapToGrid;document.getElementById('gridSnapBtn').textContent=snapToGrid?'üß≤ ON':'üß≤ OFF';showNotification(`Grid snap ${snapToGrid?'ON':'OFF'}`)}
function setPreviewMode(mode){previewMode=mode;canvas.className='canvas';if(mode==='mobile')canvas.classList.add('mobile-preview');else if(mode==='tablet')canvas.classList.add('tablet-preview');document.querySelectorAll('[id^="preview"]').forEach(b=>b.classList.remove('active'));document.getElementById('preview'+mode.charAt(0).toUpperCase()+mode.slice(1)).classList.add('active')}
function alignCards(dir){if(!cards.length)return;const toAlign=selectedCards.length>0?selectedCards:cards;if(dir==='left'){const minX=Math.min(...toAlign.map(c=>c.x));toAlign.forEach(c=>c.x=minX)}else if(dir==='right'){const maxX=Math.max(...toAlign.map(c=>c.x+c.width));toAlign.forEach(c=>c.x=maxX-c.width)}else if(dir==='center'){const minX=Math.min(...toAlign.map(c=>c.x));const maxX=Math.max(...toAlign.map(c=>c.x+c.width));const centerX=(minX+maxX)/2;toAlign.forEach(c=>c.x=centerX-c.width/2)}saveState();renderCanvas();showNotification(`Aligned ${dir}`)}
function distributeCards(){const toDistribute=selectedCards.length>0?selectedCards:cards;if(toDistribute.length<3)return;const sorted=toDistribute.slice().sort((a,b)=>a.x-b.x);const minX=sorted[0].x;const maxX=sorted[sorted.length-1].x;const gap=(maxX-minX)/(sorted.length-1);sorted.forEach((c,i)=>{c.x=minX+gap*i});saveState();renderCanvas();showNotification('Cards distributed')}
function changeZIndex(dir){if(!selectedCard)return;if(dir==='up')selectedCard.zIndex=(selectedCard.zIndex||0)+1;else selectedCard.zIndex=Math.max(0,(selectedCard.zIndex||0)-1);saveState();renderCanvas()}
function setAnimation(anim){animationType=anim;document.querySelectorAll('[id^="anim"]').forEach(b=>b.classList.remove('active'));document.getElementById('anim'+anim.charAt(0).toUpperCase()+anim.slice(1)).classList.add('active')}
function toggleAutoSave(){autoSave=!autoSave;document.getElementById('autoSaveBtn').textContent=autoSave?'üíæ Auto':'üíæ OFF';document.getElementById('autoSaveStatus').textContent=`Auto-save: ${autoSave?'ON':'OFF'}`;if(autoSave){autoSaveInterval=setInterval(()=>{saveState();showNotification('Auto-saved','success')},60000)}else{clearInterval(autoSaveInterval)}showNotification(`Auto-save ${autoSave?'enabled':'disabled'}`)}
function saveProject(){const d={cards,bg:bgSettings,v:'4.0'};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='dashboard-v4-'+Date.now()+'.json';a.click();URL.revokeObjectURL(u);showNotification('Project saved')}
function exportScreenshot(){showNotification('Screenshot feature coming soon','error')}
function showYAML(){const y=generateYAML();document.getElementById('yamlOutput').textContent=y;document.getElementById('yamlModal').classList.add('active')}
function generateYAML(){let y='# HA Dashboard v4.0\nviews:\n  - title: Dashboard\n    cards:\n';cards.forEach(c=>{y+=`      - type: ${c.type}\n        title: "${c.title}"\n`;if(c.entities){y+='        entities:\n';c.entities.forEach(e=>y+=`          - ${e}\n`)}else if(c.entity)y+=`        entity: ${c.entity}\n`;if(c.content)y+=`        content: |\n          ${c.content.replace(/\n/g,'\n          ')}\n`;y+='\n'});return y}
function copyYAML(){navigator.clipboard.writeText(document.getElementById('yamlOutput').textContent).then(()=>showNotification('YAML copied')).catch(()=>showNotification('Failed','error'))}
function downloadYAML(){const b=new Blob([document.getElementById('yamlOutput').textContent],{type:'text/yaml'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='dashboard.yaml';a.click();URL.revokeObjectURL(u)}
function closeModal(id){document.getElementById(id).classList.remove('active')}
function showNotification(msg,type='success'){const n=document.getElementById('notification');n.textContent=msg;n.className=`notification ${type}`;n.style.display='block';setTimeout(()=>n.style.display='none',3000)}
function updateStatus(text){document.getElementById('statusText').textContent=text;setTimeout(()=>document.getElementById('statusText').textContent='Ready',2000)}
function updateCardCount(){document.getElementById('cardCount').textContent=`${cards.length} cards`}
function updateSelectedCount(){document.getElementById('selectedCount').textContent=selectedCards.length>0?`${selectedCards.length} selected`:'0 selected'}
function showSidebarTab(tab){document.querySelectorAll('.sidebar-tab').forEach(t=>t.classList.remove('active'));document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');document.getElementById('cardsTab').style.display=tab==='cards'?'block':'none';document.getElementById('searchTab').style.display=tab==='search'?'block':'none';document.getElementById('layersTab').style.display=tab==='layers'?'block':'none'}
function searchCards(){const q=document.getElementById('searchBox').value.toLowerCase();const results=cards.filter(c=>c.title.toLowerCase().includes(q)||c.entities?.some(e=>e.toLowerCase().includes(q))||c.entity?.toLowerCase().includes(q));const div=document.getElementById('searchResults');div.innerHTML=results.map(c=>`<div style="padding:10px;background:rgba(67,238,255,.1);border-radius:8px;margin:5px 0;cursor:pointer" onclick="selectCard(cards.find(x=>x.id===${c.id}))">${c.title} (${c.type})</div>`).join('')||'<p style="color:#666;text-align:center">No results</p>'}
function updateLayersList(){const div=document.getElementById('layersList');div.innerHTML=cards.slice().sort((a,b)=>(b.zIndex||0)-(a.zIndex||0)).map(c=>`<div style="padding:8px;background:rgba(67,238,255,.1);border-radius:6px;margin:5px 0;cursor:pointer;font-size:.85em" onclick="selectCard(cards.find(x=>x.id===${c.id}))">${c.title} - Z:${c.zIndex||0}</div>`).join('')}
function showDashboardManager(){updateDashboardList();document.getElementById('dashboardManagerModal').classList.add('active')}
function updateDashboardList(){const div=document.getElementById('dashboardList');div.innerHTML=dashboards.map(d=>`<div class="dashboard-item ${d.id===currentDashboardId?'active':''}" onclick="switchDashboard(${d.id})"><div class="dashboard-name">${d.name}</div><div class="dashboard-meta">${d.cards?.length||0} cards ‚Ä¢ ${new Date(d.created).toLocaleDateString()}</div></div>`).join('')}
function createNewDashboard(){const name=prompt('Dashboard name:','New Dashboard');if(!name)return;const newDash={id:Date.now(),name,cards:[],bg:{...bgSettings},created:Date.now()};dashboards.push(newDash);switchDashboard(newDash.id);showNotification('Dashboard created');updateDashboardList()}
function switchDashboard(id){const dash=dashboards.find(d=>d.id===id);if(!dash)return;currentDashboardId=id;cards=dash.cards||[];bgSettings=dash.bg||bgSettings;document.getElementById('currentDashboard').textContent=dash.name;applyBackground();renderCanvas();updateCardCount();closeModal('dashboardManagerModal');showNotification(`Switched to ${dash.name}`)}
function showThemeMarketplace(){document.getElementById('themeModal').classList.add('active')}
function applyTheme(name){const t=themes[name];if(!t)return;bgSettings={type:'gradient',grad1:t.bg1,grad2:t.bg2,angle:135,imageUrl:'',solid:t.bg1,opacity:30,blur:0,overlay:50};cards.forEach(c=>{c.bgColor=t.card;c.titleColor=t.title;c.entityColor=t.entity});applyBackground();saveState();renderCanvas();closeModal('themeModal');showNotification(`Applied ${name} theme`)}
function applyBackground(){const bgLayer=document.querySelector('.bg-layer');const bgImage=document.getElementById('bgImage');const bgOverlay=document.getElementById('bgOverlay');if(bgSettings.type==='gradient'){bgLayer.style.background=`linear-gradient(${bgSettings.angle}deg,${bgSettings.grad1},${bgSettings.grad2})`;bgImage.style.backgroundImage='none'}else if(bgSettings.type==='image'){bgLayer.style.background='#000';bgImage.style.backgroundImage=`url(${bgSettings.imageUrl})`;bgImage.style.opacity=bgSettings.opacity/100;bgImage.style.filter=`blur(${bgSettings.blur}px)`}else{bgLayer.style.background=bgSettings.solid;bgImage.style.backgroundImage='none'}bgOverlay.style.background=`rgba(0,0,0,${bgSettings.overlay/100})`}
function showGallery(){document.getElementById('galleryModal').classList.add('active')}
function cloneGalleryDashboard(type){const templates={
'smart-home':[{type:'entities',title:'Living Room',x:50,y:50,entities:['light.living','switch.tv','climate.living']},{type:'weather',title:'Weather',x:400,y:50,entity:'weather.home'},{type:'camera',title:'Front Door',x:50,y:300,entity:'camera.front'},{type:'gauge',title:'Temperature',x:500,y:300,entity:'sensor.temp',min:0,max:100}],
'minimalist':[{type:'glance',title:'Quick View',x:50,y:50,entities:['light.main','switch.fan','sensor.temp']},{type:'clock',title:'Time',x:450,y:50,format:'24'}],
'energy':[{type:'gauge',title:'Power',x:50,y:50,entity:'sensor.power',min:0,max:5000},{type:'chart',title:'Usage',x:350,y:50,entity:'sensor.power',chartType:'line'},{type:'entities',title:'Devices',x:50,y:400,entities:['switch.washer','switch.dryer','switch.hvac']}],
'security':[{type:'camera',title:'Front',x:50,y:50,entity:'camera.front'},{type:'camera',title:'Back',x:500,y:50,entity:'camera.back'},{type:'entities',title:'Sensors',x:50,y:400,entities:['binary_sensor.door','binary_sensor.motion','binary_sensor.window']}]
};const tpl=templates[type];if(tpl){cards.push(...tpl.map(t=>({...t,id:cardIdCounter++,width:cardTypeConfigs[t.type].defaultSize.width,height:cardTypeConfigs[t.type].defaultSize.height,bgColor:'#43eeff',titleColor:'#ff43ee',entityColor:'#ffeb3b',useGradient:false,gradientColor1:'#43eeff',gradientColor2:'#ff43ee',zIndex:cards.length,animation:animationType})));saveState();renderCanvas();closeModal('galleryModal');showNotification('Dashboard cloned from gallery')}}
function showTemplateLibrary(){document.getElementById('templateModal').classList.add('active')}
function applyTemplate(name){const templates={living:[{type:'entities',title:'Living Room Lights',x:50,y:50,entities:['light.living_room','light.lamp','switch.tv']},{type:'media',title:'TV',x:400,y:50,entity:'media_player.tv'},{type:'thermostat',title:'Climate',x:50,y:300,entity:'climate.living'}],kitchen:[{type:'entities',title:'Kitchen',x:50,y:50,entities:['light.kitchen','light.counter','switch.coffee']},{type:'button',title:'Coffee',x:400,y:50,entity:'switch.coffee_maker'}],bedroom:[{type:'entities',title:'Bedroom',x:50,y:50,entities:['light.bedroom','switch.fan']},{type:'thermostat',title:'Climate',x:400,y:50,entity:'climate.bedroom'},{type:'clock',title:'Clock',x:50,y:350,format:'12'}],security:[{type:'camera',title:'Front Door',x:50,y:50,entity:'camera.front'},{type:'entities',title:'Sensors',x:500,y:50,entities:['binary_sensor.door','binary_sensor.motion','binary_sensor.window']}],energy:[{type:'gauge',title:'Power',x:50,y:50,entity:'sensor.power',min:0,max:5000},{type:'chart',title:'Usage',x:350,y:50,entity:'sensor.power',chartType:'line'}],outdoor:[{type:'weather',title:'Weather',x:50,y:50,entity:'weather.home'},{type:'entities',title:'Garden',x:450,y:50,entities:['switch.sprinkler','light.porch','sensor.soil']}]};const tpl=templates[name];if(tpl){cards.push(...tpl.map(t=>({...t,id:cardIdCounter++,width:cardTypeConfigs[t.type].defaultSize.width,height:cardTypeConfigs[t.type].defaultSize.height,bgColor:'#43eeff',titleColor:'#ff43ee',entityColor:'#ffeb3b',useGradient:false,gradientColor1:'#43eeff',gradientColor2:'#ff43ee',zIndex:cards.length,animation:animationType})));saveState();renderCanvas();closeModal('templateModal');showNotification('Template applied')}}
function showImportModal(){document.getElementById('importModal').classList.add('active')}
function importYAML(){const yaml=document.getElementById('importYaml').value;try{const lines=yaml.split('\n');let currentCard=null;lines.forEach(line=>{const trimmed=line.trim();if(trimmed.startsWith('- type:')){if(currentCard)cards.push(currentCard);const type=trimmed.split(':')[1].trim();currentCard={id:cardIdCounter++,type,x:50+cards.length*30,y:50+cards.length*30,width:cardTypeConfigs[type]?.defaultSize.width||300,height:cardTypeConfigs[type]?.defaultSize.height||200,bgColor:'#43eeff',titleColor:'#ff43ee',entityColor:'#ffeb3b',zIndex:cards.length,animation:animationType,entities:[]}}else if(trimmed.startsWith('title:')&&currentCard){currentCard.title=trimmed.split(':')[1].trim().replace(/"/g,'')}else if(trimmed.startsWith('entity:')&&currentCard){currentCard.entity=trimmed.split(':')[1].trim()}else if(trimmed.startsWith('- ')&&currentCard&&currentCard.entities){currentCard.entities.push(trimmed.substring(2).trim())}});if(currentCard)cards.push(currentCard);saveState();renderCanvas();closeModal('importModal');showNotification(`Imported ${cards.length} cards`)}catch(e){showNotification('Invalid YAML','error')}}
function showVersionHistory(){updateVersionList();document.getElementById('versionHistoryModal').classList.add('active')}
function updateVersionList(){const div=document.getElementById('versionList');div.innerHTML=versionHistory.slice().reverse().map((v,i)=>`<div class="version-item" onclick="restoreVersion(${versionHistory.length-1-i})"><div class="version-time">${new Date(v.time).toLocaleString()}</div><div class="version-cards">${v.cardCount} cards</div></div>`).join('')||'<p style="color:#666;text-align:center">No history</p>'}
function restoreVersion(idx){if(!confirm('Restore this version?'))return;const v=versionHistory[idx];cards=JSON.parse(JSON.stringify(v.cards));saveState();renderCanvas();closeModal('versionHistoryModal');showNotification('Version restored')}
function showShortcuts(){document.getElementById('shortcutsModal').classList.add('active')}
function showCloudSave(){updateCloudDashboardList();document.getElementById('cloudSaveModal').classList.add('active')}
function saveToCloud(){const name=document.getElementById('cloudDashboardName').value||'Untitled';const cloudData={name,cards:JSON.parse(JSON.stringify(cards)),bg:JSON.parse(JSON.stringify(bgSettings)),saved:Date.now()};cloudDashboards.push(cloudData);localStorage.setItem('ha_cloud_dashboards',JSON.stringify(cloudDashboards));updateCloudDashboardList();showNotification('Saved to cloud');document.getElementById('cloudDashboardName').value=''}
function updateCloudDashboardList(){cloudDashboards=JSON.parse(localStorage.getItem('ha_cloud_dashboards')||'[]');const div=document.getElementById('cloudDashboardList');div.innerHTML=cloudDashboards.map((d,i)=>`<div class="dashboard-item" onclick="loadFromCloud(${i})"><div class="dashboard-name">${d.name}</div><div class="dashboard-meta">${d.cards.length} cards ‚Ä¢ ${new Date(d.saved).toLocaleDateString()}</div></div>`).join('')||'<p style="color:#666;text-align:center;padding:20px">No cloud dashboards</p>'}
function loadFromCloud(idx){const d=cloudDashboards[idx];cards=JSON.parse(JSON.stringify(d.cards));bgSettings=JSON.parse(JSON.stringify(d.bg));cardIdCounter=Math.max(...cards.map(c=>c.id),0)+1;applyBackground();saveState();renderCanvas();closeModal('cloudSaveModal');showNotification('Loaded from cloud')}
if(autoSave){autoSaveInterval=setInterval(()=>{saveState()},60000)}
applyBackground();renderCanvas();updateCardCount();updateSelectedCount();
</script>
</body>
</html>
