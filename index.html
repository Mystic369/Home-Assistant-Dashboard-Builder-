<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HA Dashboard Builder v4.3 MEGA</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Open+Sans:wght@400;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;600;700&family=Poppins:wght@400;600;700&family=Inter:wght@400;600;700&family=Nunito:wght@400;700&family=Raleway:wght@400;600;700&family=Ubuntu:wght@400;500;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',sans-serif;color:#fff;overflow:hidden;height:100vh;position:relative}
.bg-layer{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;background:linear-gradient(135deg,#0f0f1e 0%,#1a1a2e 100%);transition:all .5s}.bg-image{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;opacity:.3;transition:all .5s}.bg-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);transition:all .5s}
.app-container{display:grid;grid-template-columns:380px 1fr 380px;grid-template-rows:70px 50px 1fr 40px;height:100vh;position:relative}.header{grid-column:1/-1;background:rgba(20,20,40,.95);backdrop-filter:blur(10px);border-bottom:2px solid rgba(67,238,255,.4);padding:0 30px;display:flex;align-items:center;justify-content:space-between;z-index:300}
.logo{font-size:1.6em;font-weight:700;background:linear-gradient(135deg,#43eeff,#ff43ee);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;cursor:pointer}.version{font-size:.7em;color:#666;margin-left:10px}.badge{background:linear-gradient(135deg,#ff43ee,#43eeff);padding:2px 8px;border-radius:4px;font-size:.6em;color:#000;margin-left:8px;font-weight:800}
.header-center{display:flex;gap:10px;align-items:center}.dashboard-selector{padding:8px 16px;background:rgba(67,238,255,.2);border:1px solid #43eeff;border-radius:6px;color:#43eeff;cursor:pointer;font-weight:600;font-size:.9em;min-width:200px;text-align:center}.dashboard-selector:hover{background:rgba(67,238,255,.3)}
.header-actions{display:flex;gap:8px;flex-wrap:wrap}.header-btn{padding:8px 14px;background:rgba(67,238,255,.15);border:1px solid #43eeff;border-radius:8px;color:#43eeff;cursor:pointer;font-weight:600;transition:all .3s;font-size:.85em;white-space:nowrap;position:relative}.header-btn:hover{background:rgba(67,238,255,.3);transform:translateY(-2px)}.header-btn.active{background:rgba(67,238,255,.4);border-color:#ff43ee}.header-btn.premium{background:linear-gradient(135deg,#ff43ee,#eb2fda);color:#fff;border:none}.header-btn.yaml-btn{background:linear-gradient(135deg,#4caf50,#45a049);color:#fff;border:none}
.header-btn::after{content:attr(data-tooltip);position:absolute;top:120%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.95);color:#fff;padding:6px 12px;border-radius:6px;font-size:.75em;white-space:nowrap;opacity:0;visibility:hidden;transition:all .2s;pointer-events:none;z-index:10000;border:1px solid #43eeff}.header-btn:hover::after{opacity:1;visibility:visible}.header-btn::before{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-bottom-color:rgba(0,0,0,.95);opacity:0;visibility:hidden;transition:all .2s;z-index:10000}.header-btn:hover::before{opacity:1;visibility:visible}
.tool-btn::after{content:attr(data-tooltip);position:absolute;top:120%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.95);color:#fff;padding:6px 12px;border-radius:6px;font-size:.75em;white-space:nowrap;opacity:0;visibility:hidden;transition:all .2s;pointer-events:none;z-index:10000;border:1px solid #43eeff}.tool-btn:hover::after{opacity:1;visibility:visible}.tool-btn::before{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-bottom-color:rgba(0,0,0,.95);opacity:0;visibility:hidden;transition:all .2s;z-index:10000}.tool-btn:hover::before{opacity:1;visibility:visible}
.card-type-btn::after{content:attr(data-tooltip);position:absolute;bottom:120%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.95);color:#fff;padding:6px 12px;border-radius:6px;font-size:.75em;white-space:nowrap;opacity:0;visibility:hidden;transition:all .2s;pointer-events:none;z-index:1000;border:1px solid #43eeff}.card-type-btn:hover::after{opacity:1;visibility:visible}.card-type-btn::before{content:'';position:absolute;bottom:110%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:rgba(0,0,0,.95);opacity:0;visibility:hidden;transition:all .2s}.card-type-btn:hover::before{opacity:1;visibility:visible}
.toolbar{grid-column:1/-1;background:rgba(15,15,30,.9);border-bottom:1px solid rgba(67,238,255,.2);padding:8px 20px;display:flex;gap:12px;align-items:center;overflow-x:auto;overflow-y:visible;position:relative;z-index:200}.tool-group{display:flex;gap:6px;padding-right:12px;border-right:1px solid rgba(67,238,255,.2)}.tool-btn{padding:6px 12px;background:rgba(67,238,255,.1);border:1px solid rgba(67,238,255,.3);border-radius:6px;color:#43eeff;cursor:pointer;font-size:.8em;transition:all .2s;white-space:nowrap;position:relative;z-index:201}.tool-btn:hover{background:rgba(67,238,255,.25)}.tool-btn.active{background:rgba(255,67,238,.2);border-color:#ff43ee;color:#ff43ee}
.sidebar{background:rgba(20,20,40,.85);backdrop-filter:blur(10px);border-right:1px solid rgba(67,238,255,.2);padding:20px;overflow-y:auto;z-index:1}.sidebar h2{color:#ff43ee;margin-bottom:15px;font-size:1.2em}.sidebar-tabs{display:flex;gap:8px;margin-bottom:15px}.sidebar-tab{padding:8px 16px;background:rgba(67,238,255,.1);border:none;border-radius:6px;color:#43eeff;cursor:pointer;font-size:.85em;flex:1;text-align:center}.sidebar-tab.active{background:rgba(67,238,255,.25);border:1px solid #ff43ee}
.canvas-container{background:transparent;position:relative;overflow:auto;z-index:1}.canvas{min-height:100%;min-width:100%;background-image:repeating-linear-gradient(0deg,rgba(67,238,255,.05) 0px,transparent 1px,transparent 50px,rgba(67,238,255,.05) 51px),repeating-linear-gradient(90deg,rgba(67,238,255,.05) 0px,transparent 1px,transparent 50px,rgba(67,238,255,.05) 51px);background-size:50px 50px;position:relative;padding:40px;transition:all .3s}.canvas.mobile-preview{max-width:375px;margin:0 auto;background:rgba(0,0,0,.1);border:2px solid rgba(67,238,255,.3);border-radius:20px}.canvas.tablet-preview{max-width:768px;margin:0 auto;background:rgba(0,0,0,.1);border:2px solid rgba(67,238,255,.3);border-radius:12px}
.canvas-card{position:absolute;background:#43eeff;border-radius:14px;padding:18px;cursor:move;box-shadow:0 4px 20px rgba(67,238,255,.5);min-width:150px;min-height:100px;transition:all .3s;overflow:hidden}.canvas-card.locked{cursor:not-allowed;opacity:.9}.canvas-card.locked::after{content:'ğŸ”’';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2em;opacity:.3;pointer-events:none}
.canvas-card.anim-fade{animation:fadeIn .5s}.canvas-card.anim-slide{animation:slideIn .5s}.canvas-card.anim-bounce{animation:bounceIn .6s}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}@keyframes bounceIn{0%{opacity:0;transform:scale(.3)}50%{opacity:1;transform:scale(1.05)}70%{transform:scale(.9)}100%{transform:scale(1)}}
/* Hover effects */
.canvas-card.hover-scale:hover{transform:scale(1.05)}.canvas-card.hover-glow:hover{box-shadow:0 0 30px rgba(67,238,255,.8),0 0 60px rgba(67,238,255,.4)}.canvas-card.hover-lift:hover{transform:translateY(-8px);box-shadow:0 12px 40px rgba(0,0,0,.4)}.canvas-card.hover-border:hover{border:3px solid #fff}
.canvas-card:hover{box-shadow:0 8px 35px rgba(67,238,255,.7)}.canvas-card.selected{border:3px solid #ff43ee;box-shadow:0 0 0 4px rgba(255,67,238,.3)}.canvas-card.multi-selected{border:3px solid #ffeb3b;box-shadow:0 0 0 4px rgba(255,235,59,.3)}.canvas-card.drag-over{border:3px dashed #ffeb3b;background:rgba(255,235,59,.1)}
/* Alignment guides */
.align-guide{position:absolute;background:#ff43ee;z-index:1000;pointer-events:none;opacity:.8}.align-guide.vertical{width:2px;height:100%}.align-guide.horizontal{height:2px;width:100%}
.card-type-badge{position:absolute;top:8px;left:8px;background:rgba(0,0,0,.7);padding:4px 10px;border-radius:6px;font-size:.7em;color:#fff;font-weight:700;text-transform:uppercase;z-index:5}.card-size-badge{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.7);padding:4px 10px;border-radius:6px;font-size:.7em;color:#fff;z-index:5}.card-z-badge{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.7);padding:4px 8px;border-radius:6px;font-size:.65em;color:#fff;z-index:5}.card-group-badge{position:absolute;bottom:8px;left:8px;background:rgba(255,67,238,.8);padding:4px 8px;border-radius:6px;font-size:.65em;color:#fff;z-index:5;font-weight:700}
.card-icon{font-size:1.5em;margin-right:8px}.card-title-display{color:#ff43ee;font-weight:600;margin-bottom:12px;margin-top:20px;display:flex;align-items:center}.card-entity-display{margin:6px 0;padding:6px 10px;background:rgba(255,255,255,.25);border-radius:6px;color:#ffeb3b;cursor:grab;position:relative;transition:all .2s}.card-entity-display:hover{background:rgba(255,255,255,.35);transform:translateX(5px)}
.resize-handle{position:absolute;width:14px;height:14px;background:#ff43ee;border:2px solid #fff;border-radius:50%;display:none;z-index:10}.canvas-card.selected .resize-handle,.canvas-card.multi-selected .resize-handle{display:block}.resize-se{bottom:-7px;right:-7px;cursor:se-resize}.resize-sw{bottom:-7px;left:-7px;cursor:sw-resize}.resize-ne{top:-7px;right:-7px;cursor:ne-resize}.resize-nw{top:-7px;left:-7px;cursor:nw-resize}
.form-group{margin-bottom:15px}label{display:block;color:#a5b4fc;margin-bottom:5px;font-size:.85em;font-weight:500}input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(67,238,255,.3);background:rgba(10,10,20,.9);color:#fff;font-size:.9em}select{cursor:pointer}textarea{resize:vertical;font-family:inherit}input[type=color]{height:45px;cursor:pointer}input[type=checkbox],input[type=radio]{width:auto;margin-right:8px}input[type=file]{padding:12px;border:2px dashed rgba(67,238,255,.5);background:rgba(67,238,255,.05);cursor:pointer}
.btn{width:100%;padding:12px;background:linear-gradient(135deg,#43eeff,#2fdaeb);border:none;border-radius:8px;color:#0a0a15;font-weight:600;cursor:pointer;transition:all .3s;margin:5px 0;font-size:.9em}.btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(67,238,255,.6)}.btn-secondary{background:linear-gradient(135deg,#ff43ee,#eb2fda)}.btn-danger{background:linear-gradient(135deg,#f44,#c00);color:#fff}.btn-success{background:linear-gradient(135deg,#4caf50,#45a049);color:#fff}.btn-small{padding:8px;font-size:.8em}.btn-half{width:48%;display:inline-block}
.checkbox-label{display:flex;align-items:center;padding:10px;background:rgba(67,238,255,.1);border-radius:8px;cursor:pointer;transition:background .2s}.checkbox-label:hover{background:rgba(67,238,255,.2)}
.properties-panel{background:rgba(20,20,40,.85);backdrop-filter:blur(10px);border-left:1px solid rgba(67,238,255,.2);padding:20px;overflow-y:auto;z-index:1}.no-selection{text-align:center;color:#666;padding:50px 15px}.no-selection-icon{font-size:3.5em;margin-bottom:12px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:1000;align-items:center;justify-content:center}.modal.active{display:flex}.modal-content{background:rgba(20,20,40,.98);border:2px solid #43eeff;border-radius:16px;padding:30px;max-width:900px;width:90%;max-height:85vh;overflow-y:auto}.modal h2{color:#ff43ee;margin-bottom:20px;font-size:1.6em}
.yaml-output{background:#0a0a15;border:1px solid rgba(67,238,255,.4);border-radius:10px;padding:18px;font-family:'Courier New',monospace;color:#43eeff;white-space:pre-wrap;max-height:450px;overflow-y:auto;font-size:.85em;line-height:1.5}
.card-type-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px}.card-type-btn{padding:12px;background:rgba(67,238,255,.08);border:2px solid rgba(67,238,255,.3);border-radius:10px;color:#43eeff;cursor:pointer;text-align:center;transition:all .25s;font-weight:500;font-size:.8em;position:relative}.card-type-btn:hover{background:rgba(67,238,255,.18);border-color:#43eeff;transform:scale(1.03)}.card-type-btn.active{background:rgba(67,238,255,.25);border-color:#ff43ee;color:#ff43ee}.card-type-icon{font-size:1.3em;display:block;margin-bottom:5px}
.divider{height:1px;background:rgba(67,238,255,.2);margin:15px 0}.prop-section{margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid rgba(67,238,255,.15)}.prop-section h3{color:#ff43ee;margin-bottom:12px;font-size:1em}
.template-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}.template-card{padding:18px;background:rgba(67,238,255,.08);border:2px solid rgba(67,238,255,.3);border-radius:12px;cursor:pointer;transition:all .3s;text-align:center}.template-card:hover{background:rgba(67,238,255,.15);transform:translateY(-3px);border-color:#43eeff}.template-icon{font-size:2.5em;margin-bottom:8px}.template-title{font-weight:600;color:#43eeff;margin-bottom:4px;font-size:.9em}.template-desc{font-size:.75em;color:#999}
.theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}.theme-card{padding:15px;border-radius:10px;cursor:pointer;transition:all .3s;border:2px solid transparent;text-align:center}.theme-card:hover{transform:scale(1.05);border-color:#43eeff}.theme-name{font-size:.85em;margin-top:8px;font-weight:600}
.dashboard-list{display:grid;gap:10px;max-height:400px;overflow-y:auto}.dashboard-item{padding:15px;background:rgba(67,238,255,.08);border:2px solid rgba(67,238,255,.3);border-radius:10px;cursor:pointer;transition:all .2s}.dashboard-item:hover{background:rgba(67,238,255,.15);border-color:#43eeff}.dashboard-item.active{border-color:#ff43ee;background:rgba(255,67,238,.15)}.dashboard-name{font-weight:600;color:#43eeff;margin-bottom:5px}.dashboard-meta{font-size:.75em;color:#999}
.search-box{width:100%;padding:10px;background:rgba(10,10,20,.9);border:1px solid rgba(67,238,255,.3);border-radius:8px;color:#fff;margin-bottom:15px;font-size:.9em}.search-box:focus{outline:none;border-color:#43eeff}
.status-bar{grid-column:1/-1;background:rgba(15,15,30,.95);border-top:1px solid rgba(67,238,255,.2);padding:8px 20px;display:flex;justify-content:space-between;align-items:center;font-size:.75em;color:#999}.status-item{display:flex;align-items:center;gap:8px}.status-dot{width:8px;height:8px;border-radius:50%;background:#4caf50;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.context-menu{position:fixed;background:rgba(20,20,40,.98);border:2px solid #43eeff;border-radius:8px;padding:6px;min-width:160px;z-index:10000;box-shadow:0 4px 20px rgba(0,0,0,.5);display:none}.context-menu.active{display:block}.context-menu-item{padding:10px 14px;color:#43eeff;cursor:pointer;border-radius:4px;transition:all .2s;font-size:.85em}.context-menu-item:hover{background:rgba(67,238,255,.2)}
.shortcuts-panel{background:#0a0a15;border:1px solid rgba(67,238,255,.4);border-radius:10px;padding:15px;max-height:400px;overflow-y:auto}.shortcut-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid rgba(67,238,255,.1);font-size:.85em}.shortcut-key{background:rgba(67,238,255,.2);padding:4px 8px;border-radius:4px;font-family:monospace;color:#43eeff;font-size:.8em}
.notification{position:fixed;top:80px;right:20px;background:linear-gradient(135deg,#43eeff,#2fdaeb);color:#000;padding:15px 20px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.5);z-index:10001;animation:slideInRight .3s;font-weight:600;min-width:250px}@keyframes slideInRight{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}.notification.error{background:linear-gradient(135deg,#f44,#c00);color:#fff}.notification.success{background:linear-gradient(135deg,#4caf50,#45a049);color:#fff}
.version-item{padding:12px;background:rgba(67,238,255,.08);border:1px solid rgba(67,238,255,.3);border-radius:8px;margin-bottom:10px;cursor:pointer;transition:all .2s}.version-item:hover{background:rgba(67,238,255,.15)}.version-time{font-size:.75em;color:#999;margin-bottom:5px}.version-cards{color:#43eeff;font-size:.85em}
.gallery-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;max-height:500px;overflow-y:auto}.gallery-item{background:rgba(67,238,255,.08);border:2px solid rgba(67,238,255,.3);border-radius:12px;overflow:hidden;cursor:pointer;transition:all .3s}.gallery-item:hover{transform:translateY(-5px);border-color:#43eeff;box-shadow:0 8px 25px rgba(67,238,255,.3)}.gallery-preview{width:100%;height:150px;background:linear-gradient(135deg,#1a1a2e,#0f0f1e);display:flex;align-items:center;justify-content:center;font-size:3em;color:rgba(67,238,255,.3)}.gallery-info{padding:12px}.gallery-title{font-weight:600;color:#43eeff;margin-bottom:5px;font-size:.9em}.gallery-author{font-size:.75em;color:#999;margin-bottom:8px}.gallery-stats{display:flex;gap:15px;font-size:.75em;color:#666}.gallery-stat{display:flex;align-items:center;gap:4px}
.shadow-preview{padding:10px;background:rgba(0,0,0,.3);border-radius:8px;margin-top:8px;text-align:center;font-size:1.1em}
.bg-type-selector{display:flex;gap:8px;margin-bottom:15px}.bg-type-btn{flex:1;padding:10px;background:rgba(67,238,255,.1);border:1px solid rgba(67,238,255,.3);border-radius:6px;color:#43eeff;cursor:pointer;text-align:center;font-size:.8em;transition:all .2s}.bg-type-btn:hover{background:rgba(67,238,255,.2)}.bg-type-btn.active{background:rgba(67,238,255,.3);border-color:#ff43ee}
.image-preview{width:100%;height:120px;background:#1a1a2e;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-top:10px;background-size:cover;background-position:center;color:#666;font-size:.85em;border:2px dashed rgba(67,238,255,.3)}
.import-options{background:rgba(67,238,255,.1);border-radius:8px;padding:15px;margin:15px 0}.import-options label{color:#43eeff;margin-bottom:10px;display:block}.import-option{display:flex;align-items:center;padding:8px;margin:5px 0;background:rgba(0,0,0,.2);border-radius:6px;cursor:pointer}.import-option:hover{background:rgba(67,238,255,.15)}.import-option input{margin-right:10px}
/* Icon picker */
.icon-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;max-height:300px;overflow-y:auto;padding:10px;background:rgba(0,0,0,.3);border-radius:8px;margin-top:10px}.icon-item{padding:10px;text-align:center;cursor:pointer;border-radius:6px;transition:all .2s;font-size:1.5em}.icon-item:hover{background:rgba(67,238,255,.3)}.icon-item.selected{background:rgba(255,67,238,.3);border:2px solid #ff43ee}
/* Style presets */
.preset-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}.preset-item{padding:12px;background:rgba(67,238,255,.1);border:2px solid rgba(67,238,255,.3);border-radius:8px;cursor:pointer;transition:all .2s}.preset-item:hover{background:rgba(67,238,255,.2);border-color:#43eeff}.preset-name{font-weight:600;color:#43eeff;margin-bottom:5px}.preset-preview{display:flex;gap:5px}.preset-color{width:20px;height:20px;border-radius:4px}
/* Tap action builder */
.action-builder{background:rgba(0,0,0,.2);border-radius:8px;padding:15px;margin-top:10px}.action-row{display:flex;gap:10px;margin-bottom:10px;align-items:center}.action-row select,.action-row input{flex:1}
/* Lovelace toggle */
.lovelace-toggle{display:flex;gap:10px;margin-bottom:15px}.lovelace-btn{flex:1;padding:10px;background:rgba(67,238,255,.1);border:1px solid rgba(67,238,255,.3);border-radius:6px;color:#43eeff;cursor:pointer;text-align:center}.lovelace-btn.active{background:rgba(67,238,255,.3);border-color:#ff43ee}
/* Share modal */
.share-url{width:100%;padding:12px;background:#0a0a15;border:1px solid rgba(67,238,255,.4);border-radius:8px;color:#43eeff;font-family:monospace;font-size:.75em;word-break:break-all;margin:15px 0}
</style>
</head>
<body>
<div class="bg-layer"><div class="bg-image" id="bgImage"></div><div class="bg-overlay" id="bgOverlay"></div></div>
<div class="app-container">
<div class="header">
<div class="logo" onclick="showDashboardManager()">ğŸ¨ HA Dashboard Builder<span class="version">v4.3</span><span class="badge">MEGA</span></div>
<div class="header-center"><div class="dashboard-selector" onclick="showDashboardManager()" id="currentDashboard">My Dashboard</div></div>
<div class="header-actions">
<button class="header-btn yaml-btn" onclick="downloadYAMLDirect()" data-tooltip="Download YAML">ğŸ“„ YAML</button>
<button class="header-btn" onclick="showBackgroundSettings()" data-tooltip="Background settings">ğŸ–¼ï¸ BG</button>
<button class="header-btn" onclick="showThemeMarketplace()" data-tooltip="Themes">ğŸ¨</button>
<button class="header-btn" onclick="showGallery()" data-tooltip="Gallery">ğŸ–¼ï¸</button>
<button class="header-btn" onclick="showTemplateLibrary()" data-tooltip="Templates">â­</button>
<button class="header-btn" onclick="showImportModal()" data-tooltip="Import YAML">ğŸ“¥</button>
<button class="header-btn" onclick="showStylePresets()" data-tooltip="Style presets">ğŸ­</button>
<button class="header-btn" onclick="showShareModal()" data-tooltip="Share dashboard">ğŸ”—</button>
<button class="header-btn" onclick="exportAsPNG()" data-tooltip="Export as PNG">ğŸ“¸</button>
<button class="header-btn premium" onclick="showCloudSave()" data-tooltip="Cloud save">â˜ï¸</button>
</div>
</div>
<div class="toolbar">
<div class="tool-group">
<button class="tool-btn active" onclick="setPreviewMode('desktop')" id="previewDesktop" data-tooltip="Desktop">ğŸ–¥ï¸</button>
<button class="tool-btn" onclick="setPreviewMode('tablet')" id="previewTablet" data-tooltip="Tablet">ğŸ“±</button>
<button class="tool-btn" onclick="setPreviewMode('mobile')" id="previewMobile" data-tooltip="Mobile">ğŸ“±</button>
</div>
<div class="tool-group">
<button class="tool-btn" onclick="selectAll()" data-tooltip="Select all">All</button>
<button class="tool-btn" onclick="deselectAll()" data-tooltip="Deselect">None</button>
<button class="tool-btn" onclick="groupSelected()" data-tooltip="Group">ğŸ“¦</button>
<button class="tool-btn" onclick="ungroupSelected()" data-tooltip="Ungroup">ğŸ“‚</button>
</div>
<div class="tool-group">
<button class="tool-btn" onclick="toggleLockSelected()" id="lockBtn" data-tooltip="Lock/unlock cards">ğŸ”’</button>
<button class="tool-btn" onclick="copyStyle()" data-tooltip="Copy style">ğŸ¨ğŸ“‹</button>
<button class="tool-btn" onclick="pasteStyle()" data-tooltip="Paste style">ğŸ¨ğŸ“¥</button>
</div>
<div class="tool-group">
<button class="tool-btn" onclick="alignCards('left')" data-tooltip="Align left">â¬…ï¸</button>
<button class="tool-btn" onclick="alignCards('center')" data-tooltip="Align center">â¬›</button>
<button class="tool-btn" onclick="alignCards('right')" data-tooltip="Align right">â¡ï¸</button>
<button class="tool-btn" onclick="autoGridLayout()" data-tooltip="Auto-grid">ğŸ“</button>
</div>
<div class="tool-group">
<button class="tool-btn" onclick="changeZIndex('up')" data-tooltip="Bring forward">â¬†ï¸</button>
<button class="tool-btn" onclick="changeZIndex('down')" data-tooltip="Send back">â¬‡ï¸</button>
</div>
<div class="tool-group">
<button class="tool-btn" onclick="toggleGridSnap()" id="gridSnapBtn" data-tooltip="Grid snap">ğŸ§²</button>
<button class="tool-btn" onclick="toggleAlignGuides()" id="guidesBtn" data-tooltip="Align guides">ğŸ“</button>
<button class="tool-btn" onclick="undo()" data-tooltip="Undo">â†¶</button>
<button class="tool-btn" onclick="redo()" data-tooltip="Redo">â†·</button>
</div>
</div>
<div class="sidebar">
<div class="sidebar-tabs">
<button class="sidebar-tab active" onclick="showSidebarTab('cards')" id="tabCards">Cards</button>
<button class="sidebar-tab" onclick="showSidebarTab('search')" id="tabSearch">Search</button>
<button class="sidebar-tab" onclick="showSidebarTab('layers')" id="tabLayers">Layers</button>
</div>
<div id="sidebarContent">
<div id="cardsTab">
<h2>â• Add Card</h2>
<div class="card-type-selector">
<div class="card-type-btn active" onclick="selectCardType('entities')" data-tooltip="Entity list"><span class="card-type-icon">ğŸ“‹</span>Entities</div>
<div class="card-type-btn" onclick="selectCardType('thermostat')" data-tooltip="Climate"><span class="card-type-icon">ğŸŒ¡ï¸</span>Thermo</div>
<div class="card-type-btn" onclick="selectCardType('weather')" data-tooltip="Weather"><span class="card-type-icon">ğŸŒ¤ï¸</span>Weather</div>
<div class="card-type-btn" onclick="selectCardType('camera')" data-tooltip="Camera"><span class="card-type-icon">ğŸ“·</span>Camera</div>
<div class="card-type-btn" onclick="selectCardType('media')" data-tooltip="Media"><span class="card-type-icon">ğŸµ</span>Media</div>
<div class="card-type-btn" onclick="selectCardType('gauge')" data-tooltip="Gauge"><span class="card-type-icon">â±ï¸</span>Gauge</div>
<div class="card-type-btn" onclick="selectCardType('button')" data-tooltip="Button"><span class="card-type-icon">ğŸ”˜</span>Button</div>
<div class="card-type-btn" onclick="selectCardType('clock')" data-tooltip="Clock"><span class="card-type-icon">ğŸ•</span>Clock</div>
<div class="card-type-btn" onclick="selectCardType('markdown')" data-tooltip="Markdown"><span class="card-type-icon">ğŸ“</span>Markdown</div>
<div class="card-type-btn" onclick="selectCardType('picture')" data-tooltip="Picture"><span class="card-type-icon">ğŸ–¼ï¸</span>Picture</div>
<div class="card-type-btn" onclick="selectCardType('glance')" data-tooltip="Glance"><span class="card-type-icon">ğŸ‘ï¸</span>Glance</div>
<div class="card-type-btn" onclick="selectCardType('chart')" data-tooltip="Chart"><span class="card-type-icon">ğŸ“Š</span>Chart</div>
<div class="card-type-btn" onclick="selectCardType('map')" data-tooltip="Map"><span class="card-type-icon">ğŸ—ºï¸</span>Map</div>
<div class="card-type-btn" onclick="selectCardType('iframe')" data-tooltip="Iframe"><span class="card-type-icon">ğŸŒ</span>Iframe</div>
<div class="card-type-btn" onclick="selectCardType('light')" data-tooltip="Light"><span class="card-type-icon">ğŸ’¡</span>Light</div>
</div>
<div class="divider"></div>
<div id="cardConfig"></div>
<button class="btn" onclick="addCardToCanvas()">â• Add to Canvas</button>
</div>
<div id="searchTab" style="display:none">
<h2>ğŸ” Search</h2>
<input type="text" class="search-box" id="searchBox" placeholder="Search cards..." oninput="searchCards()">
<div id="searchResults"></div>
</div>
<div id="layersTab" style="display:none">
<h2>ğŸ“š Layers</h2>
<div id="layersList"></div>
</div>
</div>
</div>
<div class="canvas-container"><div class="canvas" id="canvas"></div></div>
<div class="properties-panel" id="propertiesPanel">
<div class="no-selection"><div class="no-selection-icon">ğŸ‘†</div><p>Click a card to edit</p></div>
</div>
<div class="status-bar">
<div class="status-item"><span class="status-dot"></span><span id="statusText">Ready</span></div>
<div class="status-item"><span id="cardCount">0 cards</span></div>
<div class="status-item"><span id="selectedCount">0 selected</span></div>
<div class="status-item"><span id="autoSaveStatus">Auto-save: ON</span></div>
</div>
</div>

<!-- All Modals -->
<div class="modal" id="backgroundModal"><div class="modal-content">
<h2>ğŸ–¼ï¸ Background Settings</h2>
<div class="bg-type-selector">
<button class="bg-type-btn active" onclick="setBgType('gradient')" id="bgTypeGradient">Gradient</button>
<button class="bg-type-btn" onclick="setBgType('solid')" id="bgTypeSolid">Solid</button>
<button class="bg-type-btn" onclick="setBgType('image')" id="bgTypeImage">Image</button>
</div>
<div id="bgGradientSettings">
<div class="form-group"><label>Color 1</label><input type="color" id="bgGrad1" value="#0f0f1e" onchange="updateBgSettings()"></div>
<div class="form-group"><label>Color 2</label><input type="color" id="bgGrad2" value="#1a1a2e" onchange="updateBgSettings()"></div>
<div class="form-group"><label>Angle: <span id="bgAngleVal">135</span>Â°</label><input type="range" id="bgAngle" min="0" max="360" value="135" oninput="updateBgSettings()"></div>
</div>
<div id="bgSolidSettings" style="display:none"><div class="form-group"><label>Color</label><input type="color" id="bgSolidColor" value="#1a1a2e" onchange="updateBgSettings()"></div></div>
<div id="bgImageSettings" style="display:none">
<div class="form-group"><label>URL</label><input type="text" id="bgImageUrl" placeholder="https://..." onchange="updateBgSettings()"></div>
<div class="form-group"><label>Upload</label><input type="file" id="bgImageUpload" accept="image/*" onchange="uploadBgImage(event)"></div>
<div class="image-preview" id="bgImagePreview">No image</div>
<div class="form-group"><label>Opacity: <span id="bgOpacityVal">30</span>%</label><input type="range" id="bgOpacity" min="0" max="100" value="30" oninput="updateBgSettings()"></div>
<div class="form-group"><label>Blur: <span id="bgBlurVal">0</span>px</label><input type="range" id="bgBlur" min="0" max="20" value="0" oninput="updateBgSettings()"></div>
</div>
<div class="form-group"><label>Overlay: <span id="bgOverlayVal">50</span>%</label><input type="range" id="bgOverlayAmount" min="0" max="100" value="50" oninput="updateBgSettings()"></div>
<button class="btn" onclick="closeModal('backgroundModal')">Apply</button>
</div></div>

<div class="modal" id="dashboardManagerModal"><div class="modal-content">
<h2>ğŸ“Š Dashboards</h2>
<button class="btn" onclick="createNewDashboard()">â• New Dashboard</button>
<div class="dashboard-list" id="dashboardList"></div>
<button class="btn btn-secondary" onclick="closeModal('dashboardManagerModal')">Close</button>
</div></div>

<div class="modal" id="themeModal"><div class="modal-content">
<h2>ğŸ¨ Themes</h2>
<div class="theme-grid">
<div class="theme-card" onclick="applyTheme('default')" style="background:linear-gradient(135deg,#0f0f1e,#1a1a2e)"><div style="padding:30px"></div><div class="theme-name">Default</div></div>
<div class="theme-card" onclick="applyTheme('light')" style="background:linear-gradient(135deg,#f5f5f5,#e0e0e0)"><div style="padding:30px"></div><div class="theme-name" style="color:#333">Light</div></div>
<div class="theme-card" onclick="applyTheme('neon')" style="background:linear-gradient(135deg,#ff006e,#8338ec)"><div style="padding:30px"></div><div class="theme-name">Neon</div></div>
<div class="theme-card" onclick="applyTheme('ocean')" style="background:linear-gradient(135deg,#006994,#003d5c)"><div style="padding:30px"></div><div class="theme-name">Ocean</div></div>
<div class="theme-card" onclick="applyTheme('forest')" style="background:linear-gradient(135deg,#1e4d2b,#0d2818)"><div style="padding:30px"></div><div class="theme-name">Forest</div></div>
<div class="theme-card" onclick="applyTheme('sunset')" style="background:linear-gradient(135deg,#ff6b35,#f7931e)"><div style="padding:30px"></div><div class="theme-name">Sunset</div></div>
<div class="theme-card" onclick="applyTheme('purple')" style="background:linear-gradient(135deg,#7209b7,#3a0ca3)"><div style="padding:30px"></div><div class="theme-name">Purple</div></div>
<div class="theme-card" onclick="applyTheme('minimal')" style="background:#1a1a1a"><div style="padding:30px"></div><div class="theme-name">Minimal</div></div>
<div class="theme-card" onclick="applyTheme('cyberpunk')" style="background:linear-gradient(135deg,#00ff9f,#00b8ff)"><div style="padding:30px"></div><div class="theme-name">Cyber</div></div>
</div>
<button class="btn" onclick="closeModal('themeModal');showThemeImport()" style="margin-top:15px">ğŸ“¥ Import HA Theme</button>
<button class="btn btn-secondary" onclick="closeModal('themeModal')">Close</button>
</div></div>

<div class="modal" id="themeImportModal"><div class="modal-content">
<h2>ğŸ“¥ Import Home Assistant Theme</h2>
<div class="sidebar-tabs" style="margin-bottom:15px">
<button class="sidebar-tab active" onclick="showThemeTab('presets')" id="themeTabPresets">Popular Themes</button>
<button class="sidebar-tab" onclick="showThemeTab('import')" id="themeTabImport">Import YAML</button>
<button class="sidebar-tab" onclick="showThemeTab('custom')" id="themeTabCustom">My Themes</button>
</div>

<div id="themePresetsTab">
<p style="color:#888;margin-bottom:15px">Click to apply popular Home Assistant themes</p>
<div class="theme-grid" id="haThemeGrid">
<div class="theme-card" onclick="applyHATheme('ios-dark')" style="background:linear-gradient(135deg,#1c1c1e,#2c2c2e)"><div style="padding:20px;display:flex;gap:5px;justify-content:center"><span style="width:12px;height:12px;border-radius:50%;background:#0a84ff"></span><span style="width:12px;height:12px;border-radius:50%;background:#30d158"></span><span style="width:12px;height:12px;border-radius:50%;background:#ff9f0a"></span></div><div class="theme-name">iOS Dark</div></div>
<div class="theme-card" onclick="applyHATheme('ios-light')" style="background:linear-gradient(135deg,#f2f2f7,#ffffff)"><div style="padding:20px;display:flex;gap:5px;justify-content:center"><span style="width:12px;height:12px;border-radius:50%;background:#007aff"></span><span style="width:12px;height:12px;border-radius:50%;background:#34c759"></span><span style="width:12px;height:12px;border-radius:50%;background:#ff9500"></span></div><div class="theme-name" style="color:#333">iOS Light</div></div>
<div class="theme-card" onclick="applyHATheme('mushroom')" style="background:linear-gradient(135deg,#1d1b26,#2d2b36)"><div style="padding:20px;display:flex;gap:5px;justify-content:center"><span style="width:12px;height:12px;border-radius:50%;background:#ff9800"></span><span style="width:12px;height:12px;border-radius:50%;background:#4caf50"></span><span style="width:12px;height:12px;border-radius:50%;background:#2196f3"></span></div><div class="theme-name">Mushroom</div></div>
<div class="theme-card" onclick="applyHATheme('google-home')" style="background:linear-gradient(135deg,#202124,#303134)"><div style="padding:20px;display:flex;gap:5px;justify-content:center"><span style="width:12px;height:12px;border-radius:50%;background:#8ab4f8"></span><span style="width:12px;height:12px;border-radius:50%;background:#81c995"></span><span style="width:12px;height:12px;border-radius:50%;background:#fdd663"></span></div><div class="theme-name">Google Dark</div></div>
<div class="theme-card" onclick="applyHATheme('slate')" style="background:linear-gradient(135deg,#1e293b,#334155)"><div style="padding:20px;display:flex;gap:5px;justify-content:center"><span style="width:12px;height:12px;border-radius:50%;background:#38bdf8"></span><span style="width:12px;height:12px;border-radius:50%;background:#a78bfa"></span><span style="width:12px;height:12px;border-radius:50%;background:#fb7185"></span></div><div class="theme-name">Slate</div></div>
<div class="theme-card" onclick="applyHATheme('noctis')" style="background:linear-gradient(135deg,#0f1318,#1b2838)"><div style="padding:20px;display:flex;gap:5px;justify-content:center"><span style="width:12px;height:12px;border-radius:50%;background:#49e9a6"></span><span style="width:12px;height:12px;border-radius:50%;background:#49ace9"></span><span style="width:12px;height:12px;border-radius:50%;background:#df8a3b"></span></div><div class="theme-name">Noctis</div></div>
<div class="theme-card" onclick="applyHATheme('caule-black')" style="background:#000"><div style="padding:20px;display:flex;gap:5px;justify-content:center"><span style="width:12px;height:12px;border-radius:50%;background:#03a9f4"></span><span style="width:12px;height:12px;border-radius:50%;background:#4caf50"></span><span style="width:12px;height:12px;border-radius:50%;background:#ff5722"></span></div><div class="theme-name">Caule Black</div></div>
<div class="theme-card" onclick="applyHATheme('midnight')" style="background:linear-gradient(135deg,#0d1117,#161b22)"><div style="padding:20px;display:flex;gap:5px;justify-content:center"><span style="width:12px;height:12px;border-radius:50%;background:#58a6ff"></span><span style="width:12px;height:12px;border-radius:50%;background:#3fb950"></span><span style="width:12px;height:12px;border-radius:50%;background:#f78166"></span></div><div class="theme-name">Midnight</div></div>
<div class="theme-card" onclick="applyHATheme('material-dark')" style="background:linear-gradient(135deg,#121212,#1e1e1e)"><div style="padding:20px;display:flex;gap:5px;justify-content:center"><span style="width:12px;height:12px;border-radius:50%;background:#bb86fc"></span><span style="width:12px;height:12px;border-radius:50%;background:#03dac6"></span><span style="width:12px;height:12px;border-radius:50%;background:#cf6679"></span></div><div class="theme-name">Material Dark</div></div>
<div class="theme-card" onclick="applyHATheme('nord')" style="background:linear-gradient(135deg,#2e3440,#3b4252)"><div style="padding:20px;display:flex;gap:5px;justify-content:center"><span style="width:12px;height:12px;border-radius:50%;background:#88c0d0"></span><span style="width:12px;height:12px;border-radius:50%;background:#a3be8c"></span><span style="width:12px;height:12px;border-radius:50%;background:#ebcb8b"></span></div><div class="theme-name">Nord</div></div>
<div class="theme-card" onclick="applyHATheme('solarized-dark')" style="background:linear-gradient(135deg,#002b36,#073642)"><div style="padding:20px;display:flex;gap:5px;justify-content:center"><span style="width:12px;height:12px;border-radius:50%;background:#268bd2"></span><span style="width:12px;height:12px;border-radius:50%;background:#859900"></span><span style="width:12px;height:12px;border-radius:50%;background:#cb4b16"></span></div><div class="theme-name">Solarized</div></div>
<div class="theme-card" onclick="applyHATheme('dracula')" style="background:linear-gradient(135deg,#282a36,#44475a)"><div style="padding:20px;display:flex;gap:5px;justify-content:center"><span style="width:12px;height:12px;border-radius:50%;background:#bd93f9"></span><span style="width:12px;height:12px;border-radius:50%;background:#50fa7b"></span><span style="width:12px;height:12px;border-radius:50%;background:#ff79c6"></span></div><div class="theme-name">Dracula</div></div>
</div>
</div>

<div id="themeImportTab" style="display:none">
<p style="color:#888;margin-bottom:15px">Paste your Home Assistant theme YAML below</p>
<textarea id="themeYamlInput" rows="12" placeholder="my_theme:
  primary-color: '#6200EE'
  accent-color: '#03DAC6'
  card-background-color: '#1E1E1E'
  primary-text-color: '#FFFFFF'
  secondary-text-color: '#B3B3B3'
  primary-background-color: '#121212'" style="width:100%;padding:15px;background:#0a0a15;border:1px solid rgba(67,238,255,.4);border-radius:8px;color:#43eeff;font-family:monospace;font-size:.85em"></textarea>
<div class="import-options">
<label>Apply to:</label>
<div class="import-option"><input type="checkbox" id="themeApplyBg" checked> Dashboard background</div>
<div class="import-option"><input type="checkbox" id="themeApplyCards" checked> All existing cards</div>
<div class="import-option"><input type="checkbox" id="themeApplyNew" checked> New cards (default)</div>
</div>
<button class="btn" onclick="parseAndApplyThemeYAML()">ğŸš€ Apply Theme</button>
</div>

<div id="themeCustomTab" style="display:none">
<p style="color:#888;margin-bottom:15px">Save current colors as a reusable theme</p>
<div class="form-group"><label>Theme Name</label><input type="text" id="customThemeName" placeholder="My Awesome Theme"></div>
<button class="btn" onclick="saveCustomTheme()">ğŸ’¾ Save Current Colors</button>
<div class="divider"></div>
<h3 style="color:#43eeff;margin-bottom:15px">Saved Themes</h3>
<div id="customThemeList"></div>
<div class="divider"></div>
<button class="btn btn-secondary" onclick="exportThemeYAML()">ğŸ“¤ Export as HA Theme YAML</button>
</div>

<button class="btn btn-secondary" onclick="closeModal('themeImportModal')" style="margin-top:15px">Close</button>
</div></div>

<div class="modal" id="galleryModal"><div class="modal-content">
<h2>ğŸ–¼ï¸ Gallery</h2>
<div class="gallery-grid">
<div class="gallery-item" onclick="cloneGalleryDashboard('smart-home')"><div class="gallery-preview">ğŸ </div><div class="gallery-info"><div class="gallery-title">Smart Home</div><div class="gallery-author">@smarthome_pro</div></div></div>
<div class="gallery-item" onclick="cloneGalleryDashboard('minimalist')"><div class="gallery-preview">âœ¨</div><div class="gallery-info"><div class="gallery-title">Minimalist</div><div class="gallery-author">@clean_design</div></div></div>
<div class="gallery-item" onclick="cloneGalleryDashboard('energy')"><div class="gallery-preview">âš¡</div><div class="gallery-info"><div class="gallery-title">Energy</div><div class="gallery-author">@energy_saver</div></div></div>
<div class="gallery-item" onclick="cloneGalleryDashboard('security')"><div class="gallery-preview">ğŸ”’</div><div class="gallery-info"><div class="gallery-title">Security</div><div class="gallery-author">@safe_home</div></div></div>
</div>
<button class="btn btn-secondary" onclick="closeModal('galleryModal')" style="margin-top:15px">Close</button>
</div></div>

<div class="modal" id="templateModal"><div class="modal-content">
<h2>â­ Templates</h2>
<div class="template-grid">
<div class="template-card" onclick="applyTemplate('living')"><div class="template-icon">ğŸ›‹ï¸</div><div class="template-title">Living Room</div></div>
<div class="template-card" onclick="applyTemplate('kitchen')"><div class="template-icon">ğŸ³</div><div class="template-title">Kitchen</div></div>
<div class="template-card" onclick="applyTemplate('bedroom')"><div class="template-icon">ğŸ›ï¸</div><div class="template-title">Bedroom</div></div>
<div class="template-card" onclick="applyTemplate('security')"><div class="template-icon">ğŸ”’</div><div class="template-title">Security</div></div>
<div class="template-card" onclick="applyTemplate('energy')"><div class="template-icon">âš¡</div><div class="template-title">Energy</div></div>
<div class="template-card" onclick="applyTemplate('outdoor')"><div class="template-icon">ğŸŒ³</div><div class="template-title">Outdoor</div></div>
</div>
<button class="btn btn-secondary" onclick="closeModal('templateModal')" style="margin-top:15px">Close</button>
</div></div>

<div class="modal" id="importModal"><div class="modal-content">
<h2>ğŸ“¥ Import YAML</h2>
<div class="lovelace-toggle">
<button class="lovelace-btn active" onclick="setLovelaceMode('standard')" id="lovelaceStandard">Standard</button>
<button class="lovelace-btn" onclick="setLovelaceMode('custom')" id="lovelaceCustom">Custom Cards</button>
</div>
<textarea id="importYaml" rows="10" placeholder="Paste YAML here..." style="width:100%;padding:15px;background:#0a0a15;border:1px solid rgba(67,238,255,.4);border-radius:8px;color:#43eeff;font-family:monospace"></textarea>
<div class="import-options">
<label>Options</label>
<div class="import-option"><input type="checkbox" id="importPreserveColors" checked>Preserve colors</div>
<div class="import-option"><input type="checkbox" id="importPreserveFonts" checked>Preserve fonts</div>
<div class="import-option"><input type="checkbox" id="importPreserveShadows" checked>Preserve shadows</div>
</div>
<button class="btn" onclick="importYAML()">ğŸš€ Import</button>
<button class="btn btn-secondary" onclick="closeModal('importModal')">Close</button>
</div></div>

<div class="modal" id="stylePresetsModal"><div class="modal-content">
<h2>ğŸ­ Style Presets</h2>
<div class="form-group"><label>Save Current Style</label><input type="text" id="presetName" placeholder="My Style"></div>
<button class="btn" onclick="saveStylePreset()">ğŸ’¾ Save Preset</button>
<div class="divider"></div>
<h3 style="color:#43eeff;margin-bottom:15px">Load Preset</h3>
<div class="preset-grid" id="presetGrid"></div>
<button class="btn btn-secondary" onclick="closeModal('stylePresetsModal')" style="margin-top:15px">Close</button>
</div></div>

<div class="modal" id="shareModal"><div class="modal-content">
<h2>ğŸ”— Share Dashboard</h2>
<p style="color:#888;margin-bottom:15px">Copy this link to share your dashboard:</p>
<div class="share-url" id="shareUrl">Generating...</div>
<button class="btn" onclick="copyShareLink()">ğŸ“‹ Copy Link</button>
<button class="btn btn-secondary" onclick="closeModal('shareModal')">Close</button>
</div></div>

<div class="modal" id="iconPickerModal"><div class="modal-content">
<h2>ğŸ¯ Icon Picker</h2>
<input type="text" class="search-box" id="iconSearch" placeholder="Search icons..." oninput="filterIcons()">
<div class="icon-grid" id="iconGrid"></div>
<button class="btn btn-secondary" onclick="closeModal('iconPickerModal')">Close</button>
</div></div>

<div class="modal" id="cloudSaveModal"><div class="modal-content">
<h2>â˜ï¸ Cloud Save</h2>
<div class="prop-section">
<div class="form-group"><label>Name</label><input type="text" id="cloudDashboardName" placeholder="My Dashboard"></div>
<button class="btn" onclick="saveToCloud()">â˜ï¸ Save</button>
</div>
<div class="prop-section"><h3>Saved Dashboards</h3><div id="cloudDashboardList"></div></div>
<button class="btn btn-secondary" onclick="closeModal('cloudSaveModal')">Close</button>
</div></div>

<div class="modal" id="yamlModal"><div class="modal-content">
<h2>ğŸ“„ Export YAML</h2>
<div class="lovelace-toggle">
<button class="lovelace-btn active" onclick="setExportMode('standard')" id="exportStandard">Standard</button>
<button class="lovelace-btn" onclick="setExportMode('custom')" id="exportCustom">Custom Cards</button>
</div>
<div class="yaml-output" id="yamlOutput"></div>
<button class="btn" onclick="copyYAML()">ğŸ“‹ Copy</button>
<button class="btn btn-secondary" onclick="downloadYAML()">ğŸ’¾ Download</button>
<button class="btn btn-secondary" onclick="closeModal('yamlModal')">Close</button>
</div></div>

<div class="modal" id="versionHistoryModal"><div class="modal-content">
<h2>â±ï¸ History</h2>
<div id="versionList"></div>
<button class="btn btn-secondary" onclick="closeModal('versionHistoryModal')">Close</button>
</div></div>

<div class="modal" id="shortcutsModal"><div class="modal-content">
<h2>âŒ¨ï¸ Shortcuts</h2>
<div class="shortcuts-panel">
<div class="shortcut-item"><span>Select All</span><span class="shortcut-key">Ctrl+A</span></div>
<div class="shortcut-item"><span>Copy</span><span class="shortcut-key">Ctrl+C</span></div>
<div class="shortcut-item"><span>Paste</span><span class="shortcut-key">Ctrl+V</span></div>
<div class="shortcut-item"><span>Duplicate</span><span class="shortcut-key">Ctrl+D</span></div>
<div class="shortcut-item"><span>Delete</span><span class="shortcut-key">Delete</span></div>
<div class="shortcut-item"><span>Undo</span><span class="shortcut-key">Ctrl+Z</span></div>
<div class="shortcut-item"><span>Redo</span><span class="shortcut-key">Ctrl+Y</span></div>
<div class="shortcut-item"><span>Lock/Unlock</span><span class="shortcut-key">L</span></div>
<div class="shortcut-item"><span>Grid Snap</span><span class="shortcut-key">G</span></div>
</div>
<button class="btn btn-secondary" onclick="closeModal('shortcutsModal')">Close</button>
</div></div>

<div class="context-menu" id="contextMenu">
<div class="context-menu-item" onclick="copyEntity()">ğŸ“‹ Copy</div>
<div class="context-menu-item" onclick="deleteEntity()">ğŸ—‘ï¸ Delete</div>
</div>
<div id="notification"></div>

<script>
// MDI Icons subset for picker
const mdiIcons=['mdi:home','mdi:lightbulb','mdi:fan','mdi:thermometer','mdi:water','mdi:fire','mdi:snowflake','mdi:sun','mdi:moon','mdi:cloud','mdi:weather-sunny','mdi:weather-cloudy','mdi:weather-rainy','mdi:power','mdi:power-plug','mdi:television','mdi:speaker','mdi:volume-high','mdi:play','mdi:pause','mdi:stop','mdi:skip-next','mdi:skip-previous','mdi:camera','mdi:video','mdi:motion-sensor','mdi:door','mdi:door-open','mdi:window-closed','mdi:window-open','mdi:garage','mdi:car','mdi:lock','mdi:lock-open','mdi:shield','mdi:alarm','mdi:bell','mdi:email','mdi:phone','mdi:wifi','mdi:bluetooth','mdi:router-wireless','mdi:desktop-tower','mdi:laptop','mdi:tablet','mdi:cellphone','mdi:clock','mdi:calendar','mdi:chart-line','mdi:chart-bar','mdi:gauge','mdi:speedometer','mdi:battery','mdi:battery-charging','mdi:flash','mdi:solar-power','mdi:leaf','mdi:tree','mdi:flower','mdi:dog','mdi:cat','mdi:paw','mdi:baby','mdi:human','mdi:account','mdi:account-group','mdi:bed','mdi:sofa','mdi:table-furniture','mdi:desk','mdi:toilet','mdi:shower','mdi:fridge','mdi:stove','mdi:microwave','mdi:dishwasher','mdi:washing-machine','mdi:vacuum','mdi:robot-vacuum','mdi:air-conditioner','mdi:air-purifier','mdi:humidifier','mdi:ceiling-fan','mdi:lamp','mdi:floor-lamp','mdi:wall-sconce','mdi:led-strip','mdi:string-lights','mdi:spotlight','mdi:track-light','mdi:blinds','mdi:curtains','mdi:gate','mdi:fence','mdi:pool','mdi:hot-tub','mdi:grill','mdi:sprinkler','mdi:watering-can'];
const iconEmojis={'mdi:home':'ğŸ ','mdi:lightbulb':'ğŸ’¡','mdi:fan':'ğŸŒ€','mdi:thermometer':'ğŸŒ¡ï¸','mdi:water':'ğŸ’§','mdi:fire':'ğŸ”¥','mdi:snowflake':'â„ï¸','mdi:sun':'â˜€ï¸','mdi:moon':'ğŸŒ™','mdi:cloud':'â˜ï¸','mdi:weather-sunny':'ğŸŒ¤ï¸','mdi:weather-cloudy':'â›…','mdi:weather-rainy':'ğŸŒ§ï¸','mdi:power':'âš¡','mdi:television':'ğŸ“º','mdi:speaker':'ğŸ”Š','mdi:camera':'ğŸ“·','mdi:video':'ğŸ“¹','mdi:door':'ğŸšª','mdi:car':'ğŸš—','mdi:lock':'ğŸ”’','mdi:lock-open':'ğŸ”“','mdi:shield':'ğŸ›¡ï¸','mdi:alarm':'ğŸš¨','mdi:bell':'ğŸ””','mdi:email':'ğŸ“§','mdi:phone':'ğŸ“±','mdi:wifi':'ğŸ“¶','mdi:clock':'ğŸ•','mdi:calendar':'ğŸ“…','mdi:chart-line':'ğŸ“ˆ','mdi:chart-bar':'ğŸ“Š','mdi:gauge':'â±ï¸','mdi:battery':'ğŸ”‹','mdi:flash':'âš¡','mdi:leaf':'ğŸŒ¿','mdi:tree':'ğŸŒ³','mdi:flower':'ğŸŒ¸','mdi:dog':'ğŸ•','mdi:cat':'ğŸˆ','mdi:baby':'ğŸ‘¶','mdi:account':'ğŸ‘¤','mdi:bed':'ğŸ›ï¸','mdi:sofa':'ğŸ›‹ï¸','mdi:toilet':'ğŸš½','mdi:shower':'ğŸš¿','mdi:fridge':'ğŸ§Š','mdi:stove':'ğŸ³','mdi:pool':'ğŸŠ','mdi:sprinkler':'ğŸ’¦'};

const availableFonts=[{name:'Segoe UI',value:"'Segoe UI', sans-serif"},{name:'Roboto',value:"'Roboto', sans-serif"},{name:'Open Sans',value:"'Open Sans', sans-serif"},{name:'Lato',value:"'Lato', sans-serif"},{name:'Montserrat',value:"'Montserrat', sans-serif"},{name:'Poppins',value:"'Poppins', sans-serif"},{name:'Inter',value:"'Inter', sans-serif"},{name:'Nunito',value:"'Nunito', sans-serif"},{name:'Raleway',value:"'Raleway', sans-serif"},{name:'Ubuntu',value:"'Ubuntu', sans-serif"}];

let cards=[],selectedCard=null,selectedCards=[],selectedCardType='entities',draggedCard=null,resizingCard=null,resizeHandle=null,dragOffset={x:0,y:0},cardIdCounter=0;
let history=[],historyIndex=-1,maxHistory=100,gridSize=50,snapToGrid=true,showAlignGuides=true;
let draggedEntity=null,draggedFromCard=null,draggedEntityIndex=-1,contextEntity=null,contextCard=null,contextEntityIndex=-1;
let bgSettings={type:'gradient',grad1:'#0f0f1e',grad2:'#1a1a2e',angle:135,imageUrl:'',solid:'#1a1a2e',opacity:30,blur:0,overlay:50};
let previewMode='desktop',animationType='fade',clipboard=null,styleClipboard=null,autoSave=true,autoSaveInterval=null;
let dashboards=[{id:1,name:'My Dashboard',cards:[],bg:bgSettings,created:Date.now()}],currentDashboardId=1;
let versionHistory=[],groups={},cloudDashboards=[],stylePresets=[],lovelaceMode='standard',exportMode='standard';
let responsiveLayouts={desktop:{},tablet:{},mobile:{}};
let lastCardSettings={bgColor:'#43eeff',titleColor:'#ff43ee',entityColor:'#ffeb3b',titleFont:"'Segoe UI', sans-serif",entityFont:"'Segoe UI', sans-serif",titleShadow:{enabled:false,x:2,y:2,blur:4,color:'rgba(0,0,0,0.5)'},entityShadow:{enabled:false,x:1,y:1,blur:2,color:'rgba(0,0,0,0.5)'}};
let currentIconCallback=null;

const canvas=document.getElementById('canvas'),propertiesPanel=document.getElementById('propertiesPanel'),cardConfig=document.getElementById('cardConfig');
const themes={default:{bg1:'#0f0f1e',bg2:'#1a1a2e',card:'#43eeff',title:'#ff43ee',entity:'#ffeb3b'},light:{bg1:'#f5f5f5',bg2:'#e0e0e0',card:'#2196f3',title:'#e91e63',entity:'#ff9800'},neon:{bg1:'#ff006e',bg2:'#8338ec',card:'#00ff9f',title:'#ffbe0b',entity:'#fb5607'},ocean:{bg1:'#006994',bg2:'#003d5c',card:'#00b4d8',title:'#0077b6',entity:'#90e0ef'},forest:{bg1:'#1e4d2b',bg2:'#0d2818',card:'#52b788',title:'#95d5b2',entity:'#d8f3dc'},sunset:{bg1:'#ff6b35',bg2:'#f7931e',card:'#ffd60a',title:'#ff006e',entity:'#ffbe0b'},purple:{bg1:'#7209b7',bg2:'#3a0ca3',card:'#c77dff',title:'#e0aaff',entity:'#f72585'},minimal:{bg1:'#1a1a1a',bg2:'#1a1a1a',card:'#333',title:'#fff',entity:'#ccc'},cyberpunk:{bg1:'#00ff9f',bg2:'#00b8ff',card:'#ff006e',title:'#ffbe0b',entity:'#8338ec'}};

function getFontOptionsHTML(sel="'Segoe UI', sans-serif"){return availableFonts.map(f=>`<option value="${f.value}"${f.value===sel?' selected':''}>${f.name}</option>`).join('')}
function snapVal(v){return snapToGrid?Math.round(v/gridSize)*gridSize:v}
function saveState(){const d=dashboards.find(x=>x.id===currentDashboardId);if(d){d.cards=JSON.parse(JSON.stringify(cards));d.bg=JSON.parse(JSON.stringify(bgSettings))}history=history.slice(0,historyIndex+1);history.push(JSON.stringify({cards,bg:bgSettings}));historyIndex++;if(history.length>maxHistory){history.shift();historyIndex--}versionHistory.push({time:Date.now(),cards:JSON.parse(JSON.stringify(cards)),cardCount:cards.length});if(versionHistory.length>20)versionHistory.shift();updateStatus('Saved')}
function undo(){if(historyIndex>0){historyIndex--;const s=JSON.parse(history[historyIndex]);cards=s.cards||[];bgSettings=s.bg||bgSettings;renderCanvas();applyBackground()}}
function redo(){if(historyIndex<history.length-1){historyIndex++;const s=JSON.parse(history[historyIndex]);cards=s.cards||[];bgSettings=s.bg||bgSettings;renderCanvas();applyBackground()}}

document.addEventListener('keydown',e=>{if(e.ctrlKey||e.metaKey){if(e.key==='z'&&!e.shiftKey){e.preventDefault();undo()}else if(e.key==='y'||(e.key==='z'&&e.shiftKey)){e.preventDefault();redo()}else if(e.key==='d'){e.preventDefault();duplicateCard()}else if(e.key==='c'&&selectedCard){e.preventDefault();clipboard=JSON.parse(JSON.stringify(selectedCard));showNotification('Copied')}else if(e.key==='v'&&clipboard){e.preventDefault();pasteCard()}else if(e.key==='a'){e.preventDefault();selectAll()}else if(e.key==='s'){e.preventDefault();saveProject()}else if(e.key==='g'){e.preventDefault();groupSelected()}}else if(e.key==='Delete'){if(selectedCards.length>0)deleteMultiple();else if(selectedCard)deleteCard()}else if(e.key==='g')toggleGridSnap();else if(e.key==='l')toggleLockSelected();else if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)&&selectedCard){e.preventDefault();moveCardWithKeys(e.key)}});
document.addEventListener('click',()=>document.getElementById('contextMenu').classList.remove('active'));

const cardTypeConfigs={entities:{defaultSize:{width:300,height:200},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="My Entities"></div><div class="form-group"><label>Entities</label><textarea id="newCardEntities" rows="5" placeholder="light.living_room\nswitch.fan"></textarea></div>`},thermostat:{defaultSize:{width:300,height:280},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Thermostat"></div><div class="form-group"><label>Entities</label><textarea id="thermostatEntities" rows="3" placeholder="climate.thermostat"></textarea></div>`},weather:{defaultSize:{width:350,height:250},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Weather"></div><div class="form-group"><label>Entity</label><input type="text" id="weatherEntity" value="weather.home"></div>`},camera:{defaultSize:{width:400,height:300},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Camera"></div><div class="form-group"><label>Entity</label><input type="text" id="cameraEntity" value="camera.front"></div>`},media:{defaultSize:{width:350,height:200},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Media"></div><div class="form-group"><label>Entity</label><input type="text" id="mediaEntity" value="media_player.speaker"></div>`},gauge:{defaultSize:{width:250,height:250},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Gauge"></div><div class="form-group"><label>Entity</label><input type="text" id="gaugeEntity" value="sensor.battery"></div><div class="form-group"><label>Min</label><input type="number" id="gaugeMin" value="0"></div><div class="form-group"><label>Max</label><input type="number" id="gaugeMax" value="100"></div>`},button:{defaultSize:{width:200,height:150},fields:`<div class="form-group"><label>Name</label><input type="text" id="newCardTitle" value="Button"></div><div class="form-group"><label>Entity</label><input type="text" id="buttonEntity" value="switch.device"></div>`},clock:{defaultSize:{width:300,height:250},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Clock"></div><div class="form-group"><label>Format</label><select id="clockFormat"><option value="12">12-Hour</option><option value="24">24-Hour</option></select></div>`},markdown:{defaultSize:{width:350,height:250},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Notes"></div><div class="form-group"><label>Content</label><textarea id="markdownContent" rows="5">**Bold** text</textarea></div>`},picture:{defaultSize:{width:400,height:300},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Picture"></div><div class="form-group"><label>URL</label><input type="text" id="pictureUrl" placeholder="https://..."></div>`},glance:{defaultSize:{width:350,height:200},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Glance"></div><div class="form-group"><label>Entities</label><textarea id="glanceEntities" rows="3" placeholder="light.living\nswitch.fan"></textarea></div>`},chart:{defaultSize:{width:450,height:300},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Chart"></div><div class="form-group"><label>Entity</label><input type="text" id="chartEntity" value="sensor.temp"></div>`},map:{defaultSize:{width:500,height:400},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Map"></div><div class="form-group"><label>Entities</label><textarea id="mapEntities" rows="3" placeholder="device_tracker.phone"></textarea></div>`},iframe:{defaultSize:{width:600,height:400},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Iframe"></div><div class="form-group"><label>URL</label><input type="text" id="iframeUrl" placeholder="https://..."></div>`},light:{defaultSize:{width:300,height:200},fields:`<div class="form-group"><label>Title</label><input type="text" id="newCardTitle" value="Lights"></div><div class="form-group"><label>Entities</label><textarea id="lightEntities" rows="3" placeholder="light.living_room"></textarea></div>`}};

function selectCardType(t){selectedCardType=t;document.querySelectorAll('.card-type-btn').forEach(b=>b.classList.remove('active'));event.target.closest('.card-type-btn').classList.add('active');cardConfig.innerHTML=cardTypeConfigs[t].fields}
cardConfig.innerHTML=cardTypeConfigs.entities.fields;saveState();

function addCardToCanvas(){const size=cardTypeConfigs[selectedCardType].defaultSize,title=document.getElementById('newCardTitle')?.value||'Card';
const cardData={id:cardIdCounter++,type:selectedCardType,title,x:50+(cards.length%5)*30,y:50+Math.floor(cards.length/5)*30,width:size.width,height:size.height,bgColor:'#43eeff',titleColor:'#ff43ee',entityColor:'#ffeb3b',useGradient:false,gradientColor1:'#43eeff',gradientColor2:'#ff43ee',zIndex:cards.length,animation:animationType,group:null,locked:false,aspectRatioLock:false,hoverEffect:'none',icon:'',titleFont:"'Segoe UI', sans-serif",entityFont:"'Segoe UI', sans-serif",titleShadow:{enabled:false,x:2,y:2,blur:4,color:'rgba(0,0,0,0.5)'},entityShadow:{enabled:false,x:1,y:1,blur:2,color:'rgba(0,0,0,0.5)'},borderRadius:14,cornerStyle:'rounded',tapAction:{action:'toggle',service:'',entity:''},conditions:''};
if(selectedCardType==='entities'||selectedCardType==='light'){const t=document.getElementById(selectedCardType==='light'?'lightEntities':'newCardEntities')?.value||'';cardData.entities=t.split('\n').filter(e=>e.trim())}
else if(selectedCardType==='thermostat'){const t=document.getElementById('thermostatEntities')?.value||'climate.thermostat';cardData.entities=t.split('\n').filter(e=>e.trim())}
else if(selectedCardType==='glance'||selectedCardType==='map'){const id=selectedCardType+'Entities';cardData.entities=(document.getElementById(id)?.value||'').split('\n').filter(e=>e.trim())}
else if(['weather','camera','media','gauge'].includes(selectedCardType)){cardData.entity=document.getElementById(selectedCardType+'Entity')?.value||''}
else if(selectedCardType==='button'){cardData.entity=document.getElementById('buttonEntity')?.value||''}
else if(selectedCardType==='clock'){cardData.format=document.getElementById('clockFormat')?.value||'12'}
else if(selectedCardType==='markdown'){cardData.content=document.getElementById('markdownContent')?.value||''}
else if(selectedCardType==='picture'){cardData.imageUrl=document.getElementById('pictureUrl')?.value||''}
else if(selectedCardType==='chart'){cardData.entity=document.getElementById('chartEntity')?.value||''}
else if(selectedCardType==='iframe'){cardData.iframeUrl=document.getElementById('iframeUrl')?.value||''}
if(selectedCardType==='gauge'){cardData.min=document.getElementById('gaugeMin')?.value||0;cardData.max=document.getElementById('gaugeMax')?.value||100}
cards.push(cardData);saveState();renderCanvas();selectCard(cardData);updateCardCount();showNotification('Card added','success')}

function renderCanvas(){canvas.innerHTML='';cards.sort((a,b)=>a.zIndex-b.zIndex).forEach(c=>canvas.appendChild(createCardElement(c)));updateLayersList()}
function getTextShadowCSS(s){if(!s||!s.enabled)return'none';return`${s.x}px ${s.y}px ${s.blur}px ${s.color}`}
function getScaleFactor(c){const bw=cardTypeConfigs[c.type]?.defaultSize.width||300,bh=cardTypeConfigs[c.type]?.defaultSize.height||200;return Math.min(c.width/bw,c.height/bh,2)}

function createCardElement(c){
const el=document.createElement('div');el.className='canvas-card';if(c.animation)el.classList.add(`anim-${c.animation}`);if(c.locked)el.classList.add('locked');if(c.hoverEffect&&c.hoverEffect!=='none')el.classList.add(`hover-${c.hoverEffect}`);
el.id=`card-${c.id}`;el.style.left=c.x+'px';el.style.top=c.y+'px';el.style.width=c.width+'px';el.style.height=c.height+'px';
el.style.background=c.useGradient?`linear-gradient(135deg,${c.gradientColor1},${c.gradientColor2})`:c.bgColor;
el.style.zIndex=c.zIndex||0;el.style.borderRadius=(c.cornerStyle==='square'?0:(c.borderRadius||14))+'px';
if(selectedCard?.id===c.id)el.classList.add('selected');if(selectedCards.some(s=>s.id===c.id))el.classList.add('multi-selected');
const scale=getScaleFactor(c),titleFont=c.titleFont||"'Segoe UI', sans-serif",entityFont=c.entityFont||"'Segoe UI', sans-serif",titleShadow=getTextShadowCSS(c.titleShadow),entityShadow=getTextShadowCSS(c.entityShadow);
const titleSize=(c.titleSize||1.2)*scale,entitySize=(c.entitySize||0.85)*scale;
const iconHtml=c.icon&&iconEmojis[c.icon]?`<span class="card-icon">${iconEmojis[c.icon]}</span>`:'';
el.innerHTML=`<div class="card-type-badge">${c.type}</div><div class="card-size-badge">${c.width}Ã—${c.height}</div><div class="card-z-badge">Z:${c.zIndex||0}</div>${c.group?`<div class="card-group-badge">G:${c.group}</div>`:''}`;

const titleEl=document.createElement('div');titleEl.className='card-title-display';titleEl.innerHTML=iconHtml+c.title;titleEl.style.cssText=`color:${c.titleColor};font-family:${titleFont};text-shadow:${titleShadow};font-size:${titleSize}em`;el.appendChild(titleEl);

if(c.type==='entities'||c.type==='light'||c.type==='thermostat'){
(c.entities||[]).forEach((ent,idx)=>{const d=document.createElement('div');d.className='card-entity-display';d.textContent=ent;d.style.cssText=`color:${c.entityColor};font-family:${entityFont};text-shadow:${entityShadow};font-size:${entitySize}em;padding:${6*scale}px ${10*scale}px`;d.draggable=true;d.ondragstart=ev=>{draggedEntity=ent;draggedFromCard=c;draggedEntityIndex=idx;ev.target.classList.add('dragging-entity')};d.ondragend=ev=>ev.target.classList.remove('dragging-entity');d.oncontextmenu=ev=>{ev.preventDefault();ev.stopPropagation();contextCard=c;contextEntityIndex=idx;contextEntity=ent;const m=document.getElementById('contextMenu');m.style.left=ev.pageX+'px';m.style.top=ev.pageY+'px';m.classList.add('active')};el.appendChild(d)})}
else if(c.type==='glance'){const g=document.createElement('div');g.style.cssText='display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px';(c.entities||[]).forEach(e=>{const i=document.createElement('div');i.style.cssText=`text-align:center;padding:${8*scale}px;background:rgba(255,255,255,.2);border-radius:6px;color:${c.entityColor};font-size:${entitySize}em`;i.textContent=e.split('.')[1]||e;g.appendChild(i)});el.appendChild(g)}
else if(c.type==='weather'){el.innerHTML+=`<div style="text-align:center;margin-top:10px"><div style="font-size:${3*scale}em">ğŸŒ¤ï¸</div><div style="font-size:${entitySize*1.5}em;font-weight:bold;color:${c.entityColor}">72Â°F</div></div>`}
else if(c.type==='clock'){const now=new Date(),t=c.format==='12'?now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true}):now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});el.innerHTML+=`<div style="display:flex;align-items:center;justify-content:center;flex:1;font-size:${entitySize*2}em;font-weight:bold;color:${c.entityColor}">${t}</div>`;el.style.display='flex';el.style.flexDirection='column'}
else if(c.type==='gauge'){el.innerHTML+=`<div style="text-align:center;margin-top:20px"><div style="font-size:${3*scale}em">â±ï¸</div><div style="font-size:${entitySize*1.5}em;color:${c.entityColor}">75%</div></div>`}
else if(c.type==='camera'){el.innerHTML+=`<div style="flex:1;background:#1a1a2e;display:flex;align-items:center;justify-content:center;font-size:${3*scale}em;color:rgba(255,255,255,.3);margin-top:10px;border-radius:8px">ğŸ“·</div>`;el.style.display='flex';el.style.flexDirection='column'}
else if(c.type==='markdown'){el.innerHTML+=`<div style="color:${c.entityColor};padding:10px;font-size:${0.9*scale}em">${c.content||'Markdown'}</div>`}
else{el.innerHTML+=`<div style="flex:1;display:flex;align-items:center;justify-content:center;font-size:${2*scale}em;color:rgba(255,255,255,.3)">${c.type==='media'?'ğŸµ':c.type==='chart'?'ğŸ“Š':c.type==='map'?'ğŸ—ºï¸':c.type==='iframe'?'ğŸŒ':c.type==='picture'?'ğŸ–¼ï¸':c.type==='button'?'ğŸ”˜':'ğŸ“‹'}</div>`}

['nw','ne','sw','se'].forEach(p=>{const h=document.createElement('div');h.className=`resize-handle resize-${p}`;h.dataset.position=p;el.appendChild(h)});

el.ondragover=ev=>{if(draggedEntity&&['entities','light','thermostat'].includes(c.type)){ev.preventDefault();el.classList.add('drag-over')}};
el.ondragleave=()=>el.classList.remove('drag-over');
el.ondrop=ev=>{if(draggedEntity&&['entities','light','thermostat'].includes(c.type)){ev.preventDefault();el.classList.remove('drag-over');if(draggedFromCard.id!==c.id){if(!c.entities)c.entities=[];c.entities.push(draggedEntity);if(draggedFromCard.entities)draggedFromCard.entities.splice(draggedEntityIndex,1);saveState();renderCanvas()}}draggedEntity=null};

el.addEventListener('mousedown',e=>{if(c.locked&&!e.target.classList.contains('resize-handle'))return;if(e.target.classList.contains('resize-handle'))startResize(e,c);else if(!e.target.classList.contains('card-entity-display'))startDrag(e,c)});
return el}

function startDrag(e,c){if(c.locked)return;draggedCard=c;if(e.shiftKey&&!selectedCards.some(s=>s.id===c.id))selectedCards.push(c);else if(!selectedCards.some(s=>s.id===c.id)){selectedCards=[];selectedCard=c}selectCard(c);const el=document.getElementById(`card-${c.id}`),r=el.getBoundingClientRect();dragOffset.x=e.clientX-r.left;dragOffset.y=e.clientY-r.top;document.addEventListener('mousemove',handleDrag);document.addEventListener('mouseup',stopDrag);e.preventDefault()}
function handleDrag(e){if(!draggedCard)return;const r=canvas.getBoundingClientRect(),rawX=Math.max(0,e.clientX-r.left-dragOffset.x),rawY=Math.max(0,e.clientY-r.top-dragOffset.y),newX=snapVal(rawX),newY=snapVal(rawY),dx=newX-draggedCard.x,dy=newY-draggedCard.y;if(selectedCards.length>1)selectedCards.forEach(c=>{if(!c.locked){c.x+=dx;c.y+=dy}});else{draggedCard.x=newX;draggedCard.y=newY}renderCanvas();if(showAlignGuides)drawAlignGuides(draggedCard)}
function stopDrag(){if(draggedCard)saveState();draggedCard=null;document.removeEventListener('mousemove',handleDrag);document.removeEventListener('mouseup',stopDrag);clearAlignGuides()}
function startResize(e,c){resizingCard=c;resizeHandle=e.target.dataset.position;document.addEventListener('mousemove',handleResize);document.addEventListener('mouseup',stopResize);e.preventDefault();e.stopPropagation()}
function handleResize(e){if(!resizingCard)return;const r=canvas.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top;const oldW=resizingCard.width,oldH=resizingCard.height,ratio=oldW/oldH;if(resizeHandle.includes('e'))resizingCard.width=snapVal(Math.max(150,mx-resizingCard.x));if(resizeHandle.includes('s'))resizingCard.height=snapVal(Math.max(100,my-resizingCard.y));if(resizingCard.aspectRatioLock){if(resizeHandle.includes('e'))resizingCard.height=Math.round(resizingCard.width/ratio);else resizingCard.width=Math.round(resizingCard.height*ratio)}renderCanvas()}
function stopResize(){if(resizingCard)saveState();resizingCard=null;document.removeEventListener('mousemove',handleResize);document.removeEventListener('mouseup',stopResize)}

function drawAlignGuides(card){clearAlignGuides();cards.forEach(c=>{if(c.id===card.id)return;if(Math.abs(c.x-card.x)<10)addGuide(c.x,'vertical');if(Math.abs(c.y-card.y)<10)addGuide(c.y,'horizontal');if(Math.abs((c.x+c.width/2)-(card.x+card.width/2))<10)addGuide(c.x+c.width/2,'vertical');if(Math.abs((c.y+c.height/2)-(card.y+card.height/2))<10)addGuide(c.y+c.height/2,'horizontal')})}
function addGuide(pos,type){const g=document.createElement('div');g.className=`align-guide ${type}`;if(type==='vertical'){g.style.left=pos+'px';g.style.top='0'}else{g.style.top=pos+'px';g.style.left='0'}canvas.appendChild(g)}
function clearAlignGuides(){document.querySelectorAll('.align-guide').forEach(g=>g.remove())}
function toggleAlignGuides(){showAlignGuides=!showAlignGuides;document.getElementById('guidesBtn').classList.toggle('active',showAlignGuides);showNotification(`Guides ${showAlignGuides?'ON':'OFF'}`)}

function selectCard(c){selectedCard=c;renderCanvas();showProperties(c);updateSelectedCount();if(c){Object.assign(lastCardSettings,{bgColor:c.bgColor,titleColor:c.titleColor,entityColor:c.entityColor,titleFont:c.titleFont,entityFont:c.entityFont,titleShadow:{...c.titleShadow},entityShadow:{...c.entityShadow}})}}

function showProperties(c){
if(!c){propertiesPanel.innerHTML='<div class="no-selection"><div class="no-selection-icon">ğŸ‘†</div><p>Click a card to edit</p></div>';return}
if(selectedCards.length>1){showBulkProperties();return}
// Initialize defaults
c.titleFont=c.titleFont||"'Segoe UI', sans-serif";c.entityFont=c.entityFont||"'Segoe UI', sans-serif";
c.titleShadow=c.titleShadow||{enabled:false,x:2,y:2,blur:4,color:'#000'};c.entityShadow=c.entityShadow||{enabled:false,x:1,y:1,blur:2,color:'#000'};
c.borderRadius=c.borderRadius??14;c.cornerStyle=c.cornerStyle||'rounded';c.hoverEffect=c.hoverEffect||'none';c.tapAction=c.tapAction||{action:'toggle',service:'',entity:''};c.conditions=c.conditions||'';c.icon=c.icon||'';c.aspectRatioLock=c.aspectRatioLock||false;

const entField=c.entities?`<div class="form-group"><label>Entities</label><textarea id="prop-entities" rows="4">${c.entities.join('\n')}</textarea></div>`:c.entity!==undefined?`<div class="form-group"><label>Entity</label><input type="text" id="prop-entity" value="${c.entity||''}"></div>`:'';

propertiesPanel.innerHTML=`
<div class="prop-section"><h3>ğŸ“ Basic</h3>
<div class="form-group"><label>Title</label><input type="text" id="prop-title" value="${c.title}"></div>
<div class="form-group"><label>Icon</label><div style="display:flex;gap:8px"><input type="text" id="prop-icon" value="${c.icon}" style="flex:1" readonly><button class="btn btn-small" onclick="openIconPicker()" style="width:auto;padding:8px 15px">ğŸ¯</button></div></div>
${entField}
<div class="form-group"><label class="checkbox-label"><input type="checkbox" id="prop-locked" ${c.locked?'checked':''}> ğŸ”’ Locked</label></div>
</div>
<div class="prop-section"><h3>ğŸ“ Size & Position</h3>
<div class="form-group"><label>X: ${c.x}px</label><input type="range" id="prop-x" min="0" max="1500" value="${c.x}"></div>
<div class="form-group"><label>Y: ${c.y}px</label><input type="range" id="prop-y" min="0" max="1500" value="${c.y}"></div>
<div class="form-group"><label>W: ${c.width}px</label><input type="range" id="prop-w" min="150" max="800" value="${c.width}"></div>
<div class="form-group"><label>H: ${c.height}px</label><input type="range" id="prop-h" min="100" max="600" value="${c.height}"></div>
<div class="form-group"><label class="checkbox-label"><input type="checkbox" id="prop-aspect" ${c.aspectRatioLock?'checked':''}> ğŸ”— Lock Aspect Ratio</label></div>
</div>
<div class="prop-section"><h3>ğŸ¨ Colors</h3>
<div class="form-group"><label class="checkbox-label"><input type="checkbox" id="prop-gradient" ${c.useGradient?'checked':''}> Use Gradient</label></div>
<div id="solidColorSection" style="display:${c.useGradient?'none':'block'}"><div class="form-group"><label>Background</label><input type="color" id="prop-bg" value="${c.bgColor}"></div></div>
<div id="gradientSection" style="display:${c.useGradient?'block':'none'}"><div class="form-group"><label>Gradient Color 1</label><input type="color" id="prop-gc1" value="${c.gradientColor1||'#43eeff'}"></div><div class="form-group"><label>Gradient Color 2</label><input type="color" id="prop-gc2" value="${c.gradientColor2||'#ff43ee'}"></div></div>
<div class="form-group"><label>Title Color</label><input type="color" id="prop-tc" value="${c.titleColor}"></div>
<div class="form-group"><label>Entity Color</label><input type="color" id="prop-ec" value="${c.entityColor}"></div>
</div>
<div class="prop-section"><h3>âœ¨ Title Shadow</h3>
<div class="form-group"><label class="checkbox-label"><input type="checkbox" id="prop-title-shadow" ${c.titleShadow?.enabled?'checked':''}> Enable Shadow</label></div>
<div id="titleShadowSection" style="display:${c.titleShadow?.enabled?'block':'none'}">
<div class="form-group"><label>X: <span id="tsX">${c.titleShadow?.x||2}</span>px</label><input type="range" id="prop-ts-x" min="-10" max="10" value="${c.titleShadow?.x||2}"></div>
<div class="form-group"><label>Y: <span id="tsY">${c.titleShadow?.y||2}</span>px</label><input type="range" id="prop-ts-y" min="-10" max="10" value="${c.titleShadow?.y||2}"></div>
<div class="form-group"><label>Blur: <span id="tsBlur">${c.titleShadow?.blur||4}</span>px</label><input type="range" id="prop-ts-blur" min="0" max="20" value="${c.titleShadow?.blur||4}"></div>
<div class="form-group"><label>Color</label><input type="color" id="prop-ts-color" value="${c.titleShadow?.color||'#000000'}"></div>
</div></div>
<div class="prop-section"><h3>âœ¨ Entity Shadow</h3>
<div class="form-group"><label class="checkbox-label"><input type="checkbox" id="prop-entity-shadow" ${c.entityShadow?.enabled?'checked':''}> Enable Shadow</label></div>
<div id="entityShadowSection" style="display:${c.entityShadow?.enabled?'block':'none'}">
<div class="form-group"><label>X: <span id="esX">${c.entityShadow?.x||1}</span>px</label><input type="range" id="prop-es-x" min="-10" max="10" value="${c.entityShadow?.x||1}"></div>
<div class="form-group"><label>Y: <span id="esY">${c.entityShadow?.y||1}</span>px</label><input type="range" id="prop-es-y" min="-10" max="10" value="${c.entityShadow?.y||1}"></div>
<div class="form-group"><label>Blur: <span id="esBlur">${c.entityShadow?.blur||2}</span>px</label><input type="range" id="prop-es-blur" min="0" max="20" value="${c.entityShadow?.blur||2}"></div>
<div class="form-group"><label>Color</label><input type="color" id="prop-es-color" value="${c.entityShadow?.color||'#000000'}"></div>
</div></div>
<div class="prop-section"><h3>âœ¨ Effects</h3>
<div class="form-group"><label>Hover Effect</label><select id="prop-hover"><option value="none" ${c.hoverEffect==='none'?'selected':''}>None</option><option value="scale" ${c.hoverEffect==='scale'?'selected':''}>Scale Up</option><option value="glow" ${c.hoverEffect==='glow'?'selected':''}>Glow</option><option value="lift" ${c.hoverEffect==='lift'?'selected':''}>Lift</option><option value="border" ${c.hoverEffect==='border'?'selected':''}>Border</option></select></div>
<div class="form-group"><label>Corner Style</label><select id="prop-corner"><option value="rounded" ${c.cornerStyle==='rounded'?'selected':''}>Rounded</option><option value="square" ${c.cornerStyle==='square'?'selected':''}>Square</option></select></div>
<div class="form-group"><label>Border Radius: ${c.borderRadius}px</label><input type="range" id="prop-radius" min="0" max="50" value="${c.borderRadius}"></div>
</div>
<div class="prop-section"><h3>ğŸ”¤ Typography</h3>
<div class="form-group"><label>Title Font</label><select id="prop-title-font">${getFontOptionsHTML(c.titleFont)}</select></div>
<div class="form-group"><label>Title Size: <span id="titleSizeVal">${c.titleSize||1.2}</span>em</label><input type="range" id="prop-title-size" min="0.6" max="3" step="0.1" value="${c.titleSize||1.2}"></div>
<div class="form-group"><label>Entity Font</label><select id="prop-entity-font">${getFontOptionsHTML(c.entityFont)}</select></div>
<div class="form-group"><label>Entity Size: <span id="entitySizeVal">${c.entitySize||0.85}</span>em</label><input type="range" id="prop-entity-size" min="0.5" max="2" step="0.05" value="${c.entitySize||0.85}"></div>
</div>
<div class="prop-section"><h3>ğŸ‘† Tap Action</h3>
<div class="form-group"><label>Action</label><select id="prop-tap-action"><option value="toggle" ${c.tapAction.action==='toggle'?'selected':''}>Toggle</option><option value="call-service" ${c.tapAction.action==='call-service'?'selected':''}>Call Service</option><option value="navigate" ${c.tapAction.action==='navigate'?'selected':''}>Navigate</option><option value="more-info" ${c.tapAction.action==='more-info'?'selected':''}>More Info</option><option value="none" ${c.tapAction.action==='none'?'selected':''}>None</option></select></div>
<div class="form-group"><label>Service/Path</label><input type="text" id="prop-tap-service" value="${c.tapAction.service||''}" placeholder="light.toggle or /lovelace/1"></div>
</div>
<div class="prop-section"><h3>ğŸ” Conditions</h3>
<div class="form-group"><label>Visibility Conditions (notes)</label><textarea id="prop-conditions" rows="2" placeholder="Show when state is 'on'">${c.conditions}</textarea></div>
</div>
<button class="btn btn-half btn-small" onclick="duplicateCard()">ğŸ“‹ Clone</button>
<button class="btn btn-half btn-danger btn-small" onclick="deleteCard()">ğŸ—‘ï¸ Delete</button>`;

// Wire up events
document.getElementById('prop-title').oninput=e=>{c.title=e.target.value;renderCanvas()};
document.getElementById('prop-icon').value=c.icon;
document.getElementById('prop-locked').onchange=e=>{c.locked=e.target.checked;renderCanvas()};
document.getElementById('prop-x').oninput=e=>{c.x=+e.target.value;renderCanvas();e.target.previousElementSibling.textContent=`X: ${c.x}px`};
document.getElementById('prop-y').oninput=e=>{c.y=+e.target.value;renderCanvas();e.target.previousElementSibling.textContent=`Y: ${c.y}px`};
document.getElementById('prop-w').oninput=e=>{c.width=+e.target.value;renderCanvas();e.target.previousElementSibling.textContent=`W: ${c.width}px`};
document.getElementById('prop-h').oninput=e=>{c.height=+e.target.value;renderCanvas();e.target.previousElementSibling.textContent=`H: ${c.height}px`};
document.getElementById('prop-aspect').onchange=e=>{c.aspectRatioLock=e.target.checked};
document.getElementById('prop-gradient').onchange=e=>{c.useGradient=e.target.checked;document.getElementById('solidColorSection').style.display=c.useGradient?'none':'block';document.getElementById('gradientSection').style.display=c.useGradient?'block':'none';renderCanvas()};
document.getElementById('prop-bg').oninput=e=>{c.bgColor=e.target.value;renderCanvas()};
document.getElementById('prop-gc1').oninput=e=>{c.gradientColor1=e.target.value;renderCanvas()};
document.getElementById('prop-gc2').oninput=e=>{c.gradientColor2=e.target.value;renderCanvas()};
document.getElementById('prop-tc').oninput=e=>{c.titleColor=e.target.value;renderCanvas()};
document.getElementById('prop-ec').oninput=e=>{c.entityColor=e.target.value;renderCanvas()};
document.getElementById('prop-title-shadow').onchange=e=>{c.titleShadow.enabled=e.target.checked;document.getElementById('titleShadowSection').style.display=c.titleShadow.enabled?'block':'none';renderCanvas()};
document.getElementById('prop-ts-x').oninput=e=>{c.titleShadow.x=+e.target.value;document.getElementById('tsX').textContent=c.titleShadow.x;renderCanvas()};
document.getElementById('prop-ts-y').oninput=e=>{c.titleShadow.y=+e.target.value;document.getElementById('tsY').textContent=c.titleShadow.y;renderCanvas()};
document.getElementById('prop-ts-blur').oninput=e=>{c.titleShadow.blur=+e.target.value;document.getElementById('tsBlur').textContent=c.titleShadow.blur;renderCanvas()};
document.getElementById('prop-ts-color').oninput=e=>{c.titleShadow.color=e.target.value;renderCanvas()};
document.getElementById('prop-entity-shadow').onchange=e=>{c.entityShadow.enabled=e.target.checked;document.getElementById('entityShadowSection').style.display=c.entityShadow.enabled?'block':'none';renderCanvas()};
document.getElementById('prop-es-x').oninput=e=>{c.entityShadow.x=+e.target.value;document.getElementById('esX').textContent=c.entityShadow.x;renderCanvas()};
document.getElementById('prop-es-y').oninput=e=>{c.entityShadow.y=+e.target.value;document.getElementById('esY').textContent=c.entityShadow.y;renderCanvas()};
document.getElementById('prop-es-blur').oninput=e=>{c.entityShadow.blur=+e.target.value;document.getElementById('esBlur').textContent=c.entityShadow.blur;renderCanvas()};
document.getElementById('prop-es-color').oninput=e=>{c.entityShadow.color=e.target.value;renderCanvas()};
document.getElementById('prop-hover').onchange=e=>{c.hoverEffect=e.target.value;renderCanvas()};
document.getElementById('prop-corner').onchange=e=>{c.cornerStyle=e.target.value;renderCanvas()};
document.getElementById('prop-radius').oninput=e=>{c.borderRadius=+e.target.value;renderCanvas();e.target.previousElementSibling.textContent=`Border Radius: ${c.borderRadius}px`};
document.getElementById('prop-title-font').onchange=e=>{c.titleFont=e.target.value;renderCanvas()};
document.getElementById('prop-title-size').oninput=e=>{c.titleSize=parseFloat(e.target.value);document.getElementById('titleSizeVal').textContent=c.titleSize;renderCanvas()};
document.getElementById('prop-entity-font').onchange=e=>{c.entityFont=e.target.value;renderCanvas()};
document.getElementById('prop-entity-size').oninput=e=>{c.entitySize=parseFloat(e.target.value);document.getElementById('entitySizeVal').textContent=c.entitySize;renderCanvas()};
document.getElementById('prop-tap-action').onchange=e=>{c.tapAction.action=e.target.value};
document.getElementById('prop-tap-service').oninput=e=>{c.tapAction.service=e.target.value};
document.getElementById('prop-conditions').oninput=e=>{c.conditions=e.target.value};
if(document.getElementById('prop-entities'))document.getElementById('prop-entities').oninput=e=>{c.entities=e.target.value.split('\n').filter(x=>x.trim());renderCanvas()};
if(document.getElementById('prop-entity'))document.getElementById('prop-entity').oninput=e=>{c.entity=e.target.value;renderCanvas()};}

// Bulk edit for multiple selection
function showBulkProperties(){
propertiesPanel.innerHTML=`<div class="prop-section"><h3>ğŸ“¦ Bulk Edit (${selectedCards.length} cards)</h3>
<div class="form-group"><label>Background</label><input type="color" id="bulk-bg" value="#43eeff"></div>
<div class="form-group"><label>Title Color</label><input type="color" id="bulk-tc" value="#ff43ee"></div>
<div class="form-group"><label>Entity Color</label><input type="color" id="bulk-ec" value="#ffeb3b"></div>
<div class="form-group"><label>Hover Effect</label><select id="bulk-hover"><option value="">Keep</option><option value="none">None</option><option value="scale">Scale</option><option value="glow">Glow</option><option value="lift">Lift</option></select></div>
<button class="btn" onclick="applyBulkEdit()">Apply to All</button>
<button class="btn btn-danger" onclick="deleteMultiple()">ğŸ—‘ï¸ Delete All</button></div>`;}

function applyBulkEdit(){
const bg=document.getElementById('bulk-bg').value,tc=document.getElementById('bulk-tc').value,ec=document.getElementById('bulk-ec').value,hover=document.getElementById('bulk-hover').value;
selectedCards.forEach(c=>{c.bgColor=bg;c.titleColor=tc;c.entityColor=ec;if(hover)c.hoverEffect=hover});saveState();renderCanvas();showNotification('Applied to '+selectedCards.length+' cards')}

function copyEntity(){if(contextEntity){navigator.clipboard.writeText(contextEntity);showNotification('Copied');document.getElementById('contextMenu').classList.remove('active')}}
function deleteEntity(){if(contextCard&&contextEntityIndex>=0){contextCard.entities.splice(contextEntityIndex,1);saveState();renderCanvas();document.getElementById('contextMenu').classList.remove('active')}}
function deleteCard(){if(!selectedCard)return;cards=cards.filter(c=>c.id!==selectedCard.id);selectedCard=null;saveState();renderCanvas();showProperties(null);updateCardCount()}
function deleteMultiple(){cards=cards.filter(c=>!selectedCards.some(s=>s.id===c.id));selectedCards=[];selectedCard=null;saveState();renderCanvas();updateCardCount()}
function duplicateCard(){if(!selectedCard)return;const n={...JSON.parse(JSON.stringify(selectedCard)),id:cardIdCounter++,x:selectedCard.x+30,y:selectedCard.y+30,locked:false};cards.push(n);saveState();renderCanvas();selectCard(n)}
function pasteCard(){if(!clipboard)return;const n={...JSON.parse(JSON.stringify(clipboard)),id:cardIdCounter++,x:clipboard.x+30,y:clipboard.y+30,locked:false};cards.push(n);saveState();renderCanvas();selectCard(n)}
function selectAll(){selectedCards=cards.slice();renderCanvas();updateSelectedCount()}
function deselectAll(){selectedCards=[];selectedCard=null;renderCanvas();updateSelectedCount();showProperties(null)}

// Lock
function toggleLockSelected(){if(selectedCard){selectedCard.locked=!selectedCard.locked;saveState();renderCanvas();showNotification(selectedCard.locked?'Locked':'Unlocked')}else if(selectedCards.length){const lock=!selectedCards[0].locked;selectedCards.forEach(c=>c.locked=lock);saveState();renderCanvas();showNotification(lock?'Locked':'Unlocked')}}

// Copy/Paste Style
function copyStyle(){if(!selectedCard)return;styleClipboard={bgColor:selectedCard.bgColor,titleColor:selectedCard.titleColor,entityColor:selectedCard.entityColor,useGradient:selectedCard.useGradient,gradientColor1:selectedCard.gradientColor1,gradientColor2:selectedCard.gradientColor2,titleFont:selectedCard.titleFont,entityFont:selectedCard.entityFont,titleShadow:{...selectedCard.titleShadow},entityShadow:{...selectedCard.entityShadow},hoverEffect:selectedCard.hoverEffect,borderRadius:selectedCard.borderRadius,cornerStyle:selectedCard.cornerStyle};showNotification('Style copied')}
function pasteStyle(){if(!styleClipboard)return;const targets=selectedCards.length?selectedCards:(selectedCard?[selectedCard]:[]);targets.forEach(c=>Object.assign(c,JSON.parse(JSON.stringify(styleClipboard))));saveState();renderCanvas();showNotification('Style applied')}

// Auto Grid
function autoGridLayout(){if(!cards.length)return;const cols=Math.ceil(Math.sqrt(cards.length)),gap=20;let maxW=0,maxH=0;cards.forEach(c=>{maxW=Math.max(maxW,c.width);maxH=Math.max(maxH,c.height)});cards.forEach((c,i)=>{c.x=50+(i%cols)*(maxW+gap);c.y=50+Math.floor(i/cols)*(maxH+gap)});saveState();renderCanvas();showNotification('Auto-grid applied')}

function groupSelected(){if(selectedCards.length<2)return;const gid=Date.now();selectedCards.forEach(c=>c.group=gid);saveState();renderCanvas();showNotification('Grouped')}
function ungroupSelected(){selectedCards.forEach(c=>c.group=null);saveState();renderCanvas()}
function moveCardWithKeys(k){if(!selectedCard||selectedCard.locked)return;const s=snapToGrid?gridSize:5;if(k==='ArrowUp')selectedCard.y=Math.max(0,selectedCard.y-s);else if(k==='ArrowDown')selectedCard.y+=s;else if(k==='ArrowLeft')selectedCard.x=Math.max(0,selectedCard.x-s);else if(k==='ArrowRight')selectedCard.x+=s;renderCanvas()}
function toggleGridSnap(){snapToGrid=!snapToGrid;document.getElementById('gridSnapBtn').classList.toggle('active',snapToGrid);showNotification(`Grid ${snapToGrid?'ON':'OFF'}`)}
function setPreviewMode(m){previewMode=m;canvas.className='canvas';if(m==='mobile')canvas.classList.add('mobile-preview');else if(m==='tablet')canvas.classList.add('tablet-preview');document.querySelectorAll('[id^="preview"]').forEach(b=>b.classList.remove('active'));document.getElementById('preview'+m.charAt(0).toUpperCase()+m.slice(1)).classList.add('active');
// Save/restore responsive layouts
responsiveLayouts[previewMode]=cards.map(c=>({id:c.id,x:c.x,y:c.y,width:c.width,height:c.height}))}
function alignCards(dir){const arr=selectedCards.length?selectedCards:cards;if(!arr.length)return;if(dir==='left'){const min=Math.min(...arr.map(c=>c.x));arr.forEach(c=>{if(!c.locked)c.x=min})}else if(dir==='right'){const max=Math.max(...arr.map(c=>c.x+c.width));arr.forEach(c=>{if(!c.locked)c.x=max-c.width})}else{const min=Math.min(...arr.map(c=>c.x)),max=Math.max(...arr.map(c=>c.x+c.width)),ctr=(min+max)/2;arr.forEach(c=>{if(!c.locked)c.x=ctr-c.width/2})}saveState();renderCanvas()}
function changeZIndex(dir){if(!selectedCard)return;selectedCard.zIndex=dir==='up'?(selectedCard.zIndex||0)+1:Math.max(0,(selectedCard.zIndex||0)-1);saveState();renderCanvas()}

// Export PNG
function exportAsPNG(){showNotification('Generating PNG...');
const cvs=document.createElement('canvas'),ctx=cvs.getContext('2d');
const rect=canvas.getBoundingClientRect();cvs.width=rect.width*2;cvs.height=rect.height*2;ctx.scale(2,2);
ctx.fillStyle=bgSettings.type==='gradient'?bgSettings.grad1:bgSettings.solid;ctx.fillRect(0,0,rect.width,rect.height);
cards.forEach(c=>{ctx.fillStyle=c.useGradient?c.gradientColor1:c.bgColor;ctx.beginPath();ctx.roundRect(c.x,c.y,c.width,c.height,c.borderRadius||14);ctx.fill();ctx.fillStyle=c.titleColor;ctx.font=`bold ${16}px ${c.titleFont||'Segoe UI'}`;ctx.fillText(c.title,c.x+18,c.y+50)});
cvs.toBlob(b=>{const u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='dashboard-'+Date.now()+'.png';a.click();URL.revokeObjectURL(u);showNotification('PNG downloaded','success')},'image/png')}

// Share
function showShareModal(){const data={cards,bg:bgSettings,v:'4.3'};const json=JSON.stringify(data);const encoded=btoa(encodeURIComponent(json));const url=window.location.href.split('?')[0]+'?d='+encoded;document.getElementById('shareUrl').textContent=url.length>500?'Dashboard too large for URL. Use Cloud Save instead.':url;document.getElementById('shareModal').classList.add('active')}
function copyShareLink(){navigator.clipboard.writeText(document.getElementById('shareUrl').textContent).then(()=>showNotification('Link copied'))}

// Icon Picker
function openIconPicker(){populateIconGrid();document.getElementById('iconPickerModal').classList.add('active')}
function populateIconGrid(filter=''){const g=document.getElementById('iconGrid');const icons=filter?mdiIcons.filter(i=>i.includes(filter)):mdiIcons;g.innerHTML=icons.map(i=>`<div class="icon-item" onclick="selectIcon('${i}')" title="${i}">${iconEmojis[i]||'ğŸ“¦'}</div>`).join('')}
function filterIcons(){populateIconGrid(document.getElementById('iconSearch').value.toLowerCase())}
function selectIcon(icon){if(selectedCard){selectedCard.icon=icon;document.getElementById('prop-icon').value=icon;saveState();renderCanvas()}closeModal('iconPickerModal')}

// Style Presets
function showStylePresets(){loadPresets();document.getElementById('stylePresetsModal').classList.add('active')}
function loadPresets(){stylePresets=JSON.parse(localStorage.getItem('ha_style_presets')||'[]');const g=document.getElementById('presetGrid');g.innerHTML=stylePresets.map((p,i)=>`<div class="preset-item" onclick="applyPreset(${i})"><div class="preset-name">${p.name}</div><div class="preset-preview"><div class="preset-color" style="background:${p.bgColor}"></div><div class="preset-color" style="background:${p.titleColor}"></div><div class="preset-color" style="background:${p.entityColor}"></div></div></div>`).join('')||'<p style="color:#666">No presets saved</p>'}
function saveStylePreset(){if(!selectedCard){showNotification('Select a card first','error');return}const name=document.getElementById('presetName').value||'Preset '+(stylePresets.length+1);stylePresets.push({name,bgColor:selectedCard.bgColor,titleColor:selectedCard.titleColor,entityColor:selectedCard.entityColor,titleFont:selectedCard.titleFont,entityFont:selectedCard.entityFont,hoverEffect:selectedCard.hoverEffect,borderRadius:selectedCard.borderRadius});localStorage.setItem('ha_style_presets',JSON.stringify(stylePresets));loadPresets();showNotification('Preset saved')}
function applyPreset(i){const p=stylePresets[i];const targets=selectedCards.length?selectedCards:(selectedCard?[selectedCard]:cards);targets.forEach(c=>{c.bgColor=p.bgColor;c.titleColor=p.titleColor;c.entityColor=p.entityColor;c.titleFont=p.titleFont;c.entityFont=p.entityFont;c.hoverEffect=p.hoverEffect;c.borderRadius=p.borderRadius});saveState();renderCanvas();closeModal('stylePresetsModal');showNotification('Preset applied')}

// Lovelace mode
function setLovelaceMode(m){lovelaceMode=m;document.getElementById('lovelaceStandard').classList.toggle('active',m==='standard');document.getElementById('lovelaceCustom').classList.toggle('active',m==='custom')}
function setExportMode(m){exportMode=m;document.getElementById('exportStandard').classList.toggle('active',m==='standard');document.getElementById('exportCustom').classList.toggle('active',m==='custom');document.getElementById('yamlOutput').textContent=generateYAML()}

function saveProject(){const d={cards,bg:bgSettings,v:'4.3'};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='dashboard-v4.3-'+Date.now()+'.json';a.click();URL.revokeObjectURL(u);showNotification('Saved')}
function downloadYAMLDirect(){const y=generateYAML();const b=new Blob([y],{type:'text/yaml'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='dashboard.yaml';a.click();URL.revokeObjectURL(u);showNotification('YAML downloaded')}
function generateYAML(){const prefix=exportMode==='custom'?'custom:':'';let y=`# HA Dashboard v4.3\nviews:\n  - title: Dashboard\n    cards:\n`;cards.forEach(c=>{y+=`      - type: ${prefix}${c.type}\n        title: "${c.title}"\n`;if(c.icon)y+=`        icon: ${c.icon}\n`;if(c.entities){y+='        entities:\n';c.entities.forEach(e=>y+=`          - ${e}\n`)}else if(c.entity)y+=`        entity: ${c.entity}\n`;if(c.tapAction&&c.tapAction.action!=='toggle'){y+=`        tap_action:\n          action: ${c.tapAction.action}\n`;if(c.tapAction.service)y+=`          ${c.tapAction.action==='call-service'?'service':'navigation_path'}: ${c.tapAction.service}\n`}if(c.conditions)y+=`        # Condition: ${c.conditions}\n`;y+='\n'});return y}
function copyYAML(){navigator.clipboard.writeText(document.getElementById('yamlOutput').textContent).then(()=>showNotification('Copied'))}
function downloadYAML(){const b=new Blob([document.getElementById('yamlOutput').textContent],{type:'text/yaml'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='dashboard.yaml';a.click()}
function showYAML(){document.getElementById('yamlOutput').textContent=generateYAML();document.getElementById('yamlModal').classList.add('active')}

function closeModal(id){document.getElementById(id).classList.remove('active')}
function showNotification(msg,type='success'){const n=document.getElementById('notification');n.textContent=msg;n.className=`notification ${type}`;n.style.display='block';setTimeout(()=>n.style.display='none',3000)}
function updateStatus(t){document.getElementById('statusText').textContent=t;setTimeout(()=>document.getElementById('statusText').textContent='Ready',2000)}
function updateCardCount(){document.getElementById('cardCount').textContent=cards.length+' cards'}
function updateSelectedCount(){document.getElementById('selectedCount').textContent=selectedCards.length?selectedCards.length+' selected':'0 selected'}
function showSidebarTab(t){document.querySelectorAll('.sidebar-tab').forEach(x=>x.classList.remove('active'));document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');document.getElementById('cardsTab').style.display=t==='cards'?'block':'none';document.getElementById('searchTab').style.display=t==='search'?'block':'none';document.getElementById('layersTab').style.display=t==='layers'?'block':'none'}
function searchCards(){const q=document.getElementById('searchBox').value.toLowerCase(),r=cards.filter(c=>c.title.toLowerCase().includes(q)||c.entities?.some(e=>e.includes(q))||c.entity?.includes(q));document.getElementById('searchResults').innerHTML=r.map(c=>`<div style="padding:10px;background:rgba(67,238,255,.1);border-radius:8px;margin:5px 0;cursor:pointer" onclick="selectCard(cards.find(x=>x.id===${c.id}))">${c.title}</div>`).join('')||'<p style="color:#666">No results</p>'}
function updateLayersList(){document.getElementById('layersList').innerHTML=cards.slice().sort((a,b)=>(b.zIndex||0)-(a.zIndex||0)).map(c=>`<div style="padding:8px;background:rgba(67,238,255,.1);border-radius:6px;margin:5px 0;cursor:pointer;font-size:.85em" onclick="selectCard(cards.find(x=>x.id===${c.id}))">${c.locked?'ğŸ”’ ':''}${c.title} - Z:${c.zIndex||0}</div>`).join('')}
function showDashboardManager(){document.getElementById('dashboardList').innerHTML=dashboards.map(d=>`<div class="dashboard-item ${d.id===currentDashboardId?'active':''}" onclick="switchDashboard(${d.id})"><div class="dashboard-name">${d.name}</div><div class="dashboard-meta">${d.cards?.length||0} cards</div></div>`).join('');document.getElementById('dashboardManagerModal').classList.add('active')}
function createNewDashboard(){const name=prompt('Name:','Dashboard');if(!name)return;const nd={id:Date.now(),name,cards:[],bg:{...bgSettings},created:Date.now()};dashboards.push(nd);switchDashboard(nd.id)}
function switchDashboard(id){const d=dashboards.find(x=>x.id===id);if(!d)return;currentDashboardId=id;cards=d.cards||[];bgSettings=d.bg||bgSettings;document.getElementById('currentDashboard').textContent=d.name;applyBackground();renderCanvas();updateCardCount();closeModal('dashboardManagerModal')}
function showThemeMarketplace(){document.getElementById('themeModal').classList.add('active')}
function applyTheme(n){const t=themes[n];if(!t)return;bgSettings={type:'gradient',grad1:t.bg1,grad2:t.bg2,angle:135,imageUrl:'',solid:t.bg1,opacity:30,blur:0,overlay:50};cards.forEach(c=>{c.bgColor=t.card;c.titleColor=t.title;c.entityColor=t.entity});applyBackground();saveState();renderCanvas();closeModal('themeModal')}
function showBackgroundSettings(){setBgTypeUI(bgSettings.type);document.getElementById('bgGrad1').value=bgSettings.grad1;document.getElementById('bgGrad2').value=bgSettings.grad2;document.getElementById('bgAngle').value=bgSettings.angle;document.getElementById('bgAngleVal').textContent=bgSettings.angle;document.getElementById('bgSolidColor').value=bgSettings.solid;document.getElementById('bgImageUrl').value=bgSettings.imageUrl||'';document.getElementById('bgOpacity').value=bgSettings.opacity;document.getElementById('bgOpacityVal').textContent=bgSettings.opacity;document.getElementById('bgBlur').value=bgSettings.blur;document.getElementById('bgBlurVal').textContent=bgSettings.blur;document.getElementById('bgOverlayAmount').value=bgSettings.overlay;document.getElementById('bgOverlayVal').textContent=bgSettings.overlay;document.getElementById('backgroundModal').classList.add('active')}
function setBgType(t){bgSettings.type=t;setBgTypeUI(t);updateBgSettings()}
function setBgTypeUI(t){document.querySelectorAll('.bg-type-btn').forEach(b=>b.classList.remove('active'));document.getElementById('bgType'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');document.getElementById('bgGradientSettings').style.display=t==='gradient'?'block':'none';document.getElementById('bgSolidSettings').style.display=t==='solid'?'block':'none';document.getElementById('bgImageSettings').style.display=t==='image'?'block':'none'}
function updateBgSettings(){bgSettings.grad1=document.getElementById('bgGrad1').value;bgSettings.grad2=document.getElementById('bgGrad2').value;bgSettings.angle=+document.getElementById('bgAngle').value;document.getElementById('bgAngleVal').textContent=bgSettings.angle;bgSettings.solid=document.getElementById('bgSolidColor').value;bgSettings.imageUrl=document.getElementById('bgImageUrl').value;bgSettings.opacity=+document.getElementById('bgOpacity').value;document.getElementById('bgOpacityVal').textContent=bgSettings.opacity;bgSettings.blur=+document.getElementById('bgBlur').value;document.getElementById('bgBlurVal').textContent=bgSettings.blur;bgSettings.overlay=+document.getElementById('bgOverlayAmount').value;document.getElementById('bgOverlayVal').textContent=bgSettings.overlay;applyBackground();saveState()}
function uploadBgImage(e){const f=e.target.files[0];if(f){const r=new FileReader();r.onload=x=>{bgSettings.imageUrl=x.target.result;bgSettings.type='image';setBgTypeUI('image');applyBackground();saveState()};r.readAsDataURL(f)}}
function applyBackground(){const l=document.querySelector('.bg-layer'),i=document.getElementById('bgImage'),o=document.getElementById('bgOverlay');if(bgSettings.type==='gradient'){l.style.background=`linear-gradient(${bgSettings.angle}deg,${bgSettings.grad1},${bgSettings.grad2})`;i.style.opacity=0}else if(bgSettings.type==='image'&&bgSettings.imageUrl){l.style.background='#000';i.style.backgroundImage=`url(${bgSettings.imageUrl})`;i.style.opacity=bgSettings.opacity/100;i.style.filter=`blur(${bgSettings.blur}px)`}else{l.style.background=bgSettings.solid;i.style.opacity=0}o.style.background=`rgba(0,0,0,${bgSettings.overlay/100})`}

function showGallery(){document.getElementById('galleryModal').classList.add('active')}
function cloneGalleryDashboard(t){const tpls={'smart-home':[{type:'entities',title:'Living',x:50,y:50,entities:['light.living','switch.tv']},{type:'weather',title:'Weather',x:400,y:50,entity:'weather.home'}],'minimalist':[{type:'glance',title:'Glance',x:50,y:50,entities:['light.main','switch.fan']},{type:'clock',title:'Time',x:400,y:50,format:'24'}],'energy':[{type:'gauge',title:'Power',x:50,y:50,entity:'sensor.power',min:0,max:5000}],'security':[{type:'camera',title:'Cam',x:50,y:50,entity:'camera.front'}]};const tpl=tpls[t];if(tpl){cards.push(...tpl.map(c=>({...c,id:cardIdCounter++,width:cardTypeConfigs[c.type].defaultSize.width,height:cardTypeConfigs[c.type].defaultSize.height,bgColor:'#43eeff',titleColor:'#ff43ee',entityColor:'#ffeb3b',zIndex:cards.length,locked:false,hoverEffect:'none',icon:'',titleFont:"'Segoe UI', sans-serif",entityFont:"'Segoe UI', sans-serif",titleShadow:{enabled:false,x:2,y:2,blur:4,color:'#000'},entityShadow:{enabled:false,x:1,y:1,blur:2,color:'#000'},borderRadius:14,cornerStyle:'rounded',tapAction:{action:'toggle'},conditions:''})));saveState();renderCanvas();closeModal('galleryModal')}}
function showTemplateLibrary(){document.getElementById('templateModal').classList.add('active')}
function applyTemplate(n){const tpls={living:[{type:'entities',title:'Living',x:50,y:50,entities:['light.living_room','switch.tv']}],kitchen:[{type:'entities',title:'Kitchen',x:50,y:50,entities:['light.kitchen']}],bedroom:[{type:'entities',title:'Bedroom',x:50,y:50,entities:['light.bedroom']}],security:[{type:'camera',title:'Cam',x:50,y:50,entity:'camera.front'}],energy:[{type:'gauge',title:'Power',x:50,y:50,entity:'sensor.power'}],outdoor:[{type:'weather',title:'Weather',x:50,y:50,entity:'weather.home'}]};const tpl=tpls[n];if(tpl){cards.push(...tpl.map(c=>({...c,id:cardIdCounter++,width:cardTypeConfigs[c.type].defaultSize.width,height:cardTypeConfigs[c.type].defaultSize.height,bgColor:'#43eeff',titleColor:'#ff43ee',entityColor:'#ffeb3b',zIndex:cards.length,locked:false,hoverEffect:'none',icon:'',titleFont:"'Segoe UI', sans-serif",entityFont:"'Segoe UI', sans-serif",titleShadow:{enabled:false,x:2,y:2,blur:4,color:'#000'},entityShadow:{enabled:false,x:1,y:1,blur:2,color:'#000'},borderRadius:14,cornerStyle:'rounded',tapAction:{action:'toggle'},conditions:''})));saveState();renderCanvas();closeModal('templateModal')}}
function showImportModal(){document.getElementById('importModal').classList.add('active')}
function importYAML(){const yaml=document.getElementById('importYaml').value,preserveC=document.getElementById('importPreserveColors').checked,preserveF=document.getElementById('importPreserveFonts').checked;
if(!yaml.trim()){showNotification('Paste YAML first','error');return}
try{
const lines=yaml.split('\n');
let cardsList=[];
let currentCard=null;
let inEntities=false;
let lastIndent=0;

for(let i=0;i<lines.length;i++){
const line=lines[i];
const trimmed=line.trim();
const indent=line.search(/\S/);
if(indent===-1)continue;

// Detect new card by "- type:" pattern
if(trimmed.match(/^-\s*type:\s*/)){
// Save previous card if it has content
if(currentCard&&(currentCard.entities?.length>0||currentCard.entity)){
cardsList.push(currentCard);
}
// Get card type
let type=trimmed.replace(/^-\s*type:\s*/,'').replace(/['"]/g,'').trim();
// Handle custom cards and type variations
type=type.replace('custom:','').replace('mushroom-','').replace('-card','');
if(type==='weather-forecast')type='weather';
if(type==='history-graph')type='chart';
if(type==='media-player')type='media';
// Skip headings
if(type==='heading'||type==='vertical-stack'||type==='horizontal-stack'||type==='grid'){
currentCard=null;
continue;
}
// Handle tile cards as button type
let cardType=type;
if(type==='tile')cardType='button';
// Map to supported types or default to entities
const supportedTypes=['entities','thermostat','weather','camera','media','gauge','button','clock','markdown','picture','glance','chart','map','iframe','light'];
if(!supportedTypes.includes(cardType)){
if(type.includes('light'))cardType='light';
else if(type.includes('media'))cardType='media';
else cardType='entities';
}
const size=cardTypeConfigs[cardType]?.defaultSize||{width:300,height:200};
currentCard={
id:cardIdCounter++,
type:cardType,
title:cardType.charAt(0).toUpperCase()+cardType.slice(1),
x:50+(cardsList.length%4)*320,
y:50+Math.floor(cardsList.length/4)*240,
width:size.width,
height:size.height,
entities:[],
entity:'',
bgColor:preserveC?lastCardSettings.bgColor:'#43eeff',
titleColor:preserveC?lastCardSettings.titleColor:'#ff43ee',
entityColor:preserveC?lastCardSettings.entityColor:'#ffeb3b',
titleFont:preserveF?lastCardSettings.titleFont:"'Segoe UI', sans-serif",
entityFont:preserveF?lastCardSettings.entityFont:"'Segoe UI', sans-serif",
titleShadow:{enabled:false,x:2,y:2,blur:4,color:'#000'},
entityShadow:{enabled:false,x:1,y:1,blur:2,color:'#000'},
zIndex:cardsList.length,
locked:false,
hoverEffect:'none',
borderRadius:14,
cornerStyle:'rounded',
tapAction:{action:'toggle'},
conditions:''
};
inEntities=false;
continue;
}

if(!currentCard)continue;

// Get title or name for the card
if(trimmed.match(/^(title|name):\s*/)&&!trimmed.startsWith('-')){
const val=trimmed.replace(/^(title|name):\s*/,'').replace(/['"]/g,'').trim();
if(val){
currentCard.title=val;
}
continue;
}

// Detect entities list start
if(trimmed==='entities:'){
inEntities=true;
continue;
}

// Parse single entity for tile/thermostat/weather/etc (not in entities list)
if(trimmed.match(/^entity:\s*/)&&!inEntities){
const ent=trimmed.replace(/^entity:\s*/,'').replace(/['"]/g,'').trim();
if(ent&&ent.includes('.')){
currentCard.entity=ent;
// For thermostat/button, also add to entities array
if(currentCard.type==='thermostat'||currentCard.type==='button'){
currentCard.entities=[ent];
}
// Use entity name as title if title is generic
const parts=ent.split('.');
if(currentCard.title===currentCard.type.charAt(0).toUpperCase()+currentCard.type.slice(1)){
currentCard.title=parts[1]?.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase())||currentCard.title;
}
}
continue;
}

// Parse entity in entities list: "- entity: light.xxx" format
if(inEntities&&trimmed.match(/^-\s*entity:\s*/)){
const ent=trimmed.replace(/^-\s*entity:\s*/,'').replace(/['"]/g,'').trim();
if(ent&&ent.includes('.')){
currentCard.entities.push(ent);
}
continue;
}

// Parse simple entity format: "- light.xxx" or "- sensor.xxx"
if(inEntities&&trimmed.match(/^-\s*[a-z_]+\.[a-z0-9_]+/i)){
const ent=trimmed.replace(/^-\s*/,'').replace(/['"]/g,'').trim();
if(ent&&ent.includes('.')&&!ent.includes(':')){
currentCard.entities.push(ent);
}
continue;
}

// Check if we've exited entities section
if(inEntities&&!trimmed.startsWith('-')&&trimmed.includes(':')&&!trimmed.startsWith('name')){
const propName=trimmed.split(':')[0].trim();
if(['state_color','show_header_toggle','card_mod','theme','secondary_info','style'].includes(propName)){
// Still card properties, not a new card section
}else if(indent<lastIndent){
inEntities=false;
}
}

lastIndent=indent;
}

// Don't forget the last card
if(currentCard&&(currentCard.entities?.length>0||currentCard.entity)){
cardsList.push(currentCard);
}

if(cardsList.length===0){
showNotification('No valid cards found in YAML','error');
return;
}

cards.push(...cardsList);
saveState();
renderCanvas();
updateCardCount();
closeModal('importModal');
showNotification(`Imported ${cardsList.length} cards with entities!`,'success');
}catch(e){
console.error('Import error:',e);
showNotification('Error: '+e.message,'error');
}}

function showVersionHistory(){document.getElementById('versionList').innerHTML=versionHistory.slice().reverse().map((v,i)=>`<div class="version-item" onclick="restoreVersion(${versionHistory.length-1-i})"><div class="version-time">${new Date(v.time).toLocaleString()}</div><div class="version-cards">${v.cardCount} cards</div></div>`).join('')||'<p style="color:#666">No history</p>';document.getElementById('versionHistoryModal').classList.add('active')}
function restoreVersion(i){const v=versionHistory[i];cards=JSON.parse(JSON.stringify(v.cards));saveState();renderCanvas();closeModal('versionHistoryModal')}
function showShortcuts(){document.getElementById('shortcutsModal').classList.add('active')}
function showCloudSave(){cloudDashboards=JSON.parse(localStorage.getItem('ha_cloud_dashboards')||'[]');document.getElementById('cloudDashboardList').innerHTML=cloudDashboards.map((d,i)=>`<div class="dashboard-item" onclick="loadFromCloud(${i})"><div class="dashboard-name">${d.name}</div><div class="dashboard-meta">${d.cards.length} cards</div></div>`).join('')||'<p style="color:#666">None saved</p>';document.getElementById('cloudSaveModal').classList.add('active')}
function saveToCloud(){const name=document.getElementById('cloudDashboardName').value||'Untitled';cloudDashboards.push({name,cards:JSON.parse(JSON.stringify(cards)),bg:JSON.parse(JSON.stringify(bgSettings)),saved:Date.now()});localStorage.setItem('ha_cloud_dashboards',JSON.stringify(cloudDashboards));showCloudSave();showNotification('Saved')}
function loadFromCloud(i){const d=cloudDashboards[i];cards=JSON.parse(JSON.stringify(d.cards));bgSettings=JSON.parse(JSON.stringify(d.bg));cardIdCounter=Math.max(...cards.map(c=>c.id),0)+1;applyBackground();saveState();renderCanvas();closeModal('cloudSaveModal')}

// HA Theme Presets
const haThemes={
'ios-dark':{bg1:'#1c1c1e',bg2:'#2c2c2e',card:'#3a3a3c',title:'#ffffff',entity:'#ebebf5',accent:'#0a84ff'},
'ios-light':{bg1:'#f2f2f7',bg2:'#ffffff',card:'#ffffff',title:'#000000',entity:'#3c3c43',accent:'#007aff'},
'mushroom':{bg1:'#1d1b26',bg2:'#2d2b36',card:'#3d3b46',title:'#ffffff',entity:'#b3b3b3',accent:'#ff9800'},
'google-home':{bg1:'#202124',bg2:'#303134',card:'#3c4043',title:'#e8eaed',entity:'#9aa0a6',accent:'#8ab4f8'},
'slate':{bg1:'#1e293b',bg2:'#334155',card:'#475569',title:'#f1f5f9',entity:'#cbd5e1',accent:'#38bdf8'},
'noctis':{bg1:'#0f1318',bg2:'#1b2838',card:'#232f3e',title:'#d5ced9',entity:'#7f848e',accent:'#49e9a6'},
'caule-black':{bg1:'#000000',bg2:'#0a0a0a',card:'#1a1a1a',title:'#ffffff',entity:'#cccccc',accent:'#03a9f4'},
'midnight':{bg1:'#0d1117',bg2:'#161b22',card:'#21262d',title:'#c9d1d9',entity:'#8b949e',accent:'#58a6ff'},
'material-dark':{bg1:'#121212',bg2:'#1e1e1e',card:'#2d2d2d',title:'#ffffff',entity:'#b3b3b3',accent:'#bb86fc'},
'nord':{bg1:'#2e3440',bg2:'#3b4252',card:'#434c5e',title:'#eceff4',entity:'#d8dee9',accent:'#88c0d0'},
'solarized-dark':{bg1:'#002b36',bg2:'#073642',card:'#094959',title:'#fdf6e3',entity:'#93a1a1',accent:'#268bd2'},
'dracula':{bg1:'#282a36',bg2:'#44475a',card:'#6272a4',title:'#f8f8f2',entity:'#bfbfbf',accent:'#bd93f9'}
};
let customThemes=JSON.parse(localStorage.getItem('ha_custom_themes')||'[]');

function showThemeImport(){document.getElementById('themeImportModal').classList.add('active');loadCustomThemes()}
function showThemeTab(tab){
document.querySelectorAll('#themeImportModal .sidebar-tab').forEach(t=>t.classList.remove('active'));
document.getElementById('themeTab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
document.getElementById('themePresetsTab').style.display=tab==='presets'?'block':'none';
document.getElementById('themeImportTab').style.display=tab==='import'?'block':'none';
document.getElementById('themeCustomTab').style.display=tab==='custom'?'block':'none';
if(tab==='custom')loadCustomThemes()}

function applyHATheme(name){
const t=haThemes[name];
if(!t)return;
if(document.getElementById('themeApplyBg')?.checked!==false){
bgSettings={type:'gradient',grad1:t.bg1,grad2:t.bg2,angle:135,imageUrl:'',solid:t.bg1,opacity:30,blur:0,overlay:30};
applyBackground()}
if(document.getElementById('themeApplyCards')?.checked!==false){
cards.forEach(c=>{c.bgColor=t.card;c.titleColor=t.title;c.entityColor=t.entity})}
if(document.getElementById('themeApplyNew')?.checked!==false){
lastCardSettings.bgColor=t.card;lastCardSettings.titleColor=t.title;lastCardSettings.entityColor=t.entity}
saveState();renderCanvas();closeModal('themeImportModal');showNotification(`Applied ${name} theme`,'success')}

function parseAndApplyThemeYAML(){
const yaml=document.getElementById('themeYamlInput').value;
if(!yaml.trim()){showNotification('Paste theme YAML first','error');return}
try{
const colors={bg1:'#121212',bg2:'#1e1e1e',card:'#2d2d2d',title:'#ffffff',entity:'#b3b3b3'};
const lines=yaml.split('\n');
lines.forEach(line=>{
const l=line.trim().toLowerCase();
// Parse various HA theme color variables
if(l.includes('primary-background-color')||l.includes('lovelace-background')){
const c=extractColor(line);if(c){colors.bg1=c;colors.bg2=c}}
if(l.includes('secondary-background-color')){const c=extractColor(line);if(c)colors.bg2=c}
if(l.includes('card-background-color')||l.includes('ha-card-background')){const c=extractColor(line);if(c)colors.card=c}
if(l.includes('primary-text-color')){const c=extractColor(line);if(c)colors.title=c}
if(l.includes('secondary-text-color')){const c=extractColor(line);if(c)colors.entity=c}
if(l.includes('primary-color')||l.includes('accent-color')){const c=extractColor(line);if(c&&colors.title==='#ffffff')colors.title=c}
});
// Apply the parsed colors
if(document.getElementById('themeApplyBg').checked){
bgSettings={type:'gradient',grad1:colors.bg1,grad2:colors.bg2,angle:135,imageUrl:'',solid:colors.bg1,opacity:30,blur:0,overlay:30};
applyBackground()}
if(document.getElementById('themeApplyCards').checked){
cards.forEach(c=>{c.bgColor=colors.card;c.titleColor=colors.title;c.entityColor=colors.entity})}
if(document.getElementById('themeApplyNew').checked){
lastCardSettings.bgColor=colors.card;lastCardSettings.titleColor=colors.title;lastCardSettings.entityColor=colors.entity}
saveState();renderCanvas();closeModal('themeImportModal');showNotification('Theme applied!','success');
}catch(e){showNotification('Error parsing theme: '+e.message,'error')}}

function extractColor(line){
const match=line.match(/['"](#[0-9a-fA-F]{3,8}|rgb[a]?\([^)]+\))['"]/)||line.match(/:\s*(#[0-9a-fA-F]{3,8})/);
return match?match[1]:null}

function saveCustomTheme(){
const name=document.getElementById('customThemeName').value||'Custom Theme '+(customThemes.length+1);
const theme={name,bg1:bgSettings.grad1||bgSettings.solid,bg2:bgSettings.grad2||bgSettings.solid,card:lastCardSettings.bgColor,title:lastCardSettings.titleColor,entity:lastCardSettings.entityColor,created:Date.now()};
customThemes.push(theme);
localStorage.setItem('ha_custom_themes',JSON.stringify(customThemes));
loadCustomThemes();
document.getElementById('customThemeName').value='';
showNotification('Theme saved!','success')}

function loadCustomThemes(){
customThemes=JSON.parse(localStorage.getItem('ha_custom_themes')||'[]');
const list=document.getElementById('customThemeList');
if(!list)return;
list.innerHTML=customThemes.length?customThemes.map((t,i)=>`
<div class="preset-item" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div onclick="applyCustomTheme(${i})" style="cursor:pointer;flex:1">
<div class="preset-name">${t.name}</div>
<div class="preset-preview"><div class="preset-color" style="background:${t.bg1}"></div><div class="preset-color" style="background:${t.card}"></div><div class="preset-color" style="background:${t.title}"></div><div class="preset-color" style="background:${t.entity}"></div></div>
</div>
<button onclick="deleteCustomTheme(${i})" style="background:#f44;border:none;color:#fff;padding:5px 10px;border-radius:4px;cursor:pointer">ğŸ—‘ï¸</button>
</div>`).join(''):'<p style="color:#666">No saved themes yet</p>'}

function applyCustomTheme(i){
const t=customThemes[i];
if(!t)return;
bgSettings={type:'gradient',grad1:t.bg1,grad2:t.bg2,angle:135,imageUrl:'',solid:t.bg1,opacity:30,blur:0,overlay:30};
applyBackground();
cards.forEach(c=>{c.bgColor=t.card;c.titleColor=t.title;c.entityColor=t.entity});
lastCardSettings.bgColor=t.card;lastCardSettings.titleColor=t.title;lastCardSettings.entityColor=t.entity;
saveState();renderCanvas();closeModal('themeImportModal');showNotification(`Applied ${t.name}`,'success')}

function deleteCustomTheme(i){
if(!confirm('Delete this theme?'))return;
customThemes.splice(i,1);
localStorage.setItem('ha_custom_themes',JSON.stringify(customThemes));
loadCustomThemes();showNotification('Theme deleted')}

function exportThemeYAML(){
const themeName=prompt('Theme name for export:','my_dashboard_theme')||'my_dashboard_theme';
const yaml=`${themeName}:
  # Background colors
  primary-background-color: "${bgSettings.grad1||bgSettings.solid}"
  secondary-background-color: "${bgSettings.grad2||bgSettings.solid}"
  lovelace-background: "${bgSettings.grad1||bgSettings.solid}"
  
  # Card colors
  card-background-color: "${lastCardSettings.bgColor}"
  ha-card-background: "${lastCardSettings.bgColor}"
  
  # Text colors
  primary-text-color: "${lastCardSettings.titleColor}"
  secondary-text-color: "${lastCardSettings.entityColor}"
  
  # Accent (using title color)
  primary-color: "${lastCardSettings.titleColor}"
  accent-color: "${lastCardSettings.titleColor}"`;
const blob=new Blob([yaml],{type:'text/yaml'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');a.href=url;a.download=themeName+'.yaml';a.click();
URL.revokeObjectURL(url);showNotification('Theme exported!','success')}

// Check for shared dashboard in URL
(function(){const p=new URLSearchParams(window.location.search).get('d');if(p){try{const d=JSON.parse(decodeURIComponent(atob(p)));if(d.cards){cards=d.cards;bgSettings=d.bg||bgSettings;cardIdCounter=Math.max(...cards.map(c=>c.id),0)+1;applyBackground();renderCanvas();updateCardCount();showNotification('Dashboard loaded from link')}}catch(e){}}})();

if(autoSave)autoSaveInterval=setInterval(()=>saveState(),60000);
applyBackground();renderCanvas();updateCardCount();updateSelectedCount();
</script>
</body>
</html>
